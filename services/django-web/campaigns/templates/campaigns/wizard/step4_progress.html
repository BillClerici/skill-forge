{% extends "campaigns/wizard/base_wizard.html" %}

{% block wizard_content %}
<div class="card">
    <div class="card-header">
        <h4>Step 4: Generating Campaign</h4>
        <p class="mb-0">Please wait while we generate your campaign...</p>
    </div>
    <div class="card-body">
        <!-- Progress Display -->
        <div id="progress-container">
            <!-- Progress Bar -->
            <div class="mb-4">
                <div class="d-flex justify-content-between mb-2">
                    <span id="status-message">Initializing...</span>
                    <span><span id="progress-percentage">0</span>%</span>
                </div>
                <div class="progress" style="height: 25px;">
                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                         role="progressbar" style="width: 0%"></div>
                </div>
            </div>

            <!-- Current Phase -->
            <div class="alert alert-info" id="current-phase">
                <strong>Current Phase:</strong> <span id="phase-name">Initializing</span>
            </div>

            <!-- Progress Log -->
            <div class="card">
                <div class="card-header">
                    <h5>Progress Log</h5>
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                    <ul class="list-group list-group-flush" id="progress-log">
                        <!-- Populated via AJAX -->
                    </ul>
                </div>
            </div>

            <!-- Errors (if any) -->
            <div id="errors-container" style="display: none;">
                <div class="alert alert-danger mt-3">
                    <h5>Errors</h5>
                    <ul id="error-list"></ul>
                </div>
            </div>

            <!-- Completion Message -->
            <div id="completion-container" style="display: none;">
                <div class="alert alert-success mt-4">
                    <h4>✓ Campaign Generation Complete!</h4>
                    <p>Your campaign has been successfully generated.</p>
                    <a href="{% url 'campaign_wizard_complete' %}" class="btn btn-success">View Campaign →</a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const progressLog = [];

// Phase descriptions
const phaseDescriptions = {
    'init': 'Initializing workflow',
    'story_gen': 'Generating story ideas',
    'core_gen': 'Generating campaign core',
    'quest_gen': 'Generating quests',
    'place_gen': 'Generating places (Level 2 locations)',
    'scene_gen': 'Generating scenes (Level 3 locations)',
    'element_gen': 'Generating NPCs, discoveries, events, and challenges',
    'finalize': 'Finalizing and persisting campaign'
};

// Poll for progress
function pollProgress() {
    fetch('{% url "campaign_wizard_status" %}')
        .then(response => response.json())
        .then(data => {
            updateProgress(data);

            // Check if complete
            if (data.workflow_phase === 'completed') {
                if (data.errors && data.errors.length > 0) {
                    displayErrors(data.errors);
                } else {
                    displayCompletion(data);
                }
            } else if (data.workflow_phase === 'error' || data.workflow_phase === 'failed') {
                displayErrors(data.errors || ['Campaign generation failed']);
            } else {
                // Continue polling
                setTimeout(pollProgress, 2000);
            }
        })
        .catch(error => {
            console.error('Error polling progress:', error);
            setTimeout(pollProgress, 2000);
        });
}

function updateProgress(data) {
    // Update progress bar
    const percentage = data.progress || 0;
    document.getElementById('progress-percentage').textContent = percentage;
    document.getElementById('progress-bar').style.width = percentage + '%';

    // Update status message
    if (data.message) {
        document.getElementById('status-message').textContent = data.message;
    }

    // Update current phase
    const phaseName = phaseDescriptions[data.phase] || data.phase;
    document.getElementById('phase-name').textContent = phaseName;

    // Add to progress log (avoid duplicates)
    const logKey = `${data.phase}-${data.node}`;
    if (!progressLog.includes(logKey)) {
        progressLog.push(logKey);

        const logItem = document.createElement('li');
        logItem.className = 'list-group-item';
        logItem.innerHTML = `
            <div class="d-flex justify-content-between">
                <span><strong>${phaseName}</strong> - ${data.message || ''}</span>
                <span class="badge bg-primary rounded-pill">${percentage}%</span>
            </div>
        `;

        const logContainer = document.getElementById('progress-log');
        logContainer.appendChild(logItem);

        // Auto-scroll to bottom
        logContainer.parentElement.scrollTop = logContainer.parentElement.scrollHeight;
    }
}

function displayErrors(errors) {
    document.getElementById('errors-container').style.display = 'block';

    const errorList = document.getElementById('error-list');
    errorList.innerHTML = errors.map(error => `<li>${error}</li>`).join('');

    // Update progress bar to danger
    document.getElementById('progress-bar').classList.remove('progress-bar-animated');
    document.getElementById('progress-bar').classList.add('bg-danger');
}

function displayCompletion(data) {
    document.getElementById('completion-container').style.display = 'block';

    // Update progress bar to success
    document.getElementById('progress-bar').classList.remove('progress-bar-animated');
    document.getElementById('progress-bar').classList.add('bg-success');

    // Add completion log
    const logItem = document.createElement('li');
    logItem.className = 'list-group-item list-group-item-success';
    logItem.innerHTML = `
        <div>
            <strong>✓ Campaign Generation Complete</strong>
            <p class="mb-0">Campaign ID: ${data.campaign_id || 'N/A'}</p>
            ${data.stats ? `
                <p class="mb-0 mt-2">
                    <small>
                        Quests: ${data.stats.num_quests} |
                        Places: ${data.stats.num_places} |
                        Scenes: ${data.stats.num_scenes} |
                        NPCs: ${data.stats.num_npcs} |
                        New Species: ${data.stats.new_species_created} |
                        New Locations: ${data.stats.new_locations_created}
                    </small>
                </p>
            ` : ''}
        </div>
    `;

    const logContainer = document.getElementById('progress-log');
    logContainer.appendChild(logItem);
}

// Start polling
pollProgress();
</script>
{% endblock %}
