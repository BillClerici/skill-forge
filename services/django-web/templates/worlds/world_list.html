{% extends "base.html" %}

{% block title %}Worlds - SkillForge RPG{% endblock %}

{% block content %}
<div class="row">
    <div class="col s12">
        <h3 style="color: var(--rpg-gold); text-shadow: 0 0 10px rgba(212, 175, 55, 0.3);">
            <i class="material-icons left" style="font-size: 2.5rem;">map</i>
            Worlds
        </h3>
    </div>
</div>

<!-- In-Progress Workflow Banner -->
<div id="in-progress-banner" style="display: none; margin-bottom: 20px;">
    <div class="card" style="background: linear-gradient(135deg, rgba(106, 76, 147, 0.3), rgba(212, 175, 55, 0.2)); border: 2px solid var(--rpg-gold); border-radius: 8px;">
        <div class="card-content" style="padding: 20px;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center;">
                    <i class="material-icons" style="color: var(--rpg-gold); font-size: 2.5rem; margin-right: 15px; animation: pulse 2s infinite;">hourglass_empty</i>
                    <div>
                        <h5 style="color: var(--rpg-gold); margin: 0 0 5px 0;">World Generation In Progress</h5>
                        <p style="color: #b8b8d1; margin: 0;" id="in-progress-message">Creating your world...</p>
                    </div>
                </div>
                <a href="#!" id="view-progress-btn" class="btn waves-effect waves-light" style="background: var(--rpg-purple); border: 1px solid var(--rpg-gold);">
                    <i class="material-icons left">visibility</i>View Progress
                </a>
            </div>
        </div>
    </div>
</div>

<style>
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}
</style>

<div class="row">
    <div class="col s12 m6">
        <div class="input-field">
            <i class="material-icons prefix">search</i>
            <input id="world-search" type="text" placeholder="Search by name, genre, theme, or setting..." style="color: #e0e0e0;">
            <label for="world-search" class="active">Search Worlds</label>
        </div>
    </div>
    <div class="col s12 m3">
        <a href="#world-factory-modal" class="btn-large waves-effect waves-light modal-trigger" style="width: 100%; background: var(--rpg-purple); border: 1px solid var(--rpg-gold);">
            <i class="material-icons left">auto_awesome</i>AI World Factory
        </a>
    </div>
    <div class="col s12 m3">
        <a href="{% url 'world_create' %}" class="btn-large waves-effect waves-light" style="width: 100%;">
            <i class="material-icons left">add</i>Create Manually
        </a>
    </div>
</div>

<!-- Filter Row -->
<div class="row">
    <div class="col s12 m4">
        <div class="input-field">
            <select id="filter-genre">
                <option value="">All Genres</option>
                {% for world in worlds %}
                    {% if world.genre %}
                        <option value="{{ world.genre }}">{{ world.genre }}</option>
                    {% endif %}
                {% endfor %}
            </select>
            <label>Filter by Genre</label>
        </div>
    </div>
    <div class="col s12 m4">
        <div class="input-field">
            <select id="filter-has-image">
                <option value="">All Worlds</option>
                <option value="with-image">With Primary Image</option>
                <option value="without-image">Without Primary Image</option>
            </select>
            <label>Filter by Image</label>
        </div>
    </div>
    <div class="col s12 m4">
        <div class="input-field">
            <select id="sort-by">
                <option value="name-asc">Name (A-Z)</option>
                <option value="name-desc">Name (Z-A)</option>
                <option value="regions-desc">Most Regions</option>
                <option value="regions-asc">Fewest Regions</option>
            </select>
            <label>Sort By</label>
        </div>
    </div>
</div>

<div class="row">
    {% if worlds %}
        {% for world in worlds %}
        <div class="col s12">
            <div class="card hoverable" onclick="window.location.href='{% url 'world_detail' world.world_id %}';" style="cursor: pointer;">
                <!-- Card Header -->
                <div class="card-content" style="background: linear-gradient(135deg, rgba(106, 76, 147, 0.2), rgba(212, 175, 55, 0.1)); border-bottom: 2px solid rgba(212, 175, 55, 0.3); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
                    <span class="card-title" style="color: var(--rpg-gold); margin: 0; font-size: 1.5rem;">
                        <i class="material-icons left">map</i>
                        {{ world.world_name }}
                    </span>
                    <div style="display: flex; gap: 15px;" onclick="event.stopPropagation();">
                        <a href="{% url 'world_detail' world.world_id %}" style="color: var(--rpg-gold); display: flex; align-items: center; gap: 4px;">
                            <i class="material-icons tiny" style="vertical-align: middle;">visibility</i> View Details
                        </a>
                        <a href="{% url 'world_update' world.world_id %}" style="color: #64b5f6; display: flex; align-items: center; gap: 4px;">
                            <i class="material-icons tiny" style="vertical-align: middle;">edit</i> Edit
                        </a>
                    </div>
                </div>

                <!-- Card Body - Horizontal Layout -->
                <div style="display: flex; flex-direction: row;">
                    <!-- Primary Image - Left Side -->
                    {% if world.primary_image_url %}
                    <div style="flex-shrink: 0; width: 300px;">
                        <img src="{{ world.primary_image_url }}"
                             alt="{{ world.world_name }}"
                             style="height: 100%; width: 300px; object-fit: cover; display: block;">
                    </div>
                    {% endif %}

                    <div style="flex: 1; display: flex; flex-direction: column;">
                    <div class="card-content" style="flex: 1; padding-top: 20px;">

                    <!-- Universe and Genre -->
                    <div style="margin: 16px 0;">
                        {% if world.universe %}
                        <div class="chip">
                            <i class="material-icons tiny">public</i>
                            {{ world.universe.universe_name }}
                        </div>
                        {% endif %}
                        {% if world.genre %}
                        <div class="chip">
                            <i class="material-icons tiny">category</i>
                            {{ world.genre }}
                        </div>
                        {% endif %}
                    </div>

                    <!-- Description -->
                    {% if world.description %}
                    <p style="margin-top: 16px; color: #b8b8d1;">
                        {{ world.description|truncatewords:30 }}
                    </p>
                    {% endif %}

                    <!-- Backstory Preview -->
                    {% if world.backstory %}
                    <p style="margin-top: 12px; color: #9898b1; font-size: 0.9rem; font-style: italic;">
                        {{ world.backstory|truncatewords:25 }}
                    </p>
                    {% endif %}

                    <!-- Stats -->
                    <div style="margin-top: 16px; display: flex; gap: 10px; flex-wrap: wrap;">
                        {% if world.region_count %}
                        <div class="chip" style="background-color: rgba(103, 58, 183, 0.2);">
                            <i class="material-icons tiny">terrain</i>
                            {{ world.region_count }} Region{{ world.region_count|pluralize }}
                        </div>
                        {% endif %}
                    </div>

                    <!-- Themes -->
                    {% if world.themes %}
                    <div style="margin-top: 12px;">
                        {% for theme in world.themes %}
                            <span class="chip" style="background-color: rgba(106, 76, 147, 0.3); margin: 2px; font-size: 0.85rem;">
                                {{ theme }}
                            </span>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                </div>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="col s12">
            <div class="card">
                <div class="card-content center-align">
                    <i class="material-icons large" style="font-size: 80px; color: var(--rpg-gold); opacity: 0.5;">map</i>
                    <h5 style="color: var(--rpg-gold);">No Worlds Found</h5>
                    <p style="color: #b8b8d1;">Create your first world to start building your RPG setting.</p>
                    <a href="{% url 'world_create' %}" class="btn waves-effect waves-light" style="margin-top: 20px;">
                        <i class="material-icons left">add</i>Create World
                    </a>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Materialize selects
    const selects = document.querySelectorAll('select');
    M.FormSelect.init(selects);

    const searchInput = document.getElementById('world-search');
    const genreFilter = document.getElementById('filter-genre');
    const imageFilter = document.getElementById('filter-has-image');
    const sortBy = document.getElementById('sort-by');
    const worldCards = document.querySelectorAll('.col.s12.m6');

    // Only proceed if we have world cards
    if (worldCards.length === 0) {
        console.log('No world cards found on page');
        return;
    }

    // Store original order and data
    const worldsData = Array.from(worldCards).map(card => {
        const cardElement = card.querySelector('.card');
        if (!cardElement) return null;

        // Extract genre from chips
        let genre = '';
        const chips = cardElement.querySelectorAll('.chip');
        chips.forEach(chip => {
            const icon = chip.querySelector('.material-icons');
            if (icon && icon.textContent.includes('category')) {
                genre = chip.textContent.trim();
            }
        });

        // Extract region count
        let regionCount = 0;
        chips.forEach(chip => {
            const icon = chip.querySelector('.material-icons');
            if (icon && icon.textContent.includes('terrain')) {
                const match = chip.textContent.match(/(\d+)/);
                if (match) regionCount = parseInt(match[1]);
            }
        });

        return {
            element: card,
            name: cardElement.querySelector('.card-title')?.textContent.trim() || '',
            genre: genre,
            themes: Array.from(chips).map(c => c.textContent.toLowerCase()).join(' '),
            text: cardElement.textContent.toLowerCase(),
            hasImage: !!cardElement.querySelector('.card-image'),
            regionCount: regionCount
        };
    }).filter(Boolean); // Remove null entries

    function filterAndSort() {
        const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
        const selectedGenre = genreFilter ? genreFilter.value : '';
        const selectedImageFilter = imageFilter ? imageFilter.value : '';
        const selectedSort = sortBy ? sortBy.value : '';

        // Filter
        let filtered = worldsData.filter(world => {
            const matchesSearch = !searchTerm || world.text.includes(searchTerm);
            const matchesGenre = !selectedGenre || world.genre.includes(selectedGenre);
            let matchesImage = true;
            if (selectedImageFilter === 'with-image') {
                matchesImage = world.hasImage;
            } else if (selectedImageFilter === 'without-image') {
                matchesImage = !world.hasImage;
            }
            return matchesSearch && matchesGenre && matchesImage;
        });

        // Sort
        filtered.sort((a, b) => {
            switch(selectedSort) {
                case 'name-asc':
                    return a.name.localeCompare(b.name);
                case 'name-desc':
                    return b.name.localeCompare(a.name);
                case 'regions-desc':
                    return b.regionCount - a.regionCount;
                case 'regions-asc':
                    return a.regionCount - b.regionCount;
                default:
                    return 0;
            }
        });

        // Hide all cards first
        worldCards.forEach(card => card.style.display = 'none');

        // Show and reorder filtered cards
        const container = worldCards[0]?.parentElement;
        if (container) {
            filtered.forEach(world => {
                world.element.style.display = 'block';
                container.appendChild(world.element);
            });
        }

        // Show no results message if needed
        const noResults = document.getElementById('no-results-message');
        if (filtered.length === 0) {
            if (!noResults) {
                const msg = document.createElement('div');
                msg.id = 'no-results-message';
                msg.className = 'col s12';
                msg.innerHTML = `
                    <div class="card">
                        <div class="card-content center-align">
                            <i class="material-icons large" style="font-size: 80px; color: var(--rpg-gold); opacity: 0.5;">search_off</i>
                            <h5 style="color: var(--rpg-gold);">No Worlds Found</h5>
                            <p style="color: #b8b8d1;">Try adjusting your search or filters.</p>
                        </div>
                    </div>
                `;
                container.appendChild(msg);
            }
        } else {
            if (noResults) {
                noResults.remove();
            }
        }
    }

    // Event listeners
    if (searchInput) searchInput.addEventListener('input', filterAndSort);
    if (genreFilter) genreFilter.addEventListener('change', filterAndSort);
    if (imageFilter) imageFilter.addEventListener('change', filterAndSort);
    if (sortBy) sortBy.addEventListener('change', filterAndSort);

    // Remove duplicate genres from dropdown
    if (genreFilter) {
        const genreOptions = Array.from(genreFilter.querySelectorAll('option:not(:first-child)'));
        const uniqueGenres = [...new Set(genreOptions.map(o => o.value))];
        genreOptions.forEach(o => o.remove());
        uniqueGenres.sort().forEach(genre => {
            if (genre) {
                const option = document.createElement('option');
                option.value = genre;
                option.textContent = genre;
                genreFilter.appendChild(option);
            }
        });
        M.FormSelect.init(genreFilter);
    }
});
</script>

<!-- World Factory Modal -->
<div id="world-factory-modal" class="modal" style="max-width: 600px; background-color: var(--rpg-dark); max-height: 90%; display: flex; flex-direction: column;">
    <div style="background-color: var(--rpg-dark); padding: 24px 24px 16px 24px; border-bottom: 2px solid var(--rpg-gold); position: sticky; top: 0; z-index: 10;">
        <h4 style="color: var(--rpg-gold); margin: 0;">
            <i class="material-icons left">auto_awesome</i>
            AI World Factory
        </h4>
    </div>
    <div class="modal-content" style="background-color: var(--rpg-dark); flex: 1; overflow-y: auto; padding-top: 0;">
        <p style="color: #b8b8d1; margin-top: 20px;">Generate a complete, richly detailed world automatically using AI. This will create:</p>
        <ul style="color: #9898b1; margin-left: 20px;">
            <li>✨ Unique world with genre-appropriate themes and backstory</li>
            <li>🗺️ 1-8 diverse regions (based on world features)</li>
            <li>🏛️ <strong>3-level hierarchical locations</strong>:
                <ul style="margin-left: 20px; margin-top: 8px;">
                    <li>Level 1: 2-3 Primary locations per region (Islands, Forests, Districts)</li>
                    <li>Level 2: 2-3 Settlements per primary (Cities, Towns, Fortresses)</li>
                    <li>Level 3: 4-8 Buildings per settlement (Shops, Houses, Inns, Temples)</li>
                </ul>
            </li>
            <li>🐉 4-12 unique species (distributed across compatible regions)</li>
            <li>🎨 AI-generated images:
                <ul style="margin-left: 20px; margin-top: 8px;">
                    <li>World: 1 image (Full Planet View)</li>
                    <li>Regions: 1 image per region</li>
                    <li>Locations: 1 image per Level 1 & 2 location (not Level 3)</li>
                    <li>Species: 1 image per species (Full Body)</li>
                </ul>
            </li>
        </ul>

        <div class="input-field" style="margin-top: 30px;">
            <select id="world-factory-genre" style="color: #e0e0e0;">
                <option value="" disabled selected>Choose a genre</option>
                <option value="Fantasy">Fantasy</option>
                <option value="Sci-Fi">Sci-Fi</option>
                <option value="Cyberpunk">Cyberpunk</option>
                <option value="Steampunk">Steampunk</option>
                <option value="Post-Apocalyptic">Post-Apocalyptic</option>
                <option value="Space Opera">Space Opera</option>
                <option value="Dark Fantasy">Dark Fantasy</option>
                <option value="Urban Fantasy">Urban Fantasy</option>
                <option value="Mythological">Mythological</option>
                <option value="Historical Fantasy">Historical Fantasy</option>
                <option value="Superhero">Superhero</option>
                <option value="Horror">Horror</option>
                <option value="Western">Western</option>
                <option value="Asian Fantasy">Asian Fantasy</option>
                <option value="Solarpunk">Solarpunk</option>
            </select>
            <label style="color: var(--rpg-gold);">Select World Genre</label>
        </div>

        <div class="card" style="background-color: rgba(212, 175, 55, 0.1); border-left: 4px solid var(--rpg-gold); margin-top: 20px;">
            <div class="card-content">
                <p style="color: var(--rpg-gold); font-size: 0.9rem; margin: 0;">
                    <i class="material-icons tiny">info</i>
                    <strong>Estimated time:</strong> 10-20 minutes<br>
                    <strong>Estimated cost:</strong> $2-$4 in AI credits (1 image per world/region/species, 1 per Level 1&2 locations)
                </p>
            </div>
        </div>
    </div>
    <div class="modal-footer" style="background-color: var(--rpg-darker); border-top: 1px solid var(--rpg-gold); position: sticky; bottom: 0; z-index: 10; flex-shrink: 0;">
        <a href="#!" class="modal-close waves-effect waves-light btn-flat" style="color: var(--rpg-silver);">Cancel</a>
        <a href="#!" id="start-world-factory-btn" class="waves-effect waves-light btn" style="background: var(--rpg-purple); border: 1px solid var(--rpg-gold);">
            <i class="material-icons left">play_arrow</i>Generate World
        </a>
    </div>
</div>

<!-- World Factory Progress Modal -->
<div id="world-factory-progress-modal" class="modal" style="max-width: 800px; background-color: var(--rpg-dark);">
    <div class="modal-content" style="background-color: var(--rpg-dark);">
        <h4 style="color: var(--rpg-gold); border-bottom: 2px solid var(--rpg-gold); padding-bottom: 10px;">
            <i class="material-icons left">hourglass_empty</i>
            Generating Your World...
        </h4>
        <p id="progress-genre-display" style="color: #b8b8d1; margin-top: 15px;"></p>

        <!-- Cost & Time Tracking -->
        <div class="row" style="margin-top: 15px;">
            <div class="col s6">
                <div class="card" style="background-color: rgba(47, 158, 68, 0.1); border: 1px solid var(--rpg-green);">
                    <div class="card-content">
                        <p style="color: var(--rpg-silver); font-size: 0.8rem; margin: 0;">Elapsed Time</p>
                        <h5 style="color: var(--rpg-green); margin: 5px 0;" id="elapsed-time">0:00</h5>
                    </div>
                </div>
            </div>
            <div class="col s6">
                <div class="card" style="background-color: rgba(212, 175, 55, 0.1); border: 1px solid var(--rpg-gold);">
                    <div class="card-content">
                        <p style="color: var(--rpg-silver); font-size: 0.8rem; margin: 0;">Estimated Cost</p>
                        <h5 style="color: var(--rpg-gold); margin: 5px 0;" id="estimated-cost">$0.00</h5>
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Status -->
        <div id="current-status" style="margin-top: 20px; padding: 15px; background-color: rgba(106, 76, 147, 0.2); border-left: 3px solid var(--rpg-gold); border-radius: 4px;">
            <p style="color: #b8b8d1; margin: 0;">
                <i class="material-icons tiny" style="vertical-align: middle; color: var(--rpg-gold);">info</i>
                <span id="current-status-text">Initializing workflow...</span>
            </p>
        </div>

        <!-- Progress Steps -->
        <div id="progress-steps" style="margin-top: 20px;">
            <!-- Steps will be dynamically added here -->
        </div>
    </div>
    <div class="modal-footer" style="background-color: var(--rpg-darker); border-top: 1px solid var(--rpg-gold);">
        <a href="#!" id="stop-workflow-btn" class="waves-effect waves-light btn red darken-2" style="display: inline-block;">
            <i class="material-icons left">stop</i>Stop & Rollback
        </a>
        <a href="#!" id="view-world-btn" class="waves-effect waves-light btn" style="display: none; background: var(--rpg-gold); color: var(--rpg-dark);">
            <i class="material-icons left">visibility</i>View World
        </a>
        <a href="#!" id="close-progress-btn" class="waves-effect waves-light btn-flat" style="display: none; color: var(--rpg-silver);">Close</a>
    </div>
</div>

<script>
// World Factory functionality
document.addEventListener('DOMContentLoaded', function() {
    // Initialize modals
    const factoryModal = document.getElementById('world-factory-modal');
    const progressModal = document.getElementById('world-factory-progress-modal');
    M.Modal.init(factoryModal);
    M.Modal.init(progressModal, {dismissible: false});

    // Initialize select
    const genreSelect = document.getElementById('world-factory-genre');
    M.FormSelect.init(genreSelect);

    let currentWorkflowId = null;
    let startTime = null;
    let timerInterval = null;

    // Check for in-progress workflows on page load
    async function checkInProgressWorkflows() {
        try {
            const response = await fetch('/api/world-factory/workflows/');
            const data = await response.json();

            if (data.success && data.workflows && data.workflows.length > 0) {
                // Find any in-progress workflow
                const inProgress = data.workflows.find(w =>
                    w.status !== 'completed' && w.status !== 'failed' && w.status !== 'cancelled'
                );

                if (inProgress) {
                    // Show the banner
                    document.getElementById('in-progress-banner').style.display = 'block';
                    document.getElementById('in-progress-message').textContent =
                        `Generating ${inProgress.genre || 'world'}... (Started ${new Date(inProgress.created_at).toLocaleTimeString()})`;

                    // Store the workflow ID
                    currentWorkflowId = inProgress.workflow_id;

                    // Set up "View Progress" button
                    document.getElementById('view-progress-btn').addEventListener('click', function() {
                        reopenProgressModal(inProgress);
                    });
                }
            }
        } catch (error) {
            console.error('Error checking in-progress workflows:', error);
        }
    }

    // Reopen progress modal for existing workflow
    function reopenProgressModal(workflow) {
        currentWorkflowId = workflow.workflow_id;

        // Set genre display
        document.getElementById('progress-genre-display').textContent =
            `Generating ${workflow.genre || 'world'}...`;

        // Reset button visibility
        document.getElementById('view-world-btn').style.display = 'none';
        document.getElementById('stop-workflow-btn').style.display = 'inline-block';
        document.getElementById('close-progress-btn').style.display = 'none';

        // Calculate elapsed time
        const workflowStart = new Date(workflow.created_at);
        startTime = workflowStart.getTime();

        // Initialize UI
        updateProgressUI({progress_history: []});

        // Start timer
        timerInterval = setInterval(updateTimer, 1000);

        // Open modal
        M.Modal.getInstance(progressModal).open();

        // Start polling
        pollProgress(currentWorkflowId);
    }

    // Check on page load
    checkInProgressWorkflows();

    // Start World Factory
    document.getElementById('start-world-factory-btn').addEventListener('click', async function() {
        const genre = document.getElementById('world-factory-genre').value;

        if (!genre) {
            M.toast({html: 'Please select a genre', classes: 'red'});
            return;
        }

        // Close genre modal, open progress modal
        M.Modal.getInstance(factoryModal).close();

        // Set genre display
        document.getElementById('progress-genre-display').textContent = `Generating ${genre} world...`;

        // Reset progress UI
        document.getElementById('progress-steps').innerHTML = '';
        document.getElementById('current-status-text').textContent = 'Initializing workflow...';
        document.getElementById('elapsed-time').textContent = '0:00';
        document.getElementById('estimated-cost').textContent = '$0.00';
        document.getElementById('view-world-btn').style.display = 'none';
        document.getElementById('stop-workflow-btn').style.display = 'inline-block';
        document.getElementById('close-progress-btn').style.display = 'none';

        // Start timer
        startTime = Date.now();
        timerInterval = setInterval(updateTimer, 1000);

        // Initialize progress UI with all steps as pending
        updateProgressUI({progress_history: []});

        // Open progress modal
        setTimeout(() => {
            M.Modal.getInstance(progressModal).open();
        }, 300);

        try {
            // Initiate workflow
            const response = await fetch('/api/world-factory/initiate/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({genre, user_id: 'user123'})
            });

            const result = await response.json();

            if (result.success) {
                currentWorkflowId = result.workflow_id;
                M.toast({html: 'World generation started!', classes: 'green'});

                // Start polling for progress immediately
                pollProgress(currentWorkflowId);
            } else {
                throw new Error(result.error || 'Failed to start workflow');
            }
        } catch (error) {
            console.error('Error starting world factory:', error);
            M.toast({html: `Error: ${error.message}`, classes: 'red'});
            M.Modal.getInstance(progressModal).close();
            clearInterval(timerInterval);
        }
    });

    function updateTimer() {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        document.getElementById('elapsed-time').textContent =
            `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }

    async function pollProgress(workflowId) {
        try {
            const response = await fetch(`/api/world-factory/${workflowId}/status/`);
            const data = await response.json();

            if (data.success) {
                // Update UI with progress
                updateProgressUI(data);

                // Check if workflow is complete
                const latestStatus = data.latest_status || {};
                if (latestStatus.status === 'completed') {
                    // Workflow complete!
                    clearInterval(timerInterval);
                    handleCompletion(workflowId, latestStatus);
                } else if (latestStatus.status === 'failed') {
                    // Workflow failed
                    clearInterval(timerInterval);
                    M.toast({html: 'World generation failed. Check audit trail for details.', classes: 'red'});
                } else {
                    // Continue polling
                    setTimeout(() => pollProgress(workflowId), 2000);
                }
            }
        } catch (error) {
            console.error('Error polling progress:', error);
            // Retry polling
            setTimeout(() => pollProgress(workflowId), 3000);
        }
    }

    function updateProgressUI(data) {
        const stepsContainer = document.getElementById('progress-steps');
        const currentStatus = document.getElementById('current-status-text');

        // Build steps visualization
        const stepNames = [
            'check_uniqueness', 'generate_world_core', 'generate_world_properties', 'generate_world_backstory',
            'generate_world_images', 'generate_regions', 'generate_region_images',
            'generate_locations', 'generate_location_images', 'generate_species',
            'generate_species_images', 'finalize'
        ];

        const stepLabels = {
            'check_uniqueness': 'Checking Uniqueness',
            'generate_world_core': 'Creating World Core',
            'generate_world_properties': 'Defining Properties',
            'generate_world_backstory': 'Writing Backstory',
            'generate_world_images': 'Generating World Images',
            'generate_regions': 'Creating Regions',
            'generate_region_images': 'Generating Region Images',
            'generate_locations': 'Creating Locations',
            'generate_location_images': 'Generating Location Images',
            'generate_species': 'Creating Species',
            'generate_species_images': 'Generating Species Images',
            'finalize': 'Finalizing World'
        };

        // Group events by step
        const stepEvents = {};
        const progressHistory = data.progress_history || [];
        progressHistory.forEach(event => {
            const step = event.step;
            if (!stepEvents[step]) {
                stepEvents[step] = [];
            }
            stepEvents[step].push(event);
        });

        // Get latest event for status update
        if (progressHistory.length > 0) {
            const latest = progressHistory[progressHistory.length - 1];
            currentStatus.textContent = latest.message;

            // Update cost if available
            if (latest.data && latest.data.total_cost_usd !== undefined) {
                document.getElementById('estimated-cost').textContent =
                    `$${latest.data.total_cost_usd.toFixed(2)}`;
            }
        }

        // Render steps
        stepsContainer.innerHTML = stepNames.map(step => {
            const events = stepEvents[step] || [];
            const latestEvent = events[events.length - 1];
            const status = latestEvent ? latestEvent.status : 'pending';

            let icon = 'radio_button_unchecked';
            let color = '#666';
            if (status === 'completed') {
                icon = 'check_circle';
                color = 'var(--rpg-green)';
            } else if (status === 'started' || status === 'in_progress') {
                icon = 'hourglass_empty';
                color = 'var(--rpg-gold)';
            } else if (status === 'failed') {
                icon = 'error';
                color = 'var(--rpg-red)';
            }

            return `
                <div style="display: flex; align-items: center; padding: 10px; border-left: 3px solid ${color}; padding-left: 15px; margin-bottom: 8px; background-color: rgba(106, 76, 147, 0.05); border-radius: 4px;">
                    <i class="material-icons" style="color: ${color}; margin-right: 12px; font-size: 20px;">${icon}</i>
                    <span style="color: ${color === '#666' ? 'var(--rpg-silver)' : color};">${stepLabels[step] || step}</span>
                </div>
            `;
        }).join('');
    }

    async function handleCompletion(workflowId, statusData) {
        M.toast({html: 'World generation complete! 🎉', classes: 'green', displayLength: 4000});

        // Hide stop button and banner, show close button
        document.getElementById('stop-workflow-btn').style.display = 'none';
        document.getElementById('in-progress-banner').style.display = 'none';
        document.getElementById('close-progress-btn').style.display = 'inline-block';

        // Get final result
        try {
            const response = await fetch(`/api/world-factory/${workflowId}/result/`);
            const result = await response.json();

            if (result.success && result.result.world_id) {
                const worldId = result.result.world_id;
                const viewBtn = document.getElementById('view-world-btn');
                viewBtn.style.display = 'inline-block';
                viewBtn.onclick = () => {
                    window.location.href = `/worlds/${worldId}/`;
                };

                // Show final summary
                document.getElementById('current-status-text').innerHTML = `
                    <i class="material-icons tiny" style="vertical-align: middle; color: var(--rpg-green);">check_circle</i>
                    <span style="color: var(--rpg-gold); font-weight: 500;">World "${result.result.summary.world_name}" created successfully!</span><br>
                    <span style="font-size: 0.85rem; color: var(--rpg-silver); margin-top: 5px; display: inline-block;">
                        ${result.result.summary.region_count} regions •
                        ${result.result.summary.location_count} locations •
                        ${result.result.summary.species_count} species
                    </span>
                `;
            }
        } catch (error) {
            console.error('Error getting result:', error);
        }
    }

    // Stop & Rollback Workflow
    document.getElementById('stop-workflow-btn').addEventListener('click', async function() {
        if (!currentWorkflowId) return;

        if (!confirm('Are you sure you want to stop this workflow and rollback all changes? This cannot be undone.')) {
            return;
        }

        try {
            const response = await fetch(`/api/world-factory/${currentWorkflowId}/cancel/`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            });

            const result = await response.json();

            if (result.success) {
                clearInterval(timerInterval);
                M.toast({html: 'Workflow stopped and rolled back successfully', classes: 'orange'});

                // Update UI to show cancellation
                document.getElementById('current-status-text').innerHTML = `
                    <i class="material-icons tiny" style="vertical-align: middle; color: var(--rpg-red);">cancel</i>
                    Workflow cancelled and all changes rolled back
                `;
                document.getElementById('stop-workflow-btn').style.display = 'none';
                document.getElementById('in-progress-banner').style.display = 'none';
                document.getElementById('close-progress-btn').style.display = 'inline-block';

                // No auto-close - user must click Close button
            } else {
                throw new Error(result.error || 'Failed to cancel workflow');
            }
        } catch (error) {
            console.error('Error cancelling workflow:', error);
            M.toast({html: `Error: ${error.message}`, classes: 'red'});
        }
    });

    // Close Progress Modal Button Handler
    document.getElementById('close-progress-btn').addEventListener('click', function() {
        M.Modal.getInstance(progressModal).close();
        // Reload page to refresh world list
        window.location.reload();
    });
});
</script>

{% endblock %}
