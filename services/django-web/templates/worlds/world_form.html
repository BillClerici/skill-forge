{% extends "base.html" %}

{% block title %}{% if form.instance %}Edit{% else %}Create{% endif %} World - SkillForge RPG{% endblock %}

{% block extra_css %}
<style>
    /* Make dropdown placeholder text more visible */
    select option[disabled] {
        color: #b8b8d1 !important;
    }

    /* Style for Materialize dropdown */
    .dropdown-content {
        background-color: #2a2a3e !important;
    }

    .dropdown-content li > a,
    .dropdown-content li > span {
        color: #e0e0e0 !important;
    }

    .dropdown-content li:hover,
    .dropdown-content li.active {
        background-color: rgba(212, 175, 55, 0.2) !important;
    }

    .dropdown-content li.selected {
        background-color: rgba(212, 175, 55, 0.3) !important;
    }

    /* Input field labels and text */
    .input-field label {
        color: #b8b8d1 !important;
    }

    .input-field input[type=text],
    .input-field textarea.materialize-textarea {
        color: #e0e0e0 !important;
        border-bottom-color: rgba(212, 175, 55, 0.3) !important;
    }

    .input-field input[type=text]:focus,
    .input-field textarea.materialize-textarea:focus {
        border-bottom-color: var(--rpg-gold) !important;
        box-shadow: 0 1px 0 0 var(--rpg-gold) !important;
    }

    .input-field label.active {
        color: var(--rpg-gold) !important;
    }

    /* Select wrapper text color */
    .select-wrapper input.select-dropdown {
        color: #e0e0e0 !important;
    }

    /* Helper text color */
    .helper-text {
        color: #b8b8d1 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col s12">
        <h3 style="color: var(--rpg-gold); text-shadow: 0 0 10px rgba(212, 175, 55, 0.3);">
            <i class="material-icons left" style="font-size: 2.5rem;">map</i>
            {% if form.instance %}Edit{% else %}Create{% endif %} World
        </h3>
    </div>
</div>

<div class="row">
    <div class="col s12 l10 offset-l1">
        <div class="card">
            <div class="card-content">
                <form method="post">
                    {% csrf_token %}

                    <!-- World Name -->
                    <div class="input-field">
                        <i class="material-icons prefix" style="color: var(--rpg-gold);">title</i>
                        <input type="text" id="world_name" name="world_name"
                               value="{{ form.world_name.value|default:'' }}" required>
                        <label for="world_name" class="{% if form.world_name.value %}active{% endif %}">World Name</label>
                        {% if form.world_name.errors %}
                            <span class="helper-text red-text">{{ form.world_name.errors.0 }}</span>
                        {% endif %}
                    </div>

                    <!-- Universe Selection (Multi-select) -->
                    <div class="input-field">
                        <i class="material-icons prefix" style="color: var(--rpg-gold);">public</i>
                        <select id="universe_ids" name="universe_ids" multiple>
                            {% for universe in universes %}
                                <option value="{{ universe.id }}"
                                        {% if universe.id in form.universe_ids.value or request.GET.universe == universe.id|stringformat:"s" %}selected{% endif %}>
                                    {{ universe.universe_name }}
                                </option>
                            {% endfor %}
                        </select>
                        <label>Universes</label>
                        <span class="helper-text">This world can belong to multiple universes</span>
                        {% if form.universe_ids.errors %}
                            <span class="helper-text red-text">{{ form.universe_ids.errors.0 }}</span>
                        {% endif %}
                    </div>

                    <!-- Genre (Dropdown) -->
                    <div class="input-field">
                        <i class="material-icons prefix" style="color: var(--rpg-gold);">category</i>
                        <select id="genre" name="genre" data-required="true">
                            <option value="" disabled {% if not form.genre.value %}selected{% endif %}>Choose Genre</option>
                            <option value="Fantasy" {% if form.genre.value == 'Fantasy' %}selected{% endif %}>Fantasy</option>
                            <option value="Sci-Fi" {% if form.genre.value == 'Sci-Fi' %}selected{% endif %}>Sci-Fi</option>
                            <option value="Horror" {% if form.genre.value == 'Horror' %}selected{% endif %}>Horror</option>
                            <option value="Cyberpunk" {% if form.genre.value == 'Cyberpunk' %}selected{% endif %}>Cyberpunk</option>
                            <option value="Steampunk" {% if form.genre.value == 'Steampunk' %}selected{% endif %}>Steampunk</option>
                            <option value="Post-Apocalyptic" {% if form.genre.value == 'Post-Apocalyptic' %}selected{% endif %}>Post-Apocalyptic</option>
                            <option value="Historical" {% if form.genre.value == 'Historical' %}selected{% endif %}>Historical</option>
                            <option value="Modern" {% if form.genre.value == 'Modern' %}selected{% endif %}>Modern</option>
                            <option value="Mystery" {% if form.genre.value == 'Mystery' %}selected{% endif %}>Mystery</option>
                            <option value="Adventure" {% if form.genre.value == 'Adventure' %}selected{% endif %}>Adventure</option>
                            <option value="Western" {% if form.genre.value == 'Western' %}selected{% endif %}>Western</option>
                            <option value="Superhero" {% if form.genre.value == 'Superhero' %}selected{% endif %}>Superhero</option>
                        </select>
                        <label>Genre <span style="color: #ff6b6b;">*</span></label>
                        <span class="helper-text" id="genre_error"></span>
                        {% if form.genre.errors %}
                            <span class="helper-text red-text">{{ form.genre.errors.0 }}</span>
                        {% endif %}
                    </div>

                    <!-- Themes (Multi-select) -->
                    <div class="input-field">
                        <i class="material-icons prefix" style="color: var(--rpg-gold);">label</i>
                        <select id="themes" name="themes" multiple>
                            <option value="Magic" {% if 'Magic' in form.themes.value %}selected{% endif %}>Magic</option>
                            <option value="Dragons" {% if 'Dragons' in form.themes.value %}selected{% endif %}>Dragons</option>
                            <option value="War" {% if 'War' in form.themes.value %}selected{% endif %}>War</option>
                            <option value="Politics" {% if 'Politics' in form.themes.value %}selected{% endif %}>Politics</option>
                            <option value="Exploration" {% if 'Exploration' in form.themes.value %}selected{% endif %}>Exploration</option>
                            <option value="Technology" {% if 'Technology' in form.themes.value %}selected{% endif %}>Technology</option>
                            <option value="Religion" {% if 'Religion' in form.themes.value %}selected{% endif %}>Religion</option>
                            <option value="Mystery" {% if 'Mystery' in form.themes.value %}selected{% endif %}>Mystery</option>
                            <option value="Romance" {% if 'Romance' in form.themes.value %}selected{% endif %}>Romance</option>
                            <option value="Survival" {% if 'Survival' in form.themes.value %}selected{% endif %}>Survival</option>
                            <option value="Trade" {% if 'Trade' in form.themes.value %}selected{% endif %}>Trade</option>
                            <option value="Prophecy" {% if 'Prophecy' in form.themes.value %}selected{% endif %}>Prophecy</option>
                            <option value="Rebellion" {% if 'Rebellion' in form.themes.value %}selected{% endif %}>Rebellion</option>
                            <option value="Ancient-Civilizations" {% if 'Ancient-Civilizations' in form.themes.value %}selected{% endif %}>Ancient Civilizations</option>
                        </select>
                        <label>Themes</label>
                        <span class="helper-text">Select all that apply</span>
                        {% if form.themes.errors %}
                            <span class="helper-text red-text">{{ form.themes.errors.0 }}</span>
                        {% endif %}
                    </div>

                    <!-- Visual Style (Multi-select) -->
                    <div class="input-field">
                        <i class="material-icons prefix" style="color: var(--rpg-gold);">palette</i>
                        <select id="visual_style" name="visual_style" multiple>
                            <option value="Dark-and-Gritty" {% if 'Dark-and-Gritty' in form.visual_style.value %}selected{% endif %}>Dark and Gritty</option>
                            <option value="Bright-and-Colorful" {% if 'Bright-and-Colorful' in form.visual_style.value %}selected{% endif %}>Bright and Colorful</option>
                            <option value="Realistic" {% if 'Realistic' in form.visual_style.value %}selected{% endif %}>Realistic</option>
                            <option value="Stylized" {% if 'Stylized' in form.visual_style.value %}selected{% endif %}>Stylized</option>
                            <option value="Noir" {% if 'Noir' in form.visual_style.value %}selected{% endif %}>Noir</option>
                            <option value="Minimalist" {% if 'Minimalist' in form.visual_style.value %}selected{% endif %}>Minimalist</option>
                            <option value="Detailed" {% if 'Detailed' in form.visual_style.value %}selected{% endif %}>Detailed</option>
                            <option value="Gothic" {% if 'Gothic' in form.visual_style.value %}selected{% endif %}>Gothic</option>
                            <option value="Whimsical" {% if 'Whimsical' in form.visual_style.value %}selected{% endif %}>Whimsical</option>
                            <option value="Retro" {% if 'Retro' in form.visual_style.value %}selected{% endif %}>Retro</option>
                        </select>
                        <label>Visual Style</label>
                        <span class="helper-text">Select all that apply</span>
                        {% if form.visual_style.errors %}
                            <span class="helper-text red-text">{{ form.visual_style.errors.0 }}</span>
                        {% endif %}
                    </div>

                    <div class="divider" style="background-color: rgba(212, 175, 55, 0.2); margin: 32px 0;"></div>

                    <!-- Setting -->
                    <div class="input-field">
                        <i class="material-icons prefix" style="color: var(--rpg-gold);">landscape</i>
                        <textarea id="setting" name="setting" class="materialize-textarea"
                                  required>{{ form.setting.value|default:'' }}</textarea>
                        <label for="setting" class="{% if form.setting.value %}active{% endif %}">Setting</label>
                        <span class="helper-text">Brief description of the world's setting</span>
                        {% if form.setting.errors %}
                            <span class="helper-text red-text">{{ form.setting.errors.0 }}</span>
                        {% endif %}
                    </div>

                    <!-- History -->
                    <div class="input-field">
                        <i class="material-icons prefix" style="color: var(--rpg-gold);">history</i>
                        <textarea id="history" name="history" class="materialize-textarea">{{ form.history.value|default:'' }}</textarea>
                        <label for="history" class="{% if form.history.value %}active{% endif %}">History</label>
                        <span class="helper-text">Historical background and major events</span>
                        {% if form.history.errors %}
                            <span class="helper-text red-text">{{ form.history.errors.0 }}</span>
                        {% endif %}
                    </div>

                    <!-- Geography -->
                    <div class="input-field">
                        <i class="material-icons prefix" style="color: var(--rpg-gold);">terrain</i>
                        <textarea id="geography" name="geography" class="materialize-textarea">{{ form.geography.value|default:'' }}</textarea>
                        <label for="geography" class="{% if form.geography.value %}active{% endif %}">Geography</label>
                        <span class="helper-text">Geographic features, regions, and locations</span>
                        {% if form.geography.errors %}
                            <span class="helper-text red-text">{{ form.geography.errors.0 }}</span>
                        {% endif %}
                    </div>

                    <!-- Culture -->
                    <div class="input-field">
                        <i class="material-icons prefix" style="color: var(--rpg-gold);">groups</i>
                        <textarea id="culture" name="culture" class="materialize-textarea">{{ form.culture.value|default:'' }}</textarea>
                        <label for="culture" class="{% if form.culture.value %}active{% endif %}">Culture</label>
                        <span class="helper-text">Cultural aspects, societies, and customs</span>
                        {% if form.culture.errors %}
                            <span class="helper-text red-text">{{ form.culture.errors.0 }}</span>
                        {% endif %}
                    </div>

                    <!-- Form Actions -->
                    <div class="card-action center-align" style="background: transparent; border: none; padding-top: 20px;">
                        <button type="submit" class="btn-large waves-effect waves-light">
                            <i class="material-icons left">save</i>
                            {% if form.instance %}Update{% else %}Create{% endif %} World
                        </button>
                        {% if form.instance %}
                        <a href="{% url 'world_detail' world.world_id %}" class="btn-large waves-effect waves-light grey darken-2" style="margin-left: 10px;">
                            <i class="material-icons left">cancel</i>Cancel
                        </a>
                        {% else %}
                        <a href="{% url 'world_list' %}" class="btn-large waves-effect waves-light grey darken-2" style="margin-left: 10px;">
                            <i class="material-icons left">cancel</i>Cancel
                        </a>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize select dropdowns
        var elems = document.querySelectorAll('select');
        M.FormSelect.init(elems);

        // Initialize all textareas
        var textareas = document.querySelectorAll('textarea');
        textareas.forEach(function(textarea) {
            M.textareaAutoResize(textarea);
        });

        // Form validation
        const form = document.querySelector('form');
        form.addEventListener('submit', function(e) {
            let isValid = true;
            const requiredSelects = document.querySelectorAll('select[data-required="true"]');

            // Clear previous error messages
            document.querySelectorAll('.helper-text').forEach(el => {
                if (!el.classList.contains('red-text')) {
                    el.textContent = '';
                    el.style.color = '';
                }
            });

            // Validate each required select
            requiredSelects.forEach(select => {
                if (!select.value || select.value === '') {
                    isValid = false;
                    const errorSpan = document.getElementById(select.id + '_error');
                    if (errorSpan) {
                        errorSpan.textContent = 'This field is required';
                        errorSpan.style.color = '#ff6b6b';
                    }
                }
            });

            // Validate text inputs
            const requiredInputs = document.querySelectorAll('input[required], textarea[required]');
            requiredInputs.forEach(input => {
                if (!input.value.trim()) {
                    isValid = false;
                    const label = input.parentElement.querySelector('label');
                    if (label && !label.textContent.includes('*')) {
                        label.innerHTML += ' <span style="color: #ff6b6b;">*</span>';
                    }
                }
            });

            if (!isValid) {
                e.preventDefault();
                M.toast({
                    html: '<span style="color: white;">Please complete all required fields marked with *</span>',
                    classes: 'red darken-2',
                    displayLength: 4000
                });

                // Scroll to first error
                const firstError = document.querySelector('.helper-text[style*="color: rgb(255, 107, 107)"]');
                if (firstError) {
                    firstError.parentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        });

        // Real-time validation feedback
        document.querySelectorAll('select[data-required="true"]').forEach(select => {
            select.addEventListener('change', function() {
                const errorSpan = document.getElementById(this.id + '_error');
                if (errorSpan && this.value) {
                    errorSpan.textContent = '';
                }
            });
        });
    });
</script>
{% endblock %}
