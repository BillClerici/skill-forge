{% extends "base.html" %}

{% block title %}{{ species.species_name }} - SkillForge RPG{% endblock %}

{% block content %}
<div class="row">
    <div class="col s12">
        <h3 style="color: var(--rpg-gold); text-shadow: 0 0 10px rgba(212, 175, 55, 0.3);">
            <i class="material-icons left" style="font-size: 2.5rem;">pets</i>
            {{ species.species_name }}
        </h3>
    </div>
</div>

<div class="row">
    <div class="col s12">
        <a href="{% url 'world_detail' world.world_id %}" class="btn waves-effect waves-light grey darken-2">
            <i class="material-icons left">arrow_back</i>Back to World
        </a>
        <a href="{% url 'species_edit' world.world_id species.species_id %}" class="btn waves-effect waves-light" style="margin-left: 10px;">
            <i class="material-icons left">edit</i>Edit Species
        </a>
        <a href="{% url 'species_delete' world.world_id species.species_id %}" class="btn waves-effect waves-light red darken-2" style="margin-left: 10px;">
            <i class="material-icons left">delete</i>Delete Species
        </a>
    </div>
</div>

<!-- World Context -->
<div class="row">
    <div class="col s12">
        <div class="card hoverable">
            <div class="card-content" style="padding: 20px;">
                <div style="display: flex; gap: 20px;">
                    <!-- Thumbnail Image on Left -->
                    {% if world.primary_image_url %}
                    <div style="flex-shrink: 0;">
                        <a href="{% url 'world_detail' world.world_id %}"
                           style="display: block;"
                           class="tooltipped"
                           data-position="bottom"
                           data-tooltip="Click to view world details">
                            <img src="{{ world.primary_image_url }}"
                                 alt="{{ world.world_name }}"
                                 style="width: 200px; height: 200px; object-fit: cover; display: block; border-radius: 4px; cursor: pointer; transition: opacity 0.3s;"
                                 onmouseover="this.style.opacity='0.8'"
                                 onmouseout="this.style.opacity='1'">
                        </a>
                    </div>
                    {% endif %}

                    <!-- World Details on Right -->
                    <div style="flex: 1;">
                        <span class="card-title" style="color: var(--rpg-gold); font-size: 1.5rem; display: block; margin-bottom: 12px;">
                            World: {{ world.world_name }}
                        </span>

                        <!-- Genre -->
                        <div style="margin-bottom: 12px;">
                            {% if world.genre %}
                            <div class="chip" style="margin: 2px;">
                                <i class="material-icons tiny">category</i>
                                {{ world.genre }}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Description -->
                        {% if world.description %}
                        <p style="margin: 8px 0; color: #b8b8d1; font-size: 0.95rem;">
                            {{ world.description|truncatewords:20 }}
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Species Details -->
<div class="row">
    <div class="col s12 l8">
        <div class="card" style="height: 100%;">
            <div class="card-content">
                <span class="card-title">
                    <i class="material-icons left">pets</i>
                    Species Details
                </span>

                <!-- Species Type and Category -->
                <div style="margin: 20px 0;">
                    {% if species.species_type %}
                    <div class="chip" style="background-color: rgba(156, 39, 176, 0.3); margin: 4px;">
                        <i class="material-icons tiny">category</i>
                        Type: {{ species.species_type }}
                    </div>
                    {% endif %}
                    {% if species.category %}
                    <div class="chip" style="background-color: rgba(0, 150, 136, 0.3); margin: 4px;">
                        <i class="material-icons tiny">psychology</i>
                        {{ species.category }}
                    </div>
                    {% endif %}
                </div>

                <!-- Description -->
                {% if species.description %}
                <div style="margin: 20px 0;">
                    <h6 style="color: var(--rpg-gold); margin-bottom: 10px;">
                        <i class="material-icons tiny">description</i> Description
                    </h6>
                    <p style="color: #b8b8d1; line-height: 1.6;">{{ species.description }}</p>
                </div>
                {% endif %}

                <!-- Backstory -->
                {% if species.backstory %}
                <div style="margin: 20px 0;">
                    <h6 style="color: var(--rpg-gold); margin-bottom: 10px;">
                        <i class="material-icons tiny">auto_stories</i> Backstory
                    </h6>
                    <p style="color: #b8b8d1; line-height: 1.6;">{{ species.backstory }}</p>
                </div>
                {% endif %}

                <!-- Character Traits -->
                {% if species.character_traits %}
                <div style="margin: 20px 0;">
                    <h6 style="color: var(--rpg-gold); margin-bottom: 10px;">
                        <i class="material-icons tiny">stars</i> Character Traits
                    </h6>
                    <div>
                        {% for trait in species.character_traits %}
                            <span class="chip" style="background-color: rgba(255, 152, 0, 0.2); margin: 4px;">{{ trait }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Regions -->
                {% if species_regions %}
                <div style="margin: 20px 0;">
                    <h6 style="color: var(--rpg-gold); margin-bottom: 10px;">
                        <i class="material-icons tiny">place</i> Regions Inhabited
                    </h6>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">
                        {% for region in species_regions %}
                        <div class="card hoverable" style="background-color: rgba(30, 30, 46, 0.5); margin: 0;">
                            <div class="card-content" style="padding: 12px;">
                                <span style="color: var(--rpg-gold); font-weight: bold; display: block; margin-bottom: 5px;">
                                    <i class="material-icons tiny" style="vertical-align: middle;">terrain</i>
                                    {{ region.region_name }}
                                </span>
                                <div class="chip" style="background-color: rgba(212, 175, 55, 0.3); font-size: 0.75rem; margin: 2px;">
                                    {{ region.region_type }}
                                </div>
                                <div class="chip" style="background-color: rgba(33, 150, 243, 0.3); font-size: 0.75rem; margin: 2px;">
                                    {{ region.climate }}
                                </div>
                            </div>
                            <div class="card-action" style="padding: 8px 12px; background-color: rgba(20, 20, 36, 0.5);">
                                <a href="{% url 'region_detail' world.world_id region.region_id %}" style="color: #64b5f6; font-size: 0.85rem;">
                                    <i class="material-icons tiny">visibility</i> View Region
                                </a>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col s12 l4">
        <!-- Species Portrait (Primary Image) -->
        {% if primary_image %}
        <div class="card" style="height: 100%;">
            <div class="card-image">
                <img src="{{ primary_image.url }}" alt="{{ species.species_name }}" class="materialboxed" style="width: 100%;">
            </div>
            <div class="card-content">
                <span class="card-title" style="color: var(--rpg-gold);">Species Portrait</span>
                <p style="color: #b8b8d1; font-size: 0.9rem; margin-top: 5px;">{{ primary_image.perspective|title }}</p>
            </div>
        </div>
        {% elif species.species_image %}
        <div class="card" style="height: 100%;">
            <div class="card-image">
                <img src="{{ species.species_image }}" alt="{{ species.species_name }}" class="materialboxed" style="width: 100%;">
            </div>
            <div class="card-content">
                <span class="card-title" style="color: var(--rpg-gold);">Species Portrait</span>
            </div>
        </div>
        {% else %}
        <div class="card" style="height: 100%;">
            <div class="card-content center-align">
                <i class="material-icons" style="font-size: 80px; color: var(--rpg-gold); opacity: 0.3;">pets</i>
                <p style="color: #b8b8d1;">No species image available</p>
                <button id="generate-image-btn" class="btn waves-effect waves-light purple darken-2" style="margin-top: 10px;">
                    <i class="material-icons left">auto_awesome</i>Generate Image
                </button>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Species Images -->
<div class="row">
    <div class="col s12">
        <div class="card">
            <div class="card-content">
                <span class="card-title">
                    <i class="material-icons left">image</i>
                    Species Images
                </span>

                <!-- Image Grid Display -->
                <div id="species-images-grid" style="margin-top: 20px;">
                    {% if species.species_images %}
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        {% for image in species.species_images %}
                        <div class="image-thumbnail-wrapper" data-index="{{ forloop.counter0 }}" style="position: relative;">
                            <img src="{{ image.url }}"
                                 alt="{{ species.species_name }} - {{ image.perspective }}"
                                 class="species-image-thumbnail materialboxed"
                                 style="width: 100%; height: 180px; object-fit: cover; border-radius: 8px; cursor: pointer; display: block;">

                            <!-- Primary Badge -->
                            {% if species.primary_image_index == forloop.counter0 %}
                            <div class="primary-badge" style="position: absolute; top: 8px; left: 8px; background: var(--rpg-gold); color: #1a1a2e; padding: 4px 10px; border-radius: 12px; font-weight: bold; font-size: 0.75rem; display: flex; align-items: center; gap: 4px;">
                                <i class="material-icons" style="font-size: 16px;">star</i>
                                PRIMARY
                            </div>
                            {% endif %}

                            <!-- Action Buttons -->
                            <div style="position: absolute; top: 8px; right: 8px; display: flex; gap: 5px;">
                                {% if species.primary_image_index != forloop.counter0 %}
                                <button class="btn-floating btn-small purple darken-2 set-primary-btn tooltipped"
                                        data-index="{{ forloop.counter0 }}"
                                        data-position="bottom"
                                        data-tooltip="Set as Primary">
                                    <i class="material-icons">star_border</i>
                                </button>
                                {% endif %}
                                <button class="btn-floating btn-small red delete-image-btn tooltipped"
                                        data-index="{{ forloop.counter0 }}"
                                        data-position="bottom"
                                        data-tooltip="Delete Image">
                                    <i class="material-icons">delete</i>
                                </button>
                            </div>

                            <div style="background: rgba(0,0,0,0.7); color: white; padding: 5px; border-radius: 0 0 8px 8px; font-size: 0.8rem; text-align: center;">
                                {{ image.perspective|title }}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div id="no-images-placeholder" style="background-color: rgba(30, 30, 46, 0.5); border-radius: 8px; padding: 60px 20px; text-align: center; margin-bottom: 15px;">
                        <i class="material-icons" style="font-size: 80px; color: var(--rpg-gold); opacity: 0.3;">pets</i>
                        <p style="color: #b8b8d1; margin-top: 10px;">No species images generated yet</p>
                    </div>
                    {% endif %}
                </div>

                <!-- Action Buttons -->
                <div style="text-align: center;">
                    <button id="generate-species-images-btn" class="btn waves-effect waves-light purple darken-2">
                        <i class="material-icons left">auto_awesome</i>
                        <span id="generate-btn-text">
                            {% if species.species_images %}
                                {% if species.species_images|length == 0 %}
                                    Generate 4 Species Images with AI
                                {% elif species.species_images|length == 1 %}
                                    Generate 3 More Images
                                {% elif species.species_images|length == 2 %}
                                    Generate 2 More Images
                                {% elif species.species_images|length == 3 %}
                                    Generate 1 More Image
                                {% else %}
                                    Delete images to generate more
                                {% endif %}
                            {% else %}
                                Generate 4 Species Images with AI
                            {% endif %}
                        </span>
                    </button>
                </div>

                <!-- Loading Indicator -->
                <div id="image-gen-loading" style="display: none; text-align: center; margin-top: 20px;">
                    <div class="progress" style="background-color: rgba(212, 175, 55, 0.2);">
                        <div class="indeterminate" style="background-color: var(--rpg-gold);"></div>
                    </div>
                    <p style="color: #b8b8d1; text-align: center;">Generating images with AI...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Materialize tooltips
        const tooltips = document.querySelectorAll('.tooltipped');
        M.Tooltip.init(tooltips);

        // Initialize Materialbox
        const materialboxes = document.querySelectorAll('.materialboxed');
        M.Materialbox.init(materialboxes);

        // Generate species images
        const generateImagesBtn = document.getElementById('generate-species-images-btn');
        const imageGenLoading = document.getElementById('image-gen-loading');

        if (generateImagesBtn) {
            generateImagesBtn.addEventListener('click', async function() {
                imageGenLoading.style.display = 'block';
                generateImagesBtn.disabled = true;

                try {
                    const response = await fetch('{% url "species_generate_image" world.world_id species.species_id %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    const data = await response.json();

                    if (data.success) {
                        M.toast({
                            html: `Successfully generated ${data.images_generated} image(s)!`,
                            classes: 'green darken-2',
                            displayLength: 4000
                        });
                        location.reload();
                    } else {
                        M.toast({
                            html: `Error: ${data.error}`,
                            classes: 'red darken-2',
                            displayLength: 4000
                        });
                        imageGenLoading.style.display = 'none';
                        generateImagesBtn.disabled = false;
                    }
                } catch (error) {
                    M.toast({
                        html: `Error: ${error.message}`,
                        classes: 'red darken-2',
                        displayLength: 4000
                    });
                    imageGenLoading.style.display = 'none';
                    generateImagesBtn.disabled = false;
                }
            });
        }

        // Delete image
        document.addEventListener('click', async function(e) {
            if (e.target.closest('.delete-image-btn')) {
                const btn = e.target.closest('.delete-image-btn');
                const imageIndex = parseInt(btn.getAttribute('data-index'));

                if (!confirm('Are you sure you want to delete this image?')) {
                    return;
                }

                try {
                    const response = await fetch('{% url "species_delete_image" world.world_id species.species_id %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ image_index: imageIndex })
                    });

                    const data = await response.json();

                    if (data.success) {
                        M.toast({
                            html: 'Image deleted successfully',
                            classes: 'green darken-2',
                            displayLength: 3000
                        });
                        location.reload();
                    } else {
                        M.toast({
                            html: `Error: ${data.error || 'Failed to delete image'}`,
                            classes: 'red darken-2',
                            displayLength: 4000
                        });
                    }
                } catch (error) {
                    M.toast({
                        html: `Error: ${error.message}`,
                        classes: 'red darken-2',
                        displayLength: 4000
                    });
                }
            }

            // Set primary image
            if (e.target.closest('.set-primary-btn')) {
                const btn = e.target.closest('.set-primary-btn');
                const imageIndex = parseInt(btn.getAttribute('data-index'));

                try {
                    const response = await fetch('{% url "species_set_primary_image" world.world_id species.species_id %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ image_index: imageIndex })
                    });

                    const data = await response.json();

                    if (data.success) {
                        M.toast({
                            html: 'Primary image updated',
                            classes: 'green darken-2',
                            displayLength: 3000
                        });
                        location.reload();
                    } else {
                        M.toast({
                            html: `Error: ${data.error || 'Failed to set primary image'}`,
                            classes: 'red darken-2',
                            displayLength: 4000
                        });
                    }
                } catch (error) {
                    M.toast({
                        html: `Error: ${error.message}`,
                        classes: 'red darken-2',
                        displayLength: 4000
                    });
                }
            }
        });
    });
</script>
{% endblock %}
