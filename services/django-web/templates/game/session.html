{% extends 'base.html' %}
{% load static %}

{% block title %}Game Session - {{ campaign.title }}{% endblock %}

{% block extra_css %}
<style>
    /* ===================================
       Global Game Layout Styles
       =================================== */
    *, *::before, *::after {
        box-sizing: border-box;
    }

    body {
        margin: 0;
        padding: 0;
        overflow: hidden;
    }

    /* Override base.html container for full-screen game */
    main {
        padding: 0 !important;
    }

    main > .container {
        padding: 0 !important;
        margin: 0 !important;
        width: 100% !important;
        max-width: 100% !important;
    }

    .game-wrapper {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 64px); /* Subtract nav height */
        width: 100vw;
        overflow: hidden;
        position: fixed;
        top: 64px; /* Position below nav bar */
        left: 0;
        z-index: 1;
    }

    /* ===================================
       Header - Rounded and spanning main content
       =================================== */
    .game-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        flex-shrink: 0;
        z-index: 100;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        transition: margin 0.3s ease-in-out, width 0.3s ease-in-out;
        border-radius: 8px;
        margin: 1rem;
        width: calc(100% - 2rem);
    }

    .game-header.left-condensed {
        margin-left: calc(320px + 1rem);
        width: calc(100% - 320px - 2rem);
    }

    .game-header.right-condensed {
        margin-right: calc(320px + 1rem);
        width: calc(100% - 320px - 2rem);
    }

    .game-header.both-condensed {
        margin-left: calc(320px + 1rem);
        margin-right: calc(320px + 1rem);
        width: calc(100% - 640px - 2rem);
    }

    .campaign-info-row {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.75rem 1rem;
        border-bottom: 1px solid rgba(255,255,255,0.2);
    }

    .campaign-thumbnail {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 6px;
        border: 2px solid rgba(255,255,255,0.3);
        flex-shrink: 0;
    }

    .campaign-details {
        flex: 1;
    }

    .campaign-details h1 {
        margin: 0 0 0.25rem 0;
        font-size: 1.3rem;
    }

    .campaign-details .description {
        margin: 0;
        opacity: 0.9;
        font-size: 0.85rem;
        line-height: 1.4;
    }

    .game-status-row {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        background: rgba(0,0,0,0.1);
    }

    .status-item {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .status-label {
        font-size: 0.7rem;
        opacity: 0.8;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-value {
        font-size: 0.9rem;
        font-weight: bold;
    }

    /* ===================================
       Main Game Container
       =================================== */
    .game-container {
        display: flex;
        flex: 1;
        overflow: hidden;
        position: relative;
    }

    /* ===================================
       Slide-out Drawers - RPG Fantasy Theme
       =================================== */
    .drawer {
        background: linear-gradient(180deg, #16213e 0%, #1a1a2e 100%); /* RPG dark gradient */
        color: #e0e0e0; /* Light text */
        box-shadow: 4px 0 12px rgba(0, 0, 0, 0.5);
        transition: transform 0.3s ease-in-out;
        z-index: 110; /* Above header */
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .drawer-left {
        position: fixed;
        left: 0;
        top: 64px; /* Below main nav */
        bottom: 0;
        width: 320px;
        transform: translateX(-100%);
        border-right: 2px solid rgba(212, 175, 55, 0.2); /* RPG gold border */
    }

    .drawer-left.open {
        transform: translateX(0);
    }

    .drawer-left.anchored {
        position: fixed; /* Keep fixed, don't make it part of flex layout */
        transform: translateX(0);
        top: 64px; /* Below main nav */
    }

    .drawer-right {
        position: fixed;
        right: 0;
        top: 64px; /* Below main nav */
        bottom: 0;
        width: 320px;
        transform: translateX(100%);
        border-left: 2px solid rgba(212, 175, 55, 0.2); /* RPG gold border */
    }

    .drawer-right.open {
        transform: translateX(0);
    }

    .drawer-right.anchored {
        position: fixed; /* Keep fixed, don't make it part of flex layout */
        transform: translateX(0);
        top: 64px; /* Below main nav */
    }

    .drawer-header {
        background: linear-gradient(135deg, #2d1b69 0%, #1a1a2e 100%); /* RPG purple gradient */
        color: white;
        padding: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
        border-bottom: 2px solid #d4af37; /* RPG gold border */
        box-shadow: 0 2px 8px rgba(212, 175, 55, 0.3);
    }

    .drawer-left .drawer-header {
        background: linear-gradient(135deg, #2d1b69 0%, #1a1a2e 100%); /* RPG purple gradient */
    }

    .drawer-right .drawer-header {
        background: linear-gradient(135deg, #2d1b69 0%, #1a1a2e 100%); /* RPG purple gradient */
    }

    .drawer-header h3 {
        margin: 0;
        font-size: 1.1rem;
        color: #d4af37; /* RPG gold */
        text-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
        font-weight: 700;
        letter-spacing: 1px;
    }

    .drawer-controls {
        display: flex;
        gap: 0.5rem;
    }

    .drawer-btn {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        cursor: pointer;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 1rem;
        transition: all 0.2s;
    }

    .drawer-btn:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    .drawer-content {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        background: linear-gradient(180deg, #16213e 0%, #1a1a2e 100%); /* RPG dark gradient */
    }

    .drawer-content h3 {
        color: #d4af37; /* RPG gold */
        font-size: 1.3rem;
        font-weight: bold;
        margin: 0 0 1rem 0;
        text-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
    }

    .drawer-content h4 {
        color: #c0c0c0; /* RPG silver */
        font-size: 1rem;
        font-weight: bold;
        margin: 1rem 0 0.5rem 0;
        letter-spacing: 0.5px;
    }

    .drawer-content p {
        color: #b8b8d1;
    }

    .drawer-content hr {
        border-color: rgba(212, 175, 55, 0.2); /* RPG gold border */
    }

    /* Drawer content scrollbar - RPG themed */
    .drawer-content::-webkit-scrollbar {
        width: 12px;
    }

    .drawer-content::-webkit-scrollbar-track {
        background: #0f0f1e; /* RPG darker */
    }

    .drawer-content::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, #d4af37 0%, #cd7f32 100%); /* Gold to bronze */
        border-radius: 6px;
        border: 2px solid #0f0f1e;
    }

    .drawer-content::-webkit-scrollbar-thumb:hover {
        background: #d4af37; /* Pure gold on hover */
    }

    /* ===================================
       Drawer Toggle Buttons
       =================================== */
    .drawer-toggle {
        position: fixed;
        top: 50%;
        transform: translateY(-50%);
        background: #667eea;
        color: white;
        border: none;
        padding: 1rem 0.5rem;
        cursor: pointer;
        z-index: 85;
        border-radius: 0 8px 8px 0;
        font-size: 1rem;
        transition: all 0.2s;
        box-shadow: 2px 0 8px rgba(0,0,0,0.2);
    }

    .drawer-toggle:hover {
        background: #5a67d8;
        transform: translateY(-50%) scale(1.05);
    }

    .drawer-toggle-left {
        left: 0;
    }

    .drawer-toggle-left.hidden {
        left: 320px;
    }

    .drawer-toggle-right {
        right: 0;
        border-radius: 8px 0 0 8px;
        box-shadow: -2px 0 8px rgba(0,0,0,0.2);
    }

    .drawer-toggle-right.hidden {
        right: 320px;
    }

    /* ===================================
       Tile-Based Grid System
       =================================== */
    .game-grid {
        flex: 1;
        display: grid;
        grid-template-columns: 2fr 3fr;
        grid-template-rows: 1fr;
        gap: 1rem;
        padding: 1rem;
        overflow: hidden;
        transition: margin 0.3s ease-in-out, width 0.3s ease-in-out;
        box-sizing: border-box;
        max-width: 100%;
    }

    .game-grid.left-anchored {
        margin-left: 320px;
        width: calc(100% - 320px);
    }

    .game-grid.right-anchored {
        margin-right: 320px;
        width: calc(100% - 320px);
    }

    /* Grid Tiles */
    .grid-tile {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        min-width: 0; /* Allow content to shrink */
        min-height: 0; /* Allow content to shrink */
        box-sizing: border-box;
    }

    /* Chat Section - Left Side (40% width, 100% height) */
    .tile-chat {
        grid-column: 1;
        grid-row: 1;
        min-width: 0;
        overflow: hidden;
    }

    /* Map/Images Section - Right Side (60% width, 100% height) */
    .tile-map {
        grid-column: 2;
        grid-row: 1;
        min-width: 0;
        overflow: hidden;
        background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
    }

    /* When both drawers anchored, adjust main content */
    .game-grid.both-anchored {
        margin-left: 320px;
        margin-right: 320px;
        width: calc(100% - 640px);
    }

    /* ===================================
       Map/Images Panel
       =================================== */
    .map-panel {
        display: flex;
        flex-direction: column;
        height: 100%;
        width: 100%;
        overflow: hidden;
        color: white;
        box-sizing: border-box;
    }

    .map-header {
        background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
        color: white;
        padding: 1rem;
        font-weight: bold;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 2px solid rgba(212, 175, 55, 0.3);
        box-sizing: border-box;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
    }

    .map-content {
        flex: 1;
        overflow: auto;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .map-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        gap: 1rem;
        color: rgba(255, 255, 255, 0.6);
        font-size: 1.2rem;
    }

    .map-placeholder-icon {
        font-size: 4rem;
    }

    /* ===================================
       Chat Panel (Main Game Narrative)
       =================================== */
    .chat-panel {
        display: flex;
        flex-direction: column;
        height: 100%;
        overflow: hidden;
    }

    .chat-header {
        background: #667eea;
        color: white;
        padding: 1rem;
        font-weight: bold;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        background: #f7fafc;
    }

    .chat-message {
        margin-bottom: 1rem;
        animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .message-dm {
        background: #edf2f7;
        border-left: 4px solid #667eea;
        padding: 0.75rem 1rem;
        border-radius: 4px;
    }

    .message-player {
        background: #e6fffa;
        border-left: 4px solid #38b2ac;
        padding: 0.75rem 1rem;
        border-radius: 4px;
    }

    .message-npc {
        background: #fffaf0;
        border-left: 4px solid #ed8936;
        padding: 0.75rem 1rem;
        border-radius: 4px;
    }

    .message-assessment {
        background: #fef5e7;
        border-left: 4px solid #f6ad55;
        padding: 0.75rem 1rem;
        border-radius: 4px;
    }

    .message-sender {
        font-weight: bold;
        margin-bottom: 0.25rem;
        color: #2d3748;
        font-size: 0.875rem;
    }

    .message-content {
        color: #4a5568;
        line-height: 1.6;
        word-wrap: break-word;
        font-size: 0.9rem;
    }

    .message-time {
        font-size: 0.75rem;
        color: #a0aec0;
        margin-top: 0.5rem;
    }

    .chat-input-container {
        padding: 1rem;
        background: white;
        border-top: 1px solid #e2e8f0;
        flex-shrink: 0;
    }

    .chat-input {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e2e8f0;
        border-radius: 4px;
        font-size: 1rem;
        resize: none;
    }

    .chat-input:focus {
        outline: none;
        border-color: #667eea;
    }

    .input-controls {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .mic-button {
        flex-shrink: 0;
        padding: 0.75rem;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.2s;
        font-size: 1rem;
    }

    .mic-button:hover {
        background: #5a67d8;
    }

    .mic-button.recording {
        background: #f56565;
        animation: pulse 1.5s infinite;
    }

    .mic-button:disabled {
        background: #cbd5e0;
        cursor: not-allowed;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }

    .send-button {
        flex: 1;
        padding: 0.75rem;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 4px;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.2s;
    }

    .send-button:hover {
        background: #5a67d8;
    }

    .send-button:disabled {
        background: #cbd5e0;
        cursor: not-allowed;
    }

    /* ===================================
       Info Panel (Tabs)
       =================================== */
    .info-panel {
        display: flex;
        flex-direction: column;
        height: 100%;
        overflow: hidden;
    }

    .info-tabs {
        display: flex;
        background: #edf2f7;
        border-bottom: 2px solid #e2e8f0;
        flex-shrink: 0;
    }

    .info-tab {
        flex: 1;
        padding: 0.75rem 0.5rem;
        text-align: center;
        cursor: pointer;
        font-weight: bold;
        color: #4a5568;
        transition: all 0.2s;
        font-size: 0.85rem;
    }

    .info-tab.active {
        background: white;
        color: #667eea;
        border-bottom: 3px solid #667eea;
    }

    .info-tab:hover {
        background: #f7fafc;
    }

    .info-content {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        display: none;
    }

    .info-content.active {
        display: block;
    }

    .quest-objective {
        padding: 0.75rem;
        background: #f7fafc;
        border-radius: 4px;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        color: #2d3748;
    }

    .quest-objective.completed {
        background: #c6f6d5;
        text-decoration: line-through;
        opacity: 0.7;
    }

    .objective-checkbox {
        margin-right: 0.75rem;
        font-size: 1.2rem;
    }

    .character-stat {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem;
        border-bottom: 1px solid rgba(212, 175, 55, 0.2); /* RPG gold border */
        transition: all 0.3s ease;
    }

    .character-stat:hover {
        background: linear-gradient(90deg, rgba(212, 175, 55, 0.1) 0%, transparent 100%);
    }

    .stat-label {
        font-weight: 600;
        color: #b8b8d1;
        font-size: 1.05rem;
    }

    .stat-value {
        color: #d4af37 !important; /* RPG gold */
        font-size: 0.95rem !important;
        font-weight: 600 !important;
        text-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
    }

    .available-actions {
        margin-top: 1rem;
    }

    .action-button {
        display: block;
        width: 100%;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        background: #f7fafc;
        border: 2px solid #e2e8f0;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .action-button:hover {
        background: #edf2f7;
        border-color: #667eea;
    }

    /* ===================================
       Connection Status
       =================================== */
    .connection-status {
        position: fixed;
        top: 74px; /* Position below main nav (64px) + small gap */
        right: 20px;
        padding: 0.5rem 1rem;
        background: #48bb78;
        color: white;
        border-radius: 4px;
        font-size: 0.875rem;
        z-index: 150; /* Above game header */
    }

    .connection-status.disconnected {
        background: #f56565;
    }

    .typing-indicator {
        padding: 1rem;
        color: #a0aec0;
        font-style: italic;
        font-size: 0.875rem;
    }

    /* ===================================
       TTS/STT Controls
       =================================== */
    .tts-controls {
        display: flex;
        gap: 0.5rem;
    }

    .tts-button, .stt-button {
        padding: 0.4rem 0.8rem;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85rem;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .tts-button:hover, .stt-button:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    .tts-button.playing {
        background: #48bb78;
        border-color: #48bb78;
    }

    .stt-button.recording {
        background: #f56565;
        border-color: #f56565;
        animation: pulse 1.5s infinite;
    }

    .message-tts-button {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.5rem;
        background: #e2e8f0;
        color: #4a5568;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.75rem;
        margin-left: 0.5rem;
        transition: all 0.2s;
    }

    .message-tts-button:hover {
        background: #cbd5e0;
    }

    .message-tts-button.playing {
        background: #48bb78;
        color: white;
    }

    /* ===================================
       Settings Modal
       =================================== */
    .settings-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        justify-content: center;
        align-items: center;
    }

    .settings-modal.show {
        display: flex;
    }

    .settings-content {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        max-width: 500px;
        width: 90%;
    }

    .settings-option {
        margin-bottom: 1.5rem;
    }

    .settings-option label {
        display: block;
        font-weight: bold;
        margin-bottom: 0.5rem;
        color: #2d3748;
    }

    .settings-option select,
    .settings-option input[type="range"] {
        width: 100%;
        padding: 0.5rem;
        border: 2px solid #e2e8f0;
        border-radius: 4px;
        font-size: 1rem;
    }

    .settings-buttons {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
    }

    .settings-buttons button {
        flex: 1;
        padding: 0.75rem;
        border: none;
        border-radius: 4px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s;
    }

    .save-settings {
        background: #667eea;
        color: white;
    }

    .save-settings:hover {
        background: #5a67d8;
    }

    .cancel-settings {
        background: #e2e8f0;
        color: #4a5568;
    }

    .cancel-settings:hover {
        background: #cbd5e0;
    }

    /* ===================================
       Responsive Design
       =================================== */
    @media (max-width: 1200px) {
        .drawer-left, .drawer-right {
            width: 280px;
        }

        .drawer-toggle-left.hidden {
            left: 280px;
        }

        .drawer-toggle-right.hidden {
            right: 280px;
        }

        .game-grid.left-anchored {
            margin-left: 280px;
            width: calc(100% - 280px);
        }

        .game-grid.right-anchored {
            margin-right: 280px;
            width: calc(100% - 280px);
        }

        .game-grid.both-anchored {
            margin-left: 280px;
            margin-right: 280px;
            width: calc(100% - 560px);
        }

        .game-header.left-condensed {
            margin-left: calc(280px + 1rem);
            width: calc(100% - 280px - 2rem);
        }

        .game-header.right-condensed {
            margin-right: calc(280px + 1rem);
            width: calc(100% - 280px - 2rem);
        }

        .game-header.both-condensed {
            margin-left: calc(280px + 1rem);
            margin-right: calc(280px + 1rem);
            width: calc(100% - 560px - 2rem);
        }
    }

    @media (max-width: 768px) {
        .drawer-left, .drawer-right {
            width: 100%;
            max-width: 320px;
        }

        .drawer-left.anchored,
        .drawer-right.anchored {
            position: fixed;
        }

        .game-grid.left-anchored,
        .game-grid.right-anchored,
        .game-grid.both-anchored {
            margin-left: 0;
            margin-right: 0;
        }

        .game-grid {
            grid-template-columns: 1fr;
            grid-template-rows: 60% 40%;
        }

        .tile-chat {
            grid-column: 1;
            grid-row: 2;
        }

        .tile-map {
            grid-column: 1;
            grid-row: 1;
        }
    }

    .info-content h3 {
        font-size: 1.3rem;
        font-weight: bold;
        color: #2d3748;
        margin: 0 0 1rem 0;
    }

    .info-content h4 {
        font-size: 1rem;
        font-weight: bold;
        color: #4a5568;
        margin: 1rem 0 0.5rem 0;
    }
</style>
{% endblock %}

{% block content %}
<!-- Save/Load Component -->
{% include 'game/components/save_load.html' %}

<div class="game-wrapper">
    <!-- Header (unchanged) -->
    <div class="game-header">
        <div class="campaign-info-row">
            {% if campaign.primary_image_url %}
            <img src="{{ campaign.primary_image_url }}" alt="{{ campaign.title }}" class="campaign-thumbnail">
            {% elif campaign.campaign_images %}
            <img src="{{ campaign.campaign_images.0.url }}" alt="{{ campaign.title }}" class="campaign-thumbnail">
            {% else %}
            <div class="campaign-thumbnail" style="background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%); display: flex; align-items: center; justify-content: center; font-size: 2rem;">
                üé≤
            </div>
            {% endif %}
            <div class="campaign-details">
                <h1>{{ campaign.title }}</h1>
                <p class="description">{{ campaign.description|truncatewords:20|default:"Embark on an epic adventure in this AI-powered campaign!" }}</p>
            </div>
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <button onclick="openSaveLoadModal()" style="
                    padding: 0.6rem 1.2rem;
                    background: rgba(255, 255, 255, 0.2);
                    color: white;
                    border: 2px solid rgba(255, 255, 255, 0.3);
                    border-radius: 6px;
                    font-weight: 600;
                    cursor: pointer;
                    font-size: 0.9rem;
                    transition: all 0.2s;
                    white-space: nowrap;
                " onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'">
                    üíæ Save/Load
                </button>
                <div id="connectionStatus" class="connection-status disconnected" style="position: static; margin: 0;">
                    Connecting...
                </div>
            </div>
        </div>

        <div class="game-status-row">
            <div class="status-item">
                <div class="status-label">Current Quest</div>
                <div class="status-value" id="currentQuest">Loading...</div>
            </div>
            <div class="status-item">
                <div class="status-label">Location</div>
                <div class="status-value" id="currentLocation">Unknown</div>
            </div>
            <div class="status-item">
                <div class="status-label">Party Size</div>
                <div class="status-value" id="partySize">1 Hero</div>
            </div>
            <div class="status-item">
                <div class="status-label">Bloom Level</div>
                <div class="status-value" id="headerBloomLevel">{{ character.blooms_level|title }}</div>
            </div>
        </div>
    </div>

    <!-- Main Game Container -->
    <div class="game-container">
        <!-- Left Drawer Toggle -->
        <button class="drawer-toggle drawer-toggle-left" id="leftDrawerToggle" onclick="toggleLeftDrawer()">
            üìã
        </button>

        <!-- Left Drawer (Campaign/Quest/Actions) -->
        <div class="drawer drawer-left" id="leftDrawer">
            <div class="drawer-header">
                <h3>Game Info</h3>
                <div class="drawer-controls">
                    <button class="drawer-btn" onclick="toggleLeftDrawerAnchor()" title="Anchor drawer">
                        üìå
                    </button>
                    <button class="drawer-btn" onclick="toggleLeftDrawer()">
                        ‚úï
                    </button>
                </div>
            </div>
            <div class="drawer-content">
                <!-- Campaign Status Section -->
                <h3>üìú Campaign</h3>
                <div style="padding: 1rem; background: rgba(212, 175, 55, 0.1); border-radius: 8px; border-left: 3px solid #d4af37; margin-bottom: 1.5rem;">
                    <h4 style="margin: 0; color: #d4af37; font-size: 1.1rem;">{{ campaign.title }}</h4>
                </div>

                <!-- Quest Status Section -->
                <h3>‚öîÔ∏è Quest Status</h3>
                <div style="padding: 1rem; background: rgba(212, 175, 55, 0.1); border-radius: 8px; border-left: 3px solid #d4af37; margin-bottom: 1.5rem;">
                    <div id="drawerQuestInfo">
                        <p style="color: #b8b8d1;">Loading quest information...</p>
                    </div>
                    <h4 style="margin-top: 1rem;">Objectives</h4>
                    <div id="drawerQuestObjectives" class="quest-tracker">
                        <!-- Objectives will be populated -->
                    </div>
                </div>

                <!-- Actions Section -->
                <h3>üéØ Available Actions</h3>
                <div id="drawerAvailableActions" class="available-actions" style="margin-bottom: 1.5rem;">
                    <p style="color: #b8b8d1; font-size: 0.9rem;">No actions available yet.</p>
                </div>

                <!-- Character Section -->
                <h3>üßô Character</h3>
                <div style="padding: 1rem; background: rgba(212, 175, 55, 0.1); border-radius: 8px; border-left: 3px solid #d4af37; margin-bottom: 1.5rem;">
                    <h4 style="margin-top: 0; color: #d4af37;">{{ character.name }}</h4>
                    <div class="character-stat">
                        <span class="stat-label">Species:</span>
                        <span class="stat-value">{{ character.species.name }}</span>
                    </div>
                    <div class="character-stat">
                        <span class="stat-label">Bloom's Level:</span>
                        <span class="stat-value" id="drawerBloomLevel">{{ character.blooms_level|title }}</span>
                    </div>
                    <div class="character-stat">
                        <span class="stat-label">Location:</span>
                        <span class="stat-value" id="drawerLocation">Unknown</span>
                    </div>
                    <h4 style="margin-top: 1rem; color: #c0c0c0;">Inventory</h4>
                    <div id="drawerInventory">
                        <p style="color: #b8b8d1; font-size: 0.9rem;">Empty</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Drawer Toggle -->
        <button class="drawer-toggle drawer-toggle-right" id="rightDrawerToggle" onclick="toggleRightDrawer()">
            üë•
        </button>

        <!-- Right Drawer (Party/Progress) -->
        <div class="drawer drawer-right" id="rightDrawer">
            <div class="drawer-header">
                <h3>Party & Progress</h3>
                <div class="drawer-controls">
                    <button class="drawer-btn" onclick="toggleRightDrawerAnchor()" title="Anchor drawer">
                        üìå
                    </button>
                    <button class="drawer-btn" onclick="toggleRightDrawer()">
                        ‚úï
                    </button>
                </div>
            </div>
            <div class="drawer-content">
                <!-- Team Chat Component -->
                {% include 'game/components/team_chat.html' %}

                <hr style="margin: 2rem 0; border: none; border-top: 1px solid #e2e8f0;">

                <!-- Progress Dashboard Component -->
                {% include 'game/components/progress_dashboard.html' %}
            </div>
        </div>

        <!-- Tile-Based Grid -->
        <div class="game-grid" id="gameGrid">
            <!-- Chat Section - Left Side (40% width, 100% height) -->
            <div class="grid-tile tile-chat">
                <div class="chat-panel">
                    <div class="chat-header">
                        <span>üë§ Game Master's Narration</span>
                        <div class="tts-controls">
                            <button class="tts-button" id="autoPlayToggle" onclick="toggleAutoPlay()" title="Auto-play narration">
                                üîá Auto-Play
                            </button>
                            <button class="tts-button" onclick="openSettingsModal()" title="TTS/STT Settings">
                                ‚öôÔ∏è
                            </button>
                        </div>
                    </div>
                    <div class="chat-messages" id="chatMessages">
                        <div class="chat-message message-dm">
                            <div class="message-sender">üë§ Game Master</div>
                            <div class="message-content">
                                Welcome, adventurer! Connecting to the game world...
                            </div>
                        </div>
                    </div>
                    <div id="typingIndicator" class="typing-indicator" style="display: none;">
                        Someone is typing...
                    </div>
                    <div class="chat-input-container">
                        <textarea id="playerInput" class="chat-input" rows="3" placeholder="What do you do?" disabled></textarea>
                        <div class="input-controls">
                            <button id="micButton" class="mic-button" onclick="toggleMicrophone()" disabled title="Voice input">
                                üé§
                            </button>
                            <button id="sendButton" class="send-button" disabled>Send Action</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Map/Images Section - Right Side (60% width, 100% height) -->
            <div class="grid-tile tile-map">
                <div class="map-panel">
                    <div class="map-header">
                        <span>üó∫Ô∏è World Map & Visuals</span>
                    </div>
                    <div class="map-content">
                        <div class="map-placeholder">
                            <div class="map-placeholder-icon">üó∫Ô∏è</div>
                            <div>Map and Scene Images</div>
                            <div style="font-size: 0.9rem; opacity: 0.5;">Coming Soon</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- TTS/STT Settings Modal -->
<div id="settingsModal" class="settings-modal">
    <div class="settings-content">
        <h2 style="margin-top: 0;">Audio Settings</h2>

        <div class="settings-option">
            <label for="voiceTypeSelect">Game Master Voice:</label>
            <select id="voiceTypeSelect">
                <option value="game_master">Game Master (Old British Male)</option>
                <option value="dramatic">Dramatic (Deep & Resonant)</option>
                <option value="friendly">Friendly (Warm & Pleasant)</option>
                <option value="mysterious">Mysterious (Calm & Enigmatic)</option>
                <option value="heroic">Heroic (Strong & Commanding)</option>
            </select>
        </div>

        <div class="settings-option">
            <label for="playbackSpeedRange">Playback Speed: <span id="speedValue">1.0x</span></label>
            <input type="range" id="playbackSpeedRange" min="0.5" max="2.0" step="0.1" value="1.0" oninput="document.getElementById('speedValue').textContent = this.value + 'x'">
        </div>

        <div class="settings-option">
            <label>
                <input type="checkbox" id="autoPlayCheckbox" onchange="updateAutoPlayFromCheckbox()">
                Auto-play new Game Master narration
            </label>
        </div>

        <div class="settings-buttons">
            <button class="save-settings" onclick="saveSettings()">Save Settings</button>
            <button class="cancel-settings" onclick="closeSettingsModal()">Cancel</button>
        </div>
    </div>
</div>

<script>
    // Game Session Configuration
    const SESSION_ID = '{{ session_id }}';
    const PLAYER_ID = '{{ player.player_id }}';
    const CHARACTER_ID = '{{ character.character_id }}';
    const GAME_ENGINE_WS_URL = 'ws://localhost:9500/api/v1/ws/session/' + SESSION_ID + '/player/' + PLAYER_ID;

    // Campaign Quest Data (from server)
    const CAMPAIGN_FIRST_QUEST = {% if first_quest_json %}{{ first_quest_json|safe }}{% else %}null{% endif %};

    // Campaign Introduction Data
    const CAMPAIGN_INTRO = {% if campaign_intro_json %}{{ campaign_intro_json|safe }}{% else %}null{% endif %};

    let ws = null;
    let isConnected = false;
    let isFirstSceneLoad = true;
    let streamingMessageDiv = null;
    let streamingContent = "";

    // TTS/STT Configuration
    let autoPlayEnabled = false;
    let currentAudio = null;
    let voiceType = 'game_master';
    let playbackSpeed = 1.0;
    let mediaRecorder = null;
    let audioChunks = [];
    let isRecording = false;

    // Drawer state
    let leftDrawerOpen = false;
    let rightDrawerOpen = false;
    let leftDrawerAnchored = false;
    let rightDrawerAnchored = false;

    // Make ws global for team chat component
    window.ws = ws;

    // ===================================
    // Drawer Functions
    // ===================================
    function toggleLeftDrawer() {
        leftDrawerOpen = !leftDrawerOpen;
        const drawer = document.getElementById('leftDrawer');
        const toggle = document.getElementById('leftDrawerToggle');

        if (leftDrawerOpen) {
            drawer.classList.add('open');
            toggle.classList.add('hidden');
        } else {
            drawer.classList.remove('open');
            toggle.classList.remove('hidden');
        }
    }

    function toggleRightDrawer() {
        rightDrawerOpen = !rightDrawerOpen;
        const drawer = document.getElementById('rightDrawer');
        const toggle = document.getElementById('rightDrawerToggle');

        if (rightDrawerOpen) {
            drawer.classList.add('open');
            toggle.classList.add('hidden');
        } else {
            drawer.classList.remove('open');
            toggle.classList.remove('hidden');
        }
    }

    function toggleLeftDrawerAnchor() {
        leftDrawerAnchored = !leftDrawerAnchored;
        const drawer = document.getElementById('leftDrawer');
        const grid = document.getElementById('gameGrid');
        const header = document.querySelector('.game-header');
        const toggle = document.getElementById('leftDrawerToggle');

        if (leftDrawerAnchored) {
            drawer.classList.add('anchored');
            drawer.classList.remove('open');
            grid.classList.add('left-anchored');
            header.classList.add('left-condensed');
            toggle.style.display = 'none';
            leftDrawerOpen = false;

            if (rightDrawerAnchored) {
                grid.classList.add('both-anchored');
                header.classList.add('both-condensed');
                header.classList.remove('left-condensed');
            }
        } else {
            drawer.classList.remove('anchored');
            grid.classList.remove('left-anchored');
            grid.classList.remove('both-anchored');
            header.classList.remove('left-condensed');
            header.classList.remove('both-condensed');
            toggle.style.display = 'block';
            toggle.classList.remove('hidden');

            if (rightDrawerAnchored) {
                header.classList.add('right-condensed');
            }
        }
    }

    function toggleRightDrawerAnchor() {
        rightDrawerAnchored = !rightDrawerAnchored;
        const drawer = document.getElementById('rightDrawer');
        const grid = document.getElementById('gameGrid');
        const header = document.querySelector('.game-header');
        const toggle = document.getElementById('rightDrawerToggle');

        if (rightDrawerAnchored) {
            drawer.classList.add('anchored');
            drawer.classList.remove('open');
            grid.classList.add('right-anchored');
            header.classList.add('right-condensed');
            toggle.style.display = 'none';
            rightDrawerOpen = false;

            if (leftDrawerAnchored) {
                grid.classList.add('both-anchored');
                header.classList.add('both-condensed');
                header.classList.remove('right-condensed');
            }
        } else {
            drawer.classList.remove('anchored');
            grid.classList.remove('right-anchored');
            grid.classList.remove('both-anchored');
            header.classList.remove('right-condensed');
            header.classList.remove('both-condensed');
            toggle.style.display = 'block';
            toggle.classList.remove('hidden');

            if (leftDrawerAnchored) {
                header.classList.add('left-condensed');
            }
        }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        connectWebSocket();
        setupEventListeners();
        fetchSessionState();
        loadSettings();

        // Open and pin both drawers by default
        toggleLeftDrawerAnchor();
        toggleRightDrawerAnchor();
    });

    function connectWebSocket() {
        updateConnectionStatus('connecting');

        ws = new WebSocket(GAME_ENGINE_WS_URL);
        window.ws = ws;

        ws.onopen = function() {
            isConnected = true;
            updateConnectionStatus('connected');
            enableInput();
        };

        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            handleGameEvent(data);
        };

        ws.onerror = function(error) {
            updateConnectionStatus('error');
        };

        ws.onclose = function() {
            isConnected = false;
            updateConnectionStatus('disconnected');
            disableInput();
            setTimeout(connectWebSocket, 3000);
        };
    }

    function handleGameEvent(data) {
        switch(data.event) {
            case 'connected':
                addSystemMessage('Connected to game session');
                break;

            case 'chat_message':
                if (data.message && data.message.channel && typeof handleIncomingChat === 'function') {
                    handleIncomingChat(data.message);
                } else {
                    addChatMessage(data.message);
                }
                break;

            case 'scene_chunk':
                handleSceneChunk(data);
                break;

            case 'scene_update':
            case 'initial_scene':
                updateScene(data);
                break;

            case 'state_update':
                updateGameState(data);
                break;

            case 'action_received':
                addSystemMessage('Processing your action...');
                break;

            case 'typing_indicator':
                showTypingIndicator(data.is_typing);
                break;

            case 'player_joined_session':
                addSystemMessage(`${data.character_name} joined the party`);
                if (typeof handleIncomingChat === 'function') {
                    handleIncomingChat({
                        event: 'player_joined',
                        player_name: data.character_name
                    });
                }
                break;

            case 'player_left':
                addSystemMessage(`A player left the session`);
                if (typeof handleIncomingChat === 'function') {
                    handleIncomingChat({
                        event: 'player_left',
                        player_name: data.character_name || 'Unknown'
                    });
                }
                break;

            case 'quest_completed':
                handleQuestComplete(data);
                break;

            case 'dynamic_event_triggered':
                handleDynamicEvent(data.event_data);
                break;

            case 'challenge_created':
                handleChallenge(data.challenge);
                break;
        }
    }

    function sendPlayerAction() {
        const input = document.getElementById('playerInput');
        const action = input.value.trim();

        if (!action || !isConnected) return;

        ws.send(JSON.stringify({
            event: 'player_action',
            content: action
        }));

        input.value = '';
        disableInput();
    }

    function handleSceneChunk(data) {
        const chatMessages = document.getElementById('chatMessages');

        if (!streamingMessageDiv) {
            streamingContent = "";
            streamingMessageDiv = document.createElement('div');
            streamingMessageDiv.className = 'chat-message message-dm';
            streamingMessageDiv.innerHTML = `
                <div class="message-sender">üë§ Game Master</div>
                <div class="message-content" id="streamingContent"></div>
                <div class="message-time">${formatTime(new Date().toISOString())}</div>
            `;
            chatMessages.appendChild(streamingMessageDiv);
        }

        if (data.is_complete) {
            if (streamingMessageDiv) {
                const contentDiv = streamingMessageDiv.querySelector('.message-content');
                contentDiv.innerHTML = formatMessageContent(streamingContent);

                const plainText = contentDiv.innerText || contentDiv.textContent;
                addTTSButtonToMessage(streamingMessageDiv, plainText);

                if (autoPlayEnabled && !isFirstSceneLoad && plainText.length < 3000) {
                    setTimeout(() => {
                        playTextToSpeech(plainText, streamingMessageDiv);
                    }, 500);
                } else if (autoPlayEnabled && plainText.length >= 3000) {
                    console.log('Skipping auto-play: text too long (' + plainText.length + ' chars)');
                }

                isFirstSceneLoad = false;
            }

            streamingMessageDiv = null;
            streamingContent = "";
            return;
        }

        streamingContent += data.chunk;
        const contentDiv = streamingMessageDiv.querySelector('.message-content');
        contentDiv.innerHTML = formatMessageContent(streamingContent);

        if (!isFirstSceneLoad) {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    }

    function addChatMessage(message) {
        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'chat-message';

        let messageClass = 'message-dm';
        let senderIcon = 'üë§';

        switch(message.message_type) {
            case 'PLAYER_ACTION':
                messageClass = 'message-player';
                senderIcon = '‚öîÔ∏è';
                break;
            case 'DM_NPC_DIALOGUE':
                messageClass = 'message-npc';
                senderIcon = 'üí¨';
                break;
            case 'DM_ASSESSMENT':
                messageClass = 'message-assessment';
                senderIcon = 'üìä';
                break;
        }

        messageDiv.classList.add(messageClass);

        const formattedContent = formatMessageContent(message.content);

        messageDiv.innerHTML = `
            <div class="message-sender">${senderIcon} ${message.sender_name}</div>
            <div class="message-content">${formattedContent}</div>
            <div class="message-time">${formatTime(message.timestamp)}</div>
        `;

        chatMessages.appendChild(messageDiv);

        if (!isFirstSceneLoad) {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    }

    function addSystemMessage(text) {
        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'chat-message message-dm';
        messageDiv.innerHTML = `
            <div class="message-content" style="font-style: italic; color: #718096;">
                ${escapeHtml(text)}
            </div>
        `;
        chatMessages.appendChild(messageDiv);

        if (!isFirstSceneLoad) {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    }

    function updateScene(data) {
        if (data.scene_description) {
            addChatMessage({
                message_type: 'DM_NARRATIVE',
                sender_name: 'Game Master',
                content: data.scene_description,
                timestamp: data.timestamp
            });

            isFirstSceneLoad = false;
        }

        if (data.available_actions) {
            updateAvailableActions(data.available_actions);
        }

        if (data.available_npcs) {
            updateNPCList(data.available_npcs);
        }
    }

    function updateQuestInfo(questId, questTitle, questDescription, questObjectives) {
        if ((!questTitle || questTitle === '' || questTitle === null || questTitle === undefined)) {
            if (CAMPAIGN_FIRST_QUEST) {
                questTitle = CAMPAIGN_FIRST_QUEST.title;
                questDescription = CAMPAIGN_FIRST_QUEST.description;
                questObjectives = CAMPAIGN_FIRST_QUEST.objectives;
            } else {
                questTitle = "ERROR: Quest Not Found";
                questDescription = "The campaign quest could not be loaded. Please contact support.";
                questObjectives = [];
            }
        }

        // Update header quest status
        const questElement = document.getElementById('currentQuest');
        if (questTitle) {
            questElement.textContent = questTitle;
        } else if (questId) {
            questElement.textContent = "Active Quest";
        } else {
            questElement.textContent = 'Free Exploration';
        }

        // Update drawer quest info
        const drawerQuestInfoDiv = document.getElementById('drawerQuestInfo');
        if (questTitle || questDescription) {
            let questInfoHTML = '';

            if (questTitle) {
                questInfoHTML += `<h4 style="margin: 0 0 0.75rem 0; color: #d4af37; font-size: 1.1rem;">${questTitle}</h4>`;
            }

            if (questDescription) {
                questInfoHTML += `<p style="margin: 0; color: #b8b8d1; line-height: 1.6; font-size: 0.9rem;">${questDescription}</p>`;
            }

            drawerQuestInfoDiv.innerHTML = questInfoHTML;

            if (questObjectives && questObjectives.length > 0) {
                updateQuestObjectives(questObjectives);
            } else {
                document.getElementById('drawerQuestObjectives').innerHTML = '<p style="color: #b8b8d1; font-size: 0.9rem;">No specific objectives yet. Explore freely!</p>';
            }
        } else {
            drawerQuestInfoDiv.innerHTML = '<p style="color: #b8b8d1; font-style: italic;">No active quest. Explore the world!</p>';
        }
    }

    function updateQuestObjectives(objectives) {
        const drawerObjectivesDiv = document.getElementById('drawerQuestObjectives');
        if (!objectives || objectives.length === 0) {
            drawerObjectivesDiv.innerHTML = '<p style="color: #b8b8d1; font-size: 0.9rem;">No specific objectives yet.</p>';
            return;
        }

        let objectivesHTML = '';
        objectives.forEach(objective => {
            const isCompleted = objective.completed || false;
            const checkIcon = isCompleted ? '‚úÖ' : '‚¨ú';
            const completedClass = isCompleted ? ' completed' : '';

            objectivesHTML += `
                <div class="quest-objective${completedClass}">
                    <span class="objective-checkbox">${checkIcon}</span>
                    <span style="font-size: 0.9rem; color: #b8b8d1;">${typeof objective === 'string' ? objective : objective.description}</span>
                </div>
            `;
        });
        drawerObjectivesDiv.innerHTML = objectivesHTML;
    }

    function updateAvailableActions(actions) {
        const drawerActionsDiv = document.getElementById('drawerAvailableActions');

        if (!actions || actions.length === 0) {
            drawerActionsDiv.innerHTML = '<p style="color: #b8b8d1; font-size: 0.9rem;">No actions available yet.</p>';
            return;
        }

        drawerActionsDiv.innerHTML = '';

        actions.forEach(action => {
            const button = document.createElement('button');
            button.className = 'action-button';
            button.textContent = action;
            button.style.background = 'rgba(212, 175, 55, 0.2)';
            button.style.border = '2px solid rgba(212, 175, 55, 0.4)';
            button.style.color = '#d4af37';
            button.onclick = () => {
                document.getElementById('playerInput').value = action;
            };
            drawerActionsDiv.appendChild(button);
        });
    }

    function updateNPCList(npcs) {
        // Could add NPC list to UI
    }

    function updateGameState(data) {
        if (data.awaiting_player_input) {
            enableInput();
        }

        if (data.current_quest_id || data.quest_id) {
            updateQuestInfo(
                data.current_quest_id || data.quest_id,
                data.quest_title,
                data.quest_description,
                data.quest_objectives
            );
        }

        if (data.current_scene_id || data.current_location || data.location_name) {
            let locationName = data.location_name || data.current_location;

            if (!locationName && data.current_scene_id) {
                if (data.current_scene_id === 'starting_location') {
                    locationName = 'Starting Area';
                } else {
                    locationName = data.current_scene_id
                        .replace(/_/g, ' ')
                        .replace(/\b\w/g, c => c.toUpperCase());
                }
            }

            // Update both header and drawer locations
            document.getElementById('currentLocation').textContent = locationName || 'Exploring';
            const drawerLocation = document.getElementById('drawerLocation');
            if (drawerLocation) {
                drawerLocation.textContent = locationName || 'Exploring';
            }
        }

        if (data.blooms_level) {
            const bloomsLevel = data.blooms_level.charAt(0).toUpperCase() + data.blooms_level.slice(1);
            document.getElementById('headerBloomLevel').textContent = bloomsLevel;
            const drawerBloomLevel = document.getElementById('drawerBloomLevel');
            if (drawerBloomLevel) {
                drawerBloomLevel.textContent = bloomsLevel;
            }
        }

        if (data.party_members) {
            const partySize = Array.isArray(data.party_members) ? data.party_members.length : 1;
            document.getElementById('partySize').textContent = partySize === 1 ? '1 Hero' : `${partySize} Heroes`;
        }
    }

    async function fetchSessionState() {
        try {
            const response = await fetch(`http://localhost:9500/api/v1/session/${SESSION_ID}/state`);
            if (response.ok) {
                const state = await response.json();

                if (state.current_quest_id) {
                    updateQuestInfo(
                        state.current_quest_id,
                        state.quest_title,
                        state.quest_description,
                        state.quest_objectives
                    );
                }

                if (state.current_scene_id || state.current_location || state.location_name) {
                    let locationName = state.location_name || state.current_location;

                    if (!locationName && state.current_scene_id) {
                        if (state.current_scene_id === 'starting_location') {
                            locationName = 'Starting Area';
                        } else {
                            locationName = state.current_scene_id
                                .replace(/_/g, ' ')
                                .replace(/\b\w/g, c => c.toUpperCase());
                        }
                    }

                    // Update both header and drawer locations
                    document.getElementById('currentLocation').textContent = locationName || 'Exploring';
                    const drawerLocation = document.getElementById('drawerLocation');
                    if (drawerLocation) {
                        drawerLocation.textContent = locationName || 'Exploring';
                    }
                }

                if (state.blooms_level) {
                    const bloomsLevel = state.blooms_level.charAt(0).toUpperCase() + state.blooms_level.slice(1);
                    document.getElementById('headerBloomLevel').textContent = bloomsLevel;
                    const drawerBloomLevel = document.getElementById('drawerBloomLevel');
                    if (drawerBloomLevel) {
                        drawerBloomLevel.textContent = bloomsLevel;
                    }
                }

                if (state.party_members) {
                    const partySize = Array.isArray(state.party_members) ? state.party_members.length : 1;
                    document.getElementById('partySize').textContent = partySize === 1 ? '1 Hero' : `${partySize} Heroes`;
                }

                // Only add scene description if we have one
                // Don't clear initial welcome message
                if (state.scene_description) {
                    // Clear the welcome message first
                    const chatMessages = document.getElementById('chatMessages');
                    const welcomeMsg = chatMessages.querySelector('.chat-message');
                    if (welcomeMsg && welcomeMsg.textContent.includes('Welcome, adventurer')) {
                        chatMessages.innerHTML = '';
                    }

                    addChatMessage({
                        message_type: 'DM_NARRATIVE',
                        sender_name: 'Game Master',
                        content: state.scene_description,
                        timestamp: new Date().toISOString()
                    });

                    // Mark that we've loaded the first scene
                    isFirstSceneLoad = false;
                }

                if (state.available_actions && state.available_actions.length > 0) {
                    updateAvailableActions(state.available_actions);
                }

                if (state.awaiting_player_input) {
                    enableInput();
                }
            }
        } catch (error) {
            console.error('Failed to fetch session state:', error);
        }
    }

    function handleQuestComplete(data) {
        addSystemMessage(`üéâ Quest Complete: ${data.quest_title}!`);
        if (data.rewards) {
            addSystemMessage(`Rewards: ${JSON.stringify(data.rewards)}`);
        }
    }

    function handleDynamicEvent(event) {
        addChatMessage({
            message_type: 'DM_NARRATIVE',
            sender_name: 'Game Master',
            content: `‚ö° ${event.title}\n\n${event.description}`,
            timestamp: event.triggered_at
        });

        if (event.choices && event.choices.length > 0) {
            const actionsDiv = document.getElementById('availableActions');
            event.choices.forEach(choice => {
                const button = document.createElement('button');
                button.className = 'action-button';
                button.textContent = choice.text;
                button.onclick = () => {
                    ws.send(JSON.stringify({
                        event: 'resolve_event',
                        event_id: event.event_id,
                        choice_id: choice.choice_id
                    }));
                };
                actionsDiv.appendChild(button);
            });
        }
    }

    function handleChallenge(challenge) {
        addChatMessage({
            message_type: 'DM_NARRATIVE',
            sender_name: 'Game Master',
            content: `‚öîÔ∏è Challenge: ${challenge.title}\n\n${challenge.description}\n\nSuccess Criteria: ${challenge.success_criteria}`,
            timestamp: challenge.created_at
        });
    }

    function setupEventListeners() {
        document.getElementById('sendButton').addEventListener('click', sendPlayerAction);

        document.getElementById('playerInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendPlayerAction();
            }
        });
    }

    function enableInput() {
        document.getElementById('playerInput').disabled = false;
        document.getElementById('sendButton').disabled = false;
        document.getElementById('micButton').disabled = false;
    }

    function disableInput() {
        document.getElementById('sendButton').disabled = true;
    }

    function updateConnectionStatus(status) {
        const statusDiv = document.getElementById('connectionStatus');

        switch(status) {
            case 'connected':
                statusDiv.textContent = 'üü¢ Connected';
                statusDiv.className = 'connection-status';
                break;
            case 'connecting':
                statusDiv.textContent = 'üü° Connecting...';
                statusDiv.className = 'connection-status';
                break;
            case 'disconnected':
            case 'error':
                statusDiv.textContent = 'üî¥ Disconnected';
                statusDiv.className = 'connection-status disconnected';
                break;
        }
    }

    function showTypingIndicator(isTyping) {
        const indicator = document.getElementById('typingIndicator');
        indicator.style.display = isTyping ? 'block' : 'none';
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatMessageContent(text) {
        let html = text;

        html = html.replace(/^# (.+)$/gm, '<h2 style="font-size: 1.4rem; font-weight: bold; margin: 1.5rem 0 1rem 0; color: #2d3748;">$1</h2>');
        html = html.replace(/^## (.+)$/gm, '<h3 style="font-size: 1.2rem; font-weight: bold; margin: 1.25rem 0 0.75rem 0; color: #4a5568;">$1</h3>');
        html = html.replace(/^### (.+)$/gm, '<h4 style="font-size: 1.1rem; font-weight: bold; margin: 1rem 0 0.5rem 0; color: #4a5568;">$1</h4>');
        html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        html = html.replace(/^[‚Ä¢\-] (.+)$/gm, '<li style="margin-left: 1.5rem; margin-bottom: 0.25rem;">$1</li>');
        html = html.replace(/(<li[^>]*>.*<\/li>\n?)+/g, '<ul style="margin: 0.5rem 0; padding-left: 0; list-style-position: inside;">$&</ul>');
        html = html.replace(/\n\n/g, '</p><p style="margin-bottom: 1rem; line-height: 1.6;">');
        html = html.replace(/\n/g, '<br>');
        html = '<p style="margin-bottom: 1rem; line-height: 1.6;">' + html + '</p>';
        html = html.replace(/<p[^>]*><\/p>/g, '');

        return html;
    }

    function formatTime(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleTimeString();
    }

    // ============================================
    // TTS (Text-to-Speech) Functions
    // ============================================

    function toggleAutoPlay() {
        autoPlayEnabled = !autoPlayEnabled;
        const button = document.getElementById('autoPlayToggle');
        if (autoPlayEnabled) {
            button.textContent = 'üîä Auto-Play';
            button.classList.add('playing');
        } else {
            button.textContent = 'üîá Auto-Play';
            button.classList.remove('playing');
        }
        localStorage.setItem('tts_autoplay', autoPlayEnabled);
    }

    async function playTextToSpeech(text, messageElement) {
        try {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }

            let button = null;
            if (messageElement) {
                button = messageElement.querySelector('.message-tts-button');
                if (button) {
                    button.disabled = true;
                    button.classList.add('loading');
                    button.textContent = '‚è≥ Loading...';
                }
            }

            const params = new URLSearchParams({
                text: text,
                voice_type: voiceType
            });

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 60000);

            const response = await fetch(`http://localhost:9500/api/v1/tts/generate?${params.toString()}`, {
                method: 'POST',
                signal: controller.signal
            });

            clearTimeout(timeoutId);

            if (!response.ok) {
                console.error('TTS generation failed:', response.statusText);
                if (button) {
                    button.disabled = false;
                    button.classList.remove('loading');
                    button.textContent = '‚ùå Failed';
                    setTimeout(() => {
                        button.textContent = 'üîä Listen';
                    }, 2000);
                }
                return;
            }

            const audioBlob = await response.blob();
            const audioUrl = URL.createObjectURL(audioBlob);
            currentAudio = new Audio(audioUrl);
            currentAudio.playbackRate = playbackSpeed;

            if (button) {
                button.disabled = false;
                button.classList.remove('loading');
                button.classList.add('playing');
                button.textContent = '‚è∏Ô∏è Stop';
            }

            await currentAudio.play();

            currentAudio.onended = () => {
                URL.revokeObjectURL(audioUrl);
                currentAudio = null;
                if (button) {
                    button.classList.remove('playing');
                    button.textContent = 'üîä Listen';
                }
            };

            currentAudio.onerror = () => {
                URL.revokeObjectURL(audioUrl);
                currentAudio = null;
                if (button) {
                    button.classList.remove('playing');
                    button.textContent = '‚ùå Error';
                    setTimeout(() => {
                        button.textContent = 'üîä Listen';
                    }, 2000);
                }
            };

        } catch (error) {
            console.error('Error playing TTS:', error);

            if (error.name === 'AbortError') {
                console.error('TTS request timed out');
                if (messageElement) {
                    const button = messageElement.querySelector('.message-tts-button');
                    if (button) {
                        button.disabled = false;
                        button.classList.remove('loading');
                        button.textContent = '‚è±Ô∏è Timeout';
                        setTimeout(() => {
                            button.textContent = 'üîä Listen';
                        }, 3000);
                    }
                }
            } else {
                if (messageElement) {
                    const button = messageElement.querySelector('.message-tts-button');
                    if (button) {
                        button.disabled = false;
                        button.classList.remove('loading');
                        button.textContent = '‚ùå Error';
                        setTimeout(() => {
                            button.textContent = 'üîä Listen';
                        }, 2000);
                    }
                }
            }
        }
    }

    function addTTSButtonToMessage(messageDiv, text) {
        const contentDiv = messageDiv.querySelector('.message-content');
        if (!contentDiv) return;

        const ttsButton = document.createElement('button');
        ttsButton.className = 'message-tts-button';
        ttsButton.textContent = 'üîä Listen';
        ttsButton.onclick = function() {
            if (currentAudio && !currentAudio.paused) {
                currentAudio.pause();
                currentAudio = null;
                this.classList.remove('playing');
                this.textContent = 'üîä Listen';
            } else {
                const plainText = contentDiv.innerText || contentDiv.textContent;
                playTextToSpeech(plainText, messageDiv);
            }
        };

        const timeDiv = messageDiv.querySelector('.message-time');
        if (timeDiv) {
            timeDiv.appendChild(ttsButton);
        }
    }

    // ============================================
    // STT (Speech-to-Text) Functions
    // ============================================

    async function toggleMicrophone() {
        if (isRecording) {
            stopRecording();
        } else {
            await startRecording();
        }
    }

    async function startRecording() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = (event) => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                await transcribeAudio(audioBlob);

                stream.getTracks().forEach(track => track.stop());
            };

            mediaRecorder.start();
            isRecording = true;

            const micButton = document.getElementById('micButton');
            micButton.classList.add('recording');
            micButton.textContent = '‚èπÔ∏è';

        } catch (error) {
            console.error('Error accessing microphone:', error);
            alert('Could not access microphone. Please check your permissions.');
        }
    }

    function stopRecording() {
        if (mediaRecorder && isRecording) {
            mediaRecorder.stop();
            isRecording = false;

            const micButton = document.getElementById('micButton');
            micButton.classList.remove('recording');
            micButton.textContent = 'üé§';
        }
    }

    async function transcribeAudio(audioBlob) {
        try {
            const formData = new FormData();
            formData.append('audio', audioBlob, 'recording.webm');
            formData.append('language', 'en');

            const response = await fetch(`http://localhost:9500/api/v1/stt/session/${SESSION_ID}/player-action?player_id=${PLAYER_ID}`, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                console.error('STT transcription failed:', response.statusText);
                return;
            }

            const result = await response.json();

            if (result.success && result.text) {
                document.getElementById('playerInput').value = result.text;
                console.log('Transcribed:', result.text);
            }

        } catch (error) {
            console.error('Error transcribing audio:', error);
            alert('Failed to transcribe audio. Please try again.');
        }
    }

    // ============================================
    // Settings Modal Functions
    // ============================================

    function openSettingsModal() {
        const modal = document.getElementById('settingsModal');

        document.getElementById('voiceTypeSelect').value = voiceType;
        document.getElementById('playbackSpeedRange').value = playbackSpeed;
        document.getElementById('speedValue').textContent = playbackSpeed + 'x';
        document.getElementById('autoPlayCheckbox').checked = autoPlayEnabled;

        modal.classList.add('show');
    }

    function closeSettingsModal() {
        const modal = document.getElementById('settingsModal');
        modal.classList.remove('show');
    }

    function saveSettings() {
        voiceType = document.getElementById('voiceTypeSelect').value;
        playbackSpeed = parseFloat(document.getElementById('playbackSpeedRange').value);
        autoPlayEnabled = document.getElementById('autoPlayCheckbox').checked;

        const button = document.getElementById('autoPlayToggle');
        if (autoPlayEnabled) {
            button.textContent = 'üîä Auto-Play';
            button.classList.add('playing');
        } else {
            button.textContent = 'üîá Auto-Play';
            button.classList.remove('playing');
        }

        localStorage.setItem('tts_voice_type', voiceType);
        localStorage.setItem('tts_playback_speed', playbackSpeed);
        localStorage.setItem('tts_autoplay', autoPlayEnabled);

        closeSettingsModal();
    }

    function updateAutoPlayFromCheckbox() {
        autoPlayEnabled = document.getElementById('autoPlayCheckbox').checked;
    }

    function loadSettings() {
        const savedVoiceType = localStorage.getItem('tts_voice_type');
        const savedSpeed = localStorage.getItem('tts_playback_speed');
        const savedAutoPlay = localStorage.getItem('tts_autoplay');

        if (savedVoiceType) voiceType = savedVoiceType;
        if (savedSpeed) playbackSpeed = parseFloat(savedSpeed);
        if (savedAutoPlay) autoPlayEnabled = savedAutoPlay === 'true';

        const button = document.getElementById('autoPlayToggle');
        if (autoPlayEnabled) {
            button.textContent = 'üîä Auto-Play';
            button.classList.add('playing');
        }
    }

    // ============================================
    // Enhanced addChatMessage to support TTS
    // ============================================

    const originalAddChatMessage = addChatMessage;
    addChatMessage = function(message) {
        originalAddChatMessage(message);

        if (message.message_type === 'DM_NARRATIVE') {
            const chatMessages = document.getElementById('chatMessages');
            const lastMessage = chatMessages.lastElementChild;

            if (lastMessage) {
                const contentDiv = lastMessage.querySelector('.message-content');
                if (contentDiv) {
                    const plainText = contentDiv.innerText || contentDiv.textContent;
                    addTTSButtonToMessage(lastMessage, plainText);

                    if (autoPlayEnabled && !isFirstSceneLoad && plainText.length < 5000) {
                        setTimeout(() => {
                            playTextToSpeech(plainText, lastMessage);
                        }, 500);
                    } else if (autoPlayEnabled && plainText.length >= 5000) {
                        console.log('Skipping auto-play: text too long (' + plainText.length + ' chars)');
                    }
                }
            }
        }
    };
</script>
{% endblock %}
