{% extends "base.html" %}

{% block title %}{{ campaign.campaign_name }} - SkillForge RPG{% endblock %}

{% block extra_css %}
<style>
    /* Drag and Drop Styles */
    .drag-handle {
        opacity: 0.4;
        transition: opacity 0.2s;
    }

    .quest-item:hover .drag-handle,
    .place-item:hover .drag-handle,
    .scene-item:hover .drag-handle {
        opacity: 1;
    }

    .sortable-ghost {
        opacity: 0.4;
        background: rgba(212, 175, 55, 0.2);
    }

    .sortable-chosen {
        background: rgba(212, 175, 55, 0.3);
    }

    .sortable-drag {
        opacity: 0.8;
        background: rgba(212, 175, 55, 0.4);
        cursor: grabbing !important;
    }

    .drag-handle:active {
        cursor: grabbing !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col s12">
        <h3 style="color: var(--rpg-gold); text-shadow: 0 0 10px rgba(212, 175, 55, 0.3);">
            <i class="material-icons left" style="font-size: 2.5rem;">book</i>
            {{ campaign.campaign_name }}
        </h3>
    </div>
</div>

<div class="row">
    <div class="col s12">
        <a href="{% url 'campaign_list' %}" class="btn waves-effect waves-light grey darken-2">
            <i class="material-icons left">arrow_back</i>Back to Campaigns
        </a>
        {% if not is_new_format %}
        <a href="{% url 'campaign_update' campaign.campaign_id %}" class="btn waves-effect waves-light">
            <i class="material-icons left">edit</i>Edit Campaign
        </a>
        {% endif %}
        <a href="#deleteModal" class="btn waves-effect waves-light red darken-2 modal-trigger">
            <i class="material-icons left">delete</i>Delete Campaign
        </a>
    </div>
</div>

<!-- Two-Panel Layout: Tree Navigation + Details -->
{% if is_new_format %}
<div class="row" style="margin-top: 20px;">
    <!-- Left Panel: Tree Navigation -->
    <div class="col s12 l4" style="height: calc(100vh - 250px); overflow-y: auto;">
        <div class="card">
            <div class="card-content" style="padding: 15px;">
                <span class="card-title" style="font-size: 1.1rem; margin-bottom: 15px;">
                    <i class="material-icons left" style="font-size: 1.3rem;">account_tree</i>
                    Campaign Structure
                </span>

                <ul id="campaign-tree" style="list-style: none; padding-left: 0; margin: 0;">
                    <!-- Campaign Root -->
                    <li style="margin-bottom: 8px;">
                        <div class="tree-item collapsible-trigger" data-type="campaign" data-id="{{ campaign.campaign_id }}"
                             style="padding: 8px 12px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;">
                            <i class="material-icons expand-icon" style="font-size: 1rem; color: var(--rpg-silver); transition: transform 0.2s; transform: rotate(90deg);">chevron_right</i>
                            <i class="material-icons" style="font-size: 1.2rem; color: var(--rpg-gold);">campaign</i>
                            <span style="color: var(--rpg-gold); font-weight: 500;">Campaign Details</span>
                        </div>

                        <!-- Quests -->
                        <ul class="collapsible-content quests-list" data-campaign-id="{{ campaign.campaign_id }}" style="list-style: none; padding-left: 20px; margin-top: 8px; display: block;">
                            {% for quest in quests %}
                            <li class="quest-item" data-quest-id="{{ quest.quest_id }}" style="margin-bottom: 6px;">
                                <div class="tree-item collapsible-trigger" data-type="quest" data-id="{{ quest.quest_id }}"
                                     style="padding: 6px 10px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s;">
                                    <i class="material-icons drag-handle" style="font-size: 0.9rem; color: var(--rpg-silver); cursor: grab;">drag_indicator</i>
                                    <i class="material-icons expand-icon" style="font-size: 0.9rem; color: var(--rpg-silver); transition: transform 0.2s; transform: rotate(90deg);">chevron_right</i>
                                    <i class="material-icons" style="font-size: 1rem; color: var(--rpg-purple);">explore</i>
                                    <span style="color: #b8b8d1; font-size: 0.95rem;">{{ quest.name }}</span>
                                </div>

                                <!-- Places -->
                                <ul class="collapsible-content places-list" data-quest-id="{{ quest.quest_id }}" style="list-style: none; padding-left: 20px; margin-top: 4px; display: block;">
                                    {% for place in quest.places %}
                                    <li class="place-item" data-place-id="{{ place.place_id }}" style="margin-bottom: 4px;">
                                        <div class="tree-item collapsible-trigger" data-type="place" data-id="{{ place.place_id }}"
                                             style="padding: 6px 8px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s;">
                                            <i class="material-icons drag-handle" style="font-size: 0.9rem; color: var(--rpg-silver); cursor: grab;">drag_indicator</i>
                                            <i class="material-icons expand-icon" style="font-size: 0.8rem; color: var(--rpg-silver); transition: transform 0.2s;">chevron_right</i>
                                            <i class="material-icons" style="font-size: 0.9rem; color: var(--rpg-blue);">place</i>
                                            <span style="color: #b8b8d1; font-size: 0.9rem;">{{ place.name }}</span>
                                        </div>

                                        <!-- Scenes -->
                                        <ul class="collapsible-content scenes-list" data-place-id="{{ place.place_id }}" style="list-style: none; padding-left: 18px; margin-top: 4px; display: none;">
                                            {% for scene in place.scenes %}
                                            <li class="scene-item" data-scene-id="{{ scene.scene_id }}" style="margin-bottom: 3px;">
                                                <div class="tree-item" data-type="scene" data-id="{{ scene.scene_id }}"
                                                     style="padding: 5px 8px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s;">
                                                    <i class="material-icons drag-handle" style="font-size: 0.85rem; color: var(--rpg-silver); cursor: grab;">drag_indicator</i>
                                                    <i class="material-icons" style="font-size: 0.85rem; color: var(--rpg-green);">movie</i>
                                                    <span style="color: #b8b8d1; font-size: 0.85rem;">{{ scene.name }}</span>
                                                </div>
                                            </li>
                                            {% endfor %}
                                        </ul>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </li>
                            {% endfor %}
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Right Panel: Details -->
    <div class="col s12 l8">
        <div class="card">
            <div class="card-content" id="detail-content" style="min-height: 500px;">
                <!-- Campaign details shown by default -->
                <h5 id="detail-title" style="color: var(--rpg-gold); margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    <i class="material-icons">campaign</i>
                    Campaign: {{ campaign.campaign_name }}
                </h5>

                <!-- Image -->
                <div id="detail-image" style="margin-bottom: 20px;">
                    {% if campaign.primary_image_url %}
                    <img src="{{ campaign.primary_image_url }}"
                         alt="{{ campaign.campaign_name }}"
                         style="width: 100%; max-width: 600px; height: auto; object-fit: cover; border-radius: 8px; border: 2px solid rgba(212, 175, 55, 0.3);">
                    {% elif worlds and worlds.0.primary_image_url %}
                    <img src="{{ worlds.0.primary_image_url }}"
                         alt="{{ worlds.0.world_name }}"
                         style="width: 100%; max-width: 600px; height: auto; object-fit: cover; border-radius: 8px; border: 2px solid rgba(212, 175, 55, 0.3);">
                    {% else %}
                    <div style="width: 100%; max-width: 600px; height: 300px; background: linear-gradient(135deg, rgba(27, 27, 46, 0.9) 0%, rgba(106, 90, 205, 0.2) 100%); border-radius: 8px; border: 2px solid rgba(212, 175, 55, 0.3); display: flex; align-items: center; justify-content: center;">
                        <i class="material-icons" style="font-size: 80px; color: var(--rpg-gold); opacity: 0.3;">campaign</i>
                    </div>
                    {% endif %}
                </div>

                <!-- Accordion and Details -->
                <div id="detail-body">
                    <ul class="collapsible">
                        {% if campaign.plot %}
                        <li class="active">
                            <div class="collapsible-header" style="background: rgba(212, 175, 55, 0.1); border-left: 3px solid var(--rpg-gold); display: flex; align-items: center; gap: 8px;">
                                <i class="material-icons" style="color: var(--rpg-gold);">auto_stories</i>
                                <span style="color: var(--rpg-gold); font-weight: 500;">Plot</span>
                            </div>
                            <div class="collapsible-body" style="background: rgba(27, 27, 46, 0.5); border-left: 3px solid var(--rpg-gold);">
                                <p style="color: #b8b8d1; line-height: 1.7; white-space: pre-wrap; margin: 0;">{{ campaign.plot }}</p>
                            </div>
                        </li>
                        {% endif %}

                        {% if campaign.storyline %}
                        <li>
                            <div class="collapsible-header" style="background: rgba(212, 175, 55, 0.1); border-left: 3px solid var(--rpg-gold); display: flex; align-items: center; gap: 8px;">
                                <i class="material-icons" style="color: var(--rpg-gold);">description</i>
                                <span style="color: var(--rpg-gold); font-weight: 500;">Storyline</span>
                            </div>
                            <div class="collapsible-body" style="background: rgba(27, 27, 46, 0.5); border-left: 3px solid var(--rpg-gold);">
                                <p style="color: #b8b8d1; line-height: 1.7; white-space: pre-wrap; margin: 0;">{{ campaign.storyline }}</p>
                            </div>
                        </li>
                        {% endif %}

                        {% if campaign.primary_objectives %}
                        <li>
                            <div class="collapsible-header" style="background: rgba(212, 175, 55, 0.1); border-left: 3px solid var(--rpg-gold); display: flex; align-items: center; gap: 8px;">
                                <i class="material-icons" style="color: var(--rpg-gold);">flag</i>
                                <span style="color: var(--rpg-gold); font-weight: 500;">Primary Objectives</span>
                            </div>
                            <div class="collapsible-body" style="background: rgba(27, 27, 46, 0.5); border-left: 3px solid var(--rpg-gold);">
                                <ol style="margin: 0; padding-left: 20px;">
                                    {% for objective in campaign.primary_objectives %}
                                    <li style="color: #b8b8d1; margin-bottom: 6px;">{{ objective }}</li>
                                    {% endfor %}
                                </ol>
                            </div>
                        </li>
                        {% endif %}

                        {% if validation_report %}
                        <li>
                            <div class="collapsible-header" style="background: rgba(212, 175, 55, 0.1); border-left: 3px solid var(--rpg-gold); display: flex; align-items: center; gap: 8px;">
                                <i class="material-icons" style="color: var(--rpg-gold);">assessment</i>
                                <span style="color: var(--rpg-gold); font-weight: 500;">Validation Report</span>
                                {% if validation_report.validation_passed %}
                                    <span class="chip" style="background-color: rgba(76, 175, 80, 0.2); color: #4CAF50; font-size: 0.75rem; height: 24px; line-height: 24px; margin-left: 10px;">✓ Passed</span>
                                {% else %}
                                    <span class="chip" style="background-color: rgba(244, 67, 54, 0.2); color: #f44336; font-size: 0.75rem; height: 24px; line-height: 24px; margin-left: 10px;">✗ Has Issues</span>
                                {% endif %}
                            </div>
                            <div class="collapsible-body" style="background: rgba(27, 27, 46, 0.5); border-left: 3px solid var(--rpg-gold); padding: 20px;">

                                <!-- Errors -->
                                {% if validation_report.errors %}
                                <div style="margin-bottom: 20px;">
                                    <h6 style="color: #f44336; font-size: 1rem; margin-bottom: 10px;">
                                        <i class="material-icons tiny" style="vertical-align: middle;">error</i>
                                        Errors ({{ validation_report.errors|length }})
                                    </h6>
                                    <ul style="margin: 0; padding-left: 20px;">
                                        {% for error in validation_report.errors %}
                                        <li style="color: #ff8a80; margin-bottom: 8px; line-height: 1.5;">{{ error.message }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                {% endif %}

                                <!-- Warnings -->
                                {% if validation_report.warnings %}
                                <div style="margin-bottom: 20px;">
                                    <h6 style="color: #ffab40; font-size: 1rem; margin-bottom: 10px;">
                                        <i class="material-icons tiny" style="vertical-align: middle;">warning</i>
                                        Warnings ({{ validation_report.warnings|length }})
                                    </h6>
                                    <ul style="margin: 0; padding-left: 20px;">
                                        {% for warning in validation_report.warnings %}
                                        <li style="color: #ffcc80; margin-bottom: 8px; line-height: 1.5;">{{ warning.message }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                {% endif %}

                                <!-- Statistics -->
                                {% if validation_report.stats_display %}
                                <div style="margin-bottom: 20px;">
                                    <h6 style="color: var(--rpg-silver); font-size: 1rem; margin-bottom: 10px;">
                                        <i class="material-icons tiny" style="vertical-align: middle;">analytics</i>
                                        Statistics
                                    </h6>
                                    <div style="background: rgba(0, 0, 0, 0.3); padding: 15px; border-radius: 6px; border: 1px solid rgba(212, 175, 55, 0.2);">
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; color: #b8b8d1; font-size: 0.9rem;">
                                            {% for stat in validation_report.stats_display %}
                                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                                                <span style="color: var(--rpg-silver);">{{ stat.display_name }}:</span>
                                                <span style="color: var(--rpg-gold); font-weight: 500;">{{ stat.value }}</span>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Auto-fix Suggestions -->
                                {% if validation_report.auto_fix_suggestions %}
                                <div>
                                    <h6 style="color: var(--rpg-blue); font-size: 1rem; margin-bottom: 10px;">
                                        <i class="material-icons tiny" style="vertical-align: middle;">build</i>
                                        Auto-fix Suggestions ({{ validation_report.auto_fix_suggestions|length }})
                                    </h6>
                                    <ul style="margin: 0; padding-left: 20px;">
                                        {% for suggestion in validation_report.auto_fix_suggestions %}
                                        <li style="color: #82b1ff; margin-bottom: 8px; line-height: 1.5;">{{ suggestion.description }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                {% endif %}

                                <!-- Validation Timestamp -->
                                {% if validation_report.validation_timestamp %}
                                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.1); color: #888; font-size: 0.8rem;">
                                    <i class="material-icons tiny" style="vertical-align: middle;">schedule</i>
                                    Validated: {{ validation_report.validation_timestamp }}
                                </div>
                                {% endif %}

                            </div>
                        </li>
                        {% endif %}
                    </ul>

                    <div style="margin-top: 20px;">
                        <div class="chip" style="background-color: rgba(106, 90, 205, 0.2); color: var(--rpg-purple);">
                            <i class="material-icons tiny">explore</i> {{ quests|length }} Quest(s)
                        </div>
                        <div class="chip" style="background-color: rgba(76, 110, 245, 0.2); color: var(--rpg-blue);">
                            <i class="material-icons tiny">place</i> {{ campaign.stats.num_places }} Place(s)
                        </div>
                        <div class="chip" style="background-color: rgba(47, 158, 68, 0.2); color: var(--rpg-green);">
                            <i class="material-icons tiny">movie</i> {{ campaign.stats.num_scenes }} Scene(s)
                        </div>
                        <div class="chip" style="background-color: rgba(212, 175, 55, 0.2); color: var(--rpg-gold);">
                            <i class="material-icons tiny">people</i> {{ campaign.stats.num_npcs }} NPC(s)
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden data for JavaScript -->
<script id="campaign-data" type="application/json">
{{ campaign_json|safe }}
</script>

{% else %}
<!-- Old Format: Keep existing template -->
{% if campaign.campaign_description %}
<div class="row">
    <div class="col s12">
        <div class="card">
            <div class="card-content">
                <span class="card-title">
                    <i class="material-icons left">auto_stories</i>
                    Campaign Story
                </span>
                <div style="display: flex; gap: 20px; margin-top: 15px;">
                    {% if worlds and worlds.0.primary_image_url %}
                    <div style="flex-shrink: 0;">
                        <img src="{{ worlds.0.primary_image_url }}"
                             alt="{{ worlds.0.world_name }}"
                             style="width: 200px; height: 200px; object-fit: cover; border-radius: 8px; border: 2px solid rgba(212, 175, 55, 0.3);">
                    </div>
                    {% endif %}
                    <div style="flex: 1;">
                        <p style="font-size: 1.1rem; line-height: 1.8; white-space: pre-wrap;">{{ campaign.campaign_description }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="row">
    <div class="col s12 l8">
        <div class="card">
            <div class="card-content">
                <span class="card-title">
                    <i class="material-icons left">info</i>
                    Campaign Overview
                </span>
                <div style="margin: 20px 0;">
                    {% for world in worlds %}
                    <div class="chip">
                        <i class="material-icons tiny">map</i>
                        {{ world.world_name }}
                    </div>
                    {% endfor %}
                    {% for member in members %}
                    <div class="chip">
                        <i class="material-icons tiny">person</i>
                        {{ member.display_name }}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal" style="max-width: 700px;">
    <div class="modal-content" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: #e0e0e0;">
        <h4 style="color: #ff6b6b;">
            <i class="material-icons left" style="font-size: 2rem;">warning</i>
            Delete Campaign - Comprehensive Cleanup
        </h4>
        <p style="font-size: 1.1rem; margin: 20px 0; line-height: 1.6;">
            <strong style="color: #ff6b6b;">WARNING:</strong> This action will permanently delete <strong>"{{ campaign.campaign_name }}"</strong> and ALL related data from:
        </p>
        <div style="background: rgba(255, 107, 107, 0.1); border-left: 4px solid #ff6b6b; padding: 15px; margin: 15px 0; border-radius: 4px;">
            <ul style="margin: 0; padding-left: 25px; line-height: 1.8;">
                <li><strong>MongoDB:</strong> Campaign, Quests, Places, Scenes, NPCs, Discoveries, Events, Challenges, Knowledge, Items, and Rubrics</li>
                <li><strong>Neo4j:</strong> All campaign entities, relationships, and graph connections</li>
                <li><strong>PostgreSQL:</strong> Player-campaign associations and related records</li>
            </ul>
        </div>
        <p style="font-size: 0.95rem; margin: 15px 0; color: #ffab40;">
            <i class="material-icons tiny" style="vertical-align: middle;">info</i>
            <strong>This operation cannot be undone.</strong> All quest progress, generated content, and AI-created entities will be permanently removed.
        </p>
        {% if is_new_format and quests %}
        <p style="font-size: 0.9rem; margin: 10px 0; color: #b8b8d1;">
            This campaign contains <strong>{{ quests|length }} quest(s)</strong> with multiple locations, scenes, and interactive elements.
        </p>
        {% endif %}
    </div>
    <div class="modal-footer" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);">
        <a href="#!" class="modal-close waves-effect waves-light btn grey darken-2">
            <i class="material-icons left">cancel</i>Cancel
        </a>
        <form method="post" action="{% url 'campaign_delete' campaign.campaign_id %}" style="display: inline;">
            {% csrf_token %}
            <button type="submit" class="btn waves-effect waves-light red darken-2">
                <i class="material-icons left">delete_forever</i>Yes, Permanently Delete Everything
            </button>
        </form>
    </div>
</div>

<!-- Image Viewer Modal -->
<div id="imageViewerModal" class="modal" style="max-width: 90%; max-height: 90%;">
    <div class="modal-content" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: #e0e0e0; padding: 10px;">
        <img id="viewer-image" src="" alt="Full Size Image" style="width: 100%; height: auto; max-height: 80vh; object-fit: contain; border-radius: 8px;">
    </div>
    <div class="modal-footer" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);">
        <a href="#!" class="modal-close waves-effect waves-light btn grey darken-2">
            <i class="material-icons left">close</i>Close
        </a>
    </div>
</div>

<!-- Image Generation Modal -->
<div id="imageGenerationModal" class="modal" style="max-width: 800px; max-height: 90%;">
    <div class="modal-content" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: #e0e0e0;">
        <h4 style="color: var(--rpg-gold); display: flex; align-items: center; gap: 10px;">
            <i class="material-icons">image</i>
            <span id="modal-title">Generate Image</span>
        </h4>

        <!-- Loading State -->
        <div id="loading-state" style="display: none; text-align: center; padding: 40px 20px;">
            <div class="preloader-wrapper big active">
                <div class="spinner-layer spinner-blue-only">
                    <div class="circle-clipper left">
                        <div class="circle"></div>
                    </div>
                    <div class="gap-patch">
                        <div class="circle"></div>
                    </div>
                    <div class="circle-clipper right">
                        <div class="circle"></div>
                    </div>
                </div>
            </div>
            <p style="margin-top: 20px; color: var(--rpg-gold); font-size: 1.1rem;">Generating your image...</p>
            <p style="color: #b8b8d1; font-size: 0.9rem;">This may take up to 30 seconds</p>
        </div>

        <!-- Preview State -->
        <div id="preview-state" style="display: none;">
            <div style="margin: 20px 0;">
                <img id="preview-image" src="" alt="Generated Image" style="width: 100%; max-height: 350px; height: auto; object-fit: contain; border-radius: 8px; border: 2px solid rgba(212, 175, 55, 0.3);">
            </div>
            <p style="color: #b8b8d1; font-size: 0.95rem; margin-top: 15px;">
                Do you want to use this image? Click "Save Image" to confirm or "Generate Another" to try again.
            </p>
        </div>

        <!-- Error State -->
        <div id="error-state" style="display: none; padding: 20px;">
            <div style="background: rgba(255, 107, 107, 0.2); border-left: 4px solid #ff6b6b; padding: 15px; border-radius: 4px;">
                <p style="color: #ff6b6b; margin: 0;">
                    <i class="material-icons tiny" style="vertical-align: middle;">error</i>
                    <span id="error-message">Failed to generate image</span>
                </p>
            </div>
        </div>
    </div>
    <div class="modal-footer" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); display: flex; justify-content: space-between;">
        <div style="display: flex; gap: 10px;">
            <button id="generate-another-btn" class="btn waves-effect waves-light blue darken-2" style="display: none;">
                <i class="material-icons left">refresh</i>Generate Another
            </button>
            <button id="save-image-btn" class="btn waves-effect waves-light green darken-2" style="display: none;">
                <i class="material-icons left">check</i>Save Image
            </button>
        </div>
        <div>
            <a href="#!" class="modal-close waves-effect waves-light btn grey darken-2" id="close-btn">
                <i class="material-icons left">close</i>Close
            </a>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Include SortableJS for drag-and-drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize modals
    var deleteModal = document.querySelectorAll('.modal');
    M.Modal.init(deleteModal);

    // Initialize collapsibles
    var collapsibleElems = document.querySelectorAll('.collapsible');
    M.Collapsible.init(collapsibleElems, {
        accordion: true
    });

    // Get campaign data
    const campaignDataEl = document.getElementById('campaign-data');
    if (!campaignDataEl) return;

    const data = JSON.parse(campaignDataEl.textContent);

    // Initialize Sortable for Places and Scenes
    initializeSortables();

    function initializeSortables() {
        // Initialize sortable for Quests list
        const questsList = document.querySelector('.quests-list');
        if (questsList) {
            new Sortable(questsList, {
                group: 'quests',
                animation: 150,
                handle: '.drag-handle',
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                dragClass: 'sortable-drag',
                onEnd: function(evt) {
                    const campaignId = evt.to.dataset.campaignId;
                    const newOrder = Array.from(evt.to.children).map(li => li.dataset.questId);

                    console.log('Quests reordered for campaign:', campaignId, newOrder);

                    // Save new order to backend
                    saveQuestOrder(campaignId, newOrder);
                }
            });
        }

        // Initialize sortable for each Quest's Places list
        document.querySelectorAll('.places-list').forEach(placesList => {
            new Sortable(placesList, {
                group: 'places',
                animation: 150,
                handle: '.drag-handle',
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                dragClass: 'sortable-drag',
                onEnd: function(evt) {
                    const questId = evt.to.dataset.questId;
                    const newOrder = Array.from(evt.to.children).map(li => li.dataset.placeId);

                    console.log('Places reordered for quest:', questId, newOrder);

                    // Save new order to backend
                    savePlaceOrder(questId, newOrder);
                }
            });
        });

        // Initialize sortable for each Place's Scenes list
        document.querySelectorAll('.scenes-list').forEach(scenesList => {
            new Sortable(scenesList, {
                group: 'scenes',
                animation: 150,
                handle: '.drag-handle',
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                dragClass: 'sortable-drag',
                onEnd: function(evt) {
                    const placeId = evt.to.dataset.placeId;
                    const newOrder = Array.from(evt.to.children).map(li => li.dataset.sceneId);

                    console.log('Scenes reordered for place:', placeId, newOrder);

                    // Save new order to backend
                    saveSceneOrder(placeId, newOrder);
                }
            });
        });
    }

    async function saveQuestOrder(campaignId, questIds) {
        try {
            const response = await fetch(`/campaigns/${campaignId}/reorder-quests/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ quest_ids: questIds })
            });

            const result = await response.json();

            if (result.success) {
                M.toast({html: 'Quests reordered successfully', classes: 'green', displayLength: 2000});
            } else {
                throw new Error(result.error || 'Failed to reorder quests');
            }
        } catch (error) {
            console.error('Error saving quest order:', error);
            M.toast({html: 'Failed to save quest order: ' + error.message, classes: 'red'});
        }
    }

    async function savePlaceOrder(questId, placeIds) {
        try {
            const response = await fetch(`/campaigns/${data.campaign.id}/quests/${questId}/reorder-places/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ place_ids: placeIds })
            });

            const result = await response.json();

            if (result.success) {
                M.toast({html: 'Places reordered successfully', classes: 'green', displayLength: 2000});
            } else {
                throw new Error(result.error || 'Failed to reorder places');
            }
        } catch (error) {
            console.error('Error saving place order:', error);
            M.toast({html: 'Failed to save place order: ' + error.message, classes: 'red'});
        }
    }

    async function saveSceneOrder(placeId, sceneIds) {
        try {
            const response = await fetch(`/campaigns/${data.campaign.id}/places/${placeId}/reorder-scenes/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ scene_ids: sceneIds })
            });

            const result = await response.json();

            if (result.success) {
                M.toast({html: 'Scenes reordered successfully', classes: 'green', displayLength: 2000});
            } else {
                throw new Error(result.error || 'Failed to reorder scenes');
            }
        } catch (error) {
            console.error('Error saving scene order:', error);
            M.toast({html: 'Failed to save scene order: ' + error.message, classes: 'red'});
        }
    }

    // Handle tree item clicks
    document.querySelectorAll('.tree-item').forEach(item => {
        item.addEventListener('click', function(e) {
            e.stopPropagation();

            // Remove active state from all items
            document.querySelectorAll('.tree-item').forEach(el => {
                el.style.background = '';
                el.style.borderLeft = '';
            });

            // Add active state
            this.style.background = 'rgba(212, 175, 55, 0.2)';
            this.style.borderLeft = '3px solid var(--rpg-gold)';

            const type = this.dataset.type;
            const id = this.dataset.id;

            // Display details based on type
            displayDetails(type, id, data);
        });
    });

    // Handle collapsible triggers
    document.querySelectorAll('.collapsible-trigger').forEach(trigger => {
        trigger.addEventListener('click', function(e) {
            // Find the next collapsible content
            const content = this.nextElementSibling;
            if (content && content.classList.contains('collapsible-content')) {
                const icon = this.querySelector('.expand-icon');
                const isExpanded = content.style.display !== 'none';

                // Toggle display
                content.style.display = isExpanded ? 'none' : 'block';

                // Rotate icon
                if (icon) {
                    icon.style.transform = isExpanded ? 'rotate(0deg)' : 'rotate(90deg)';
                }
            }
        });
    });

    function displayDetails(type, id, data) {
        let content = '';
        let title = '';
        let iconName = '';
        let currentEntityData = null;

        if (type === 'campaign') {
            iconName = 'campaign';
            title = `Campaign: ${data.campaign.name}`;

            // Build accordion content
            let accordionHtml = '<ul class="collapsible" style="border: none; box-shadow: none; margin-top: 20px;">';

            // Plot accordion item (expanded by default)
            if (data.campaign.plot) {
                accordionHtml += `
                    <li class="active">
                        <div class="collapsible-header" style="background: rgba(212, 175, 55, 0.1); border-left: 3px solid var(--rpg-gold); display: flex; align-items: center; gap: 8px;">
                            <i class="material-icons" style="color: var(--rpg-gold);">auto_stories</i>
                            <span style="color: var(--rpg-gold); font-weight: 500;">Plot</span>
                        </div>
                        <div class="collapsible-body" style="background: rgba(27, 27, 46, 0.5); border-left: 3px solid var(--rpg-gold); display: block;">
                            <p style="color: #b8b8d1; line-height: 1.7; white-space: pre-wrap; margin: 0;">${escapeHtml(data.campaign.plot)}</p>
                        </div>
                    </li>
                `;
            }

            // Storyline accordion item
            if (data.campaign.storyline) {
                accordionHtml += `
                    <li>
                        <div class="collapsible-header" style="background: rgba(212, 175, 55, 0.1); border-left: 3px solid var(--rpg-gold); display: flex; align-items: center; gap: 8px;">
                            <i class="material-icons" style="color: var(--rpg-gold);">description</i>
                            <span style="color: var(--rpg-gold); font-weight: 500;">Storyline</span>
                        </div>
                        <div class="collapsible-body" style="background: rgba(27, 27, 46, 0.5); border-left: 3px solid var(--rpg-gold);">
                            <p style="color: #b8b8d1; line-height: 1.7; white-space: pre-wrap; margin: 0;">${escapeHtml(data.campaign.storyline)}</p>
                        </div>
                    </li>
                `;
            }

            // Primary Objectives accordion item
            if (data.campaign.primary_objectives && data.campaign.primary_objectives.length > 0) {
                accordionHtml += `
                    <li>
                        <div class="collapsible-header" style="background: rgba(212, 175, 55, 0.1); border-left: 3px solid var(--rpg-gold); display: flex; align-items: center; gap: 8px;">
                            <i class="material-icons" style="color: var(--rpg-gold);">flag</i>
                            <span style="color: var(--rpg-gold); font-weight: 500;">Primary Objectives</span>
                        </div>
                        <div class="collapsible-body" style="background: rgba(27, 27, 46, 0.5); border-left: 3px solid var(--rpg-gold);">
                            <ol style="margin: 0; padding-left: 20px;">
                                ${data.campaign.primary_objectives.map(obj => `<li style="color: #b8b8d1; margin-bottom: 6px;">${escapeHtml(obj)}</li>`).join('')}
                            </ol>
                        </div>
                    </li>
                `;
            }

            accordionHtml += '</ul>';

            // Add stats chips
            accordionHtml += `
                <div style="margin-top: 20px;">
                    <div class="chip" style="background-color: rgba(106, 90, 205, 0.2); color: var(--rpg-purple);">
                        <i class="material-icons tiny">explore</i> ${data.campaign.stats.num_quests} Quest(s)
                    </div>
                    <div class="chip" style="background-color: rgba(76, 110, 245, 0.2); color: var(--rpg-blue);">
                        <i class="material-icons tiny">place</i> ${data.campaign.stats.num_places} Place(s)
                    </div>
                    <div class="chip" style="background-color: rgba(47, 158, 68, 0.2); color: var(--rpg-green);">
                        <i class="material-icons tiny">movie</i> ${data.campaign.stats.num_scenes} Scene(s)
                    </div>
                    <div class="chip" style="background-color: rgba(212, 175, 55, 0.2); color: var(--rpg-gold);">
                        <i class="material-icons tiny">people</i> ${data.campaign.stats.num_npcs} NPC(s)
                    </div>
                </div>
            `;

            content = accordionHtml;
        }
        else if (type === 'quest') {
            const quest = findById(data.quests, id);
            if (quest) {
                iconName = 'explore';
                title = `Quest: ${quest.name}`;
                // Store quest data for image rendering
                currentEntityData = quest;
                content = `
                    <div style="margin-bottom: 20px;">
                        <h6 style="color: var(--rpg-gold); margin-bottom: 8px;">
                            <i class="material-icons tiny">description</i> Description
                        </h6>
                        <p style="color: #b8b8d1; line-height: 1.7; white-space: pre-wrap;">${escapeHtml(quest.description)}</p>
                    </div>
                    ${quest.objectives.length > 0 ? `
                    <div style="margin-bottom: 20px;">
                        <h6 style="color: var(--rpg-gold); margin-bottom: 8px;">
                            <i class="material-icons tiny">task_alt</i> Objectives
                        </h6>
                        <ol style="margin: 0; padding-left: 20px;">
                            ${quest.objectives.map(obj => `<li style="color: #b8b8d1; margin-bottom: 6px;">${escapeHtml(obj)}</li>`).join('')}
                        </ol>
                    </div>` : ''}
                    ${quest.backstory ? `
                    <div style="margin-bottom: 20px;">
                        <h6 style="color: var(--rpg-gold); margin-bottom: 8px;">
                            <i class="material-icons tiny">history_edu</i> Backstory
                        </h6>
                        <p style="color: #b8b8d1; line-height: 1.7; white-space: pre-wrap;">${escapeHtml(quest.backstory)}</p>
                    </div>` : ''}
                    <div style="margin-top: 20px;">
                        <div class="chip" style="background-color: rgba(76, 110, 245, 0.2); color: var(--rpg-blue);">
                            <i class="material-icons tiny">place</i> ${quest.places.length} Place(s)
                        </div>
                        <div class="chip" style="background-color: rgba(212, 175, 55, 0.2); color: var(--rpg-gold);">
                            <i class="material-icons tiny">timer</i> ~${quest.estimated_duration_minutes} min
                        </div>
                        <div class="chip" style="background-color: rgba(255, 152, 0, 0.2); color: #ff9800;">
                            <i class="material-icons tiny">whatshot</i> ${quest.difficulty_level}
                        </div>
                    </div>
                `;
            }
        } else if (type === 'place') {
            const place = findPlace(data.quests, id);
            if (place) {
                iconName = 'place';
                title = `Place: ${place.name}`;
                // Store place data for image rendering
                currentEntityData = place;
                content = `
                    <div style="margin-bottom: 20px;">
                        <h6 style="color: var(--rpg-gold); margin-bottom: 8px;">
                            <i class="material-icons tiny">description</i> Description
                        </h6>
                        <p style="color: #b8b8d1; line-height: 1.7; white-space: pre-wrap;">${escapeHtml(place.description)}</p>
                    </div>
                    <div style="margin-top: 20px;">
                        <div class="chip" style="background-color: rgba(47, 158, 68, 0.2); color: var(--rpg-green);">
                            <i class="material-icons tiny">movie</i> ${place.scenes.length} Scene(s)
                        </div>
                    </div>
                `;
            }
        } else if (type === 'scene') {
            const scene = findScene(data.quests, id);
            if (scene) {
                iconName = 'movie';
                title = `Scene: ${scene.name}`;
                // Store scene data for image rendering
                currentEntityData = scene;

                // Build accordion content
                let accordionHtml = '<ul class="collapsible" style="border: none; box-shadow: none; margin-top: 20px;">';

                // Primary NPCs accordion
                if (scene.npcs && scene.npcs.length > 0) {
                    accordionHtml += `
                        <li class="active">
                            <div class="collapsible-header" style="background: rgba(212, 175, 55, 0.1); border-left: 3px solid var(--rpg-gold); display: flex; align-items: center; gap: 8px;">
                                <i class="material-icons" style="color: var(--rpg-gold);">people</i>
                                <span style="color: var(--rpg-gold); font-weight: 500;">Primary NPCs (${scene.npcs.length})</span>
                            </div>
                            <div class="collapsible-body" style="background: rgba(27, 27, 46, 0.5); border-left: 3px solid var(--rpg-gold); display: block;">
                                ${scene.npcs.map(npc => `
                                    <div style="background: rgba(212, 175, 55, 0.05); padding: 12px; margin-bottom: 12px; border-radius: 4px;">
                                        <div style="color: var(--rpg-gold); font-weight: 600; font-size: 1.1rem; margin-bottom: 4px;">
                                            ${escapeHtml(npc.name)}${npc.species_name ? ' - ' + escapeHtml(npc.species_name) : ''}
                                        </div>
                                        <div style="color: #b8b8d1; font-size: 0.9rem; font-style: italic;">
                                            ${escapeHtml(npc.role)}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </li>
                    `;
                }

                // Knowledge Entities accordion
                if (scene.knowledge && scene.knowledge.length > 0) {
                    accordionHtml += `
                        <li>
                            <div class="collapsible-header" style="background: rgba(156, 39, 176, 0.1); border-left: 3px solid var(--rpg-purple); display: flex; align-items: center; gap: 8px;">
                                <i class="material-icons" style="color: var(--rpg-purple);">school</i>
                                <span style="color: var(--rpg-purple); font-weight: 500;">Knowledge (${scene.knowledge.length})</span>
                            </div>
                            <div class="collapsible-body" style="background: rgba(27, 27, 46, 0.5); border-left: 3px solid var(--rpg-purple);">
                                ${scene.knowledge.map(knowledge => `
                                    <div style="background: rgba(156, 39, 176, 0.05); padding: 12px; margin-bottom: 12px; border-radius: 4px;">
                                        <div style="color: var(--rpg-purple); font-weight: 600; margin-bottom: 6px; display: flex; align-items: center; gap: 8px;">
                                            <span>${escapeHtml(knowledge.name)}</span>
                                            <span class="chip" style="background-color: rgba(156, 39, 176, 0.2); color: var(--rpg-purple); font-size: 0.75rem; height: 20px; line-height: 20px; padding: 0 8px;">${escapeHtml(knowledge.knowledge_type)}</span>
                                            <span class="chip" style="background-color: rgba(33, 150, 243, 0.2); color: #2196F3; font-size: 0.75rem; height: 20px; line-height: 20px; padding: 0 8px;">${escapeHtml(knowledge.primary_dimension)}</span>
                                        </div>
                                        <p style="color: #b8b8d1; line-height: 1.6; white-space: pre-wrap; margin-bottom: 8px;">${escapeHtml(knowledge.description)}</p>
                                        ${knowledge.acquisition_methods && knowledge.acquisition_methods.length > 0 ? `
                                        <div style="margin-top: 8px;">
                                            <strong style="color: var(--rpg-purple); font-size: 0.85rem;"><i class="material-icons tiny" style="vertical-align: middle;">school</i> How to Learn:</strong>
                                            <ul style="margin: 4px 0 0 20px; padding: 0;">
                                                ${knowledge.acquisition_methods.map(method => `<li style="color: #b8b8d1; font-size: 0.85rem;">${escapeHtml(method.display || method.type + ' (' + method.difficulty + ')')}</li>`).join('')}
                                            </ul>
                                        </div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </li>
                    `;
                }

                // Tools (Items) accordion
                if (scene.items && scene.items.length > 0) {
                    accordionHtml += `
                        <li>
                            <div class="collapsible-header" style="background: rgba(255, 193, 7, 0.1); border-left: 3px solid #FFC107; display: flex; align-items: center; gap: 8px;">
                                <i class="material-icons" style="color: #FFC107;">inventory_2</i>
                                <span style="color: #FFC107; font-weight: 500;">Tools (${scene.items.length})</span>
                            </div>
                            <div class="collapsible-body" style="background: rgba(27, 27, 46, 0.5); border-left: 3px solid #FFC107;">
                                ${scene.items.map(item => `
                                    <div style="background: rgba(255, 193, 7, 0.05); padding: 12px; margin-bottom: 12px; border-radius: 4px;">
                                        <div style="color: #FFC107; font-weight: 600; margin-bottom: 6px; display: flex; align-items: center; gap: 8px;">
                                            <span>${escapeHtml(item.name)}</span>
                                            <span class="chip" style="background-color: rgba(255, 193, 7, 0.2); color: #FFC107; font-size: 0.75rem; height: 20px; line-height: 20px; padding: 0 8px;">${escapeHtml(item.item_type)}</span>
                                            ${item.is_quest_critical ? `<span class="chip" style="background-color: rgba(244, 67, 54, 0.2); color: #f44336; font-size: 0.75rem; height: 20px; line-height: 20px; padding: 0 8px;">Quest Critical</span>` : ''}
                                        </div>
                                        <p style="color: #b8b8d1; line-height: 1.6; white-space: pre-wrap; margin-bottom: 8px;">${escapeHtml(item.description)}</p>
                                        ${item.acquisition_methods && item.acquisition_methods.length > 0 ? `
                                        <div style="margin-top: 8px;">
                                            <strong style="color: #FFC107; font-size: 0.85rem;"><i class="material-icons tiny" style="vertical-align: middle;">download</i> How to Get:</strong>
                                            <ul style="margin: 4px 0 0 20px; padding: 0;">
                                                ${item.acquisition_methods.map(method => `<li style="color: #b8b8d1; font-size: 0.85rem;">${escapeHtml(method.display || method.type + ' (' + method.difficulty + ')')}</li>`).join('')}
                                            </ul>
                                        </div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </li>
                    `;
                }

                // Evaluation Rubrics accordion
                if (scene.rubrics && scene.rubrics.length > 0) {
                    accordionHtml += `
                        <li>
                            <div class="collapsible-header" style="background: rgba(0, 150, 136, 0.1); border-left: 3px solid #009688; display: flex; align-items: center; gap: 8px;">
                                <i class="material-icons" style="color: #009688;">rule</i>
                                <span style="color: #009688; font-weight: 500;">Evaluation Rubrics (${scene.rubrics.length})</span>
                            </div>
                            <div class="collapsible-body" style="background: rgba(27, 27, 46, 0.5); border-left: 3px solid #009688;">
                                ${scene.rubrics.map(rubric => `
                                    <div style="background: rgba(0, 150, 136, 0.05); padding: 12px; margin-bottom: 12px; border-radius: 4px;">
                                        <div style="color: #009688; font-weight: 600; margin-bottom: 6px; display: flex; align-items: center; gap: 8px;">
                                            <span>${escapeHtml(rubric.interaction_name)}</span>
                                            <span class="chip" style="background-color: rgba(0, 150, 136, 0.2); color: #009688; font-size: 0.75rem; height: 20px; line-height: 20px; padding: 0 8px;">${escapeHtml(rubric.rubric_type)}</span>
                                            <span class="chip" style="background-color: rgba(103, 58, 183, 0.2); color: var(--rpg-purple); font-size: 0.75rem; height: 20px; line-height: 20px; padding: 0 8px;">${escapeHtml(rubric.primary_dimension)}</span>
                                        </div>
                                        ${rubric.evaluation_criteria && rubric.evaluation_criteria.length > 0 ? `
                                        <div style="margin-top: 8px;">
                                            <strong style="color: #009688; font-size: 0.85rem;"><i class="material-icons tiny" style="vertical-align: middle;">checklist</i> Evaluation Criteria:</strong>
                                            <ul style="margin: 4px 0 0 20px; padding: 0;">
                                                ${rubric.evaluation_criteria.map(criterion => `<li style="color: #b8b8d1; font-size: 0.85rem;">${escapeHtml(criterion.criterion)} (Weight: ${(criterion.weight * 100).toFixed(0)}%)</li>`).join('')}
                                            </ul>
                                        </div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </li>
                    `;
                }

                accordionHtml += '</ul>';

                // Location and Description sections (above accordions)
                content = `
                    <div style="margin-bottom: 20px;">
                        <h6 style="color: var(--rpg-gold); margin-bottom: 8px;">
                            <i class="material-icons tiny">place</i> Location
                        </h6>
                        <p style="color: #b8b8d1; line-height: 1.7;">${escapeHtml(scene.level_3_location_name)}</p>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <h6 style="color: var(--rpg-gold); margin-bottom: 8px;">
                            <i class="material-icons tiny">description</i> Description
                        </h6>
                        <p style="color: #b8b8d1; line-height: 1.7; white-space: pre-wrap;">${escapeHtml(scene.description)}</p>
                    </div>
                    ${accordionHtml}
                `;
            }
        }

        // Update the entire detail content area with proper layout
        const detailContentEl = document.getElementById('detail-content');

        if (type === 'campaign' || type === 'scene') {
            // Campaign/Scene layout: Title → Image (full width) → Content (stacked)
            const entityImageUrl = type === 'campaign'
                ? (data.campaign.primary_image_url || data.campaign.world_image_url)
                : currentEntityData?.primary_image_url;

            detailContentEl.innerHTML = `
                <h5 style="color: var(--rpg-gold); margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    <i class="material-icons">${iconName}</i> ${title}
                </h5>
                <div id="detail-image" style="margin-bottom: 20px; position: relative;">
                    ${entityImageUrl ?
                        `<img src="${entityImageUrl}" alt="${title}" style="width: 100%; max-width: 700px; height: auto; object-fit: cover; border-radius: 8px; border: 2px solid rgba(212, 175, 55, 0.3);">` :
                        `<div style="width: 100%; max-width: 700px; height: 300px; background: linear-gradient(135deg, rgba(27, 27, 46, 0.9) 0%, rgba(106, 90, 205, 0.2) 100%); border-radius: 8px; border: 2px solid rgba(212, 175, 55, 0.3); display: flex; align-items: center; justify-content: center;">
                            <i class="material-icons" style="font-size: 80px; color: var(--rpg-gold); opacity: 0.3;">${iconName}</i>
                        </div>`
                    }
                </div>
                <div id="detail-body">${content}</div>
            `;

            // Reinitialize Materialize collapsible for scenes with accordions
            if (type === 'scene') {
                const collapsibleElems = detailContentEl.querySelectorAll('.collapsible');
                M.Collapsible.init(collapsibleElems, {
                    accordion: true
                });
            } else {
                // Campaign
                const collapsibleElems = detailContentEl.querySelectorAll('.collapsible');
                M.Collapsible.init(collapsibleElems, {
                    accordion: true
                });
            }
        } else {
            // Quest/Place layout: Title → (Image left + Details right)
            const entityImageUrl = currentEntityData?.primary_image_url;

            detailContentEl.innerHTML = `
                <h5 style="color: var(--rpg-gold); margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    <i class="material-icons">${iconName}</i> ${title}
                </h5>
                <div style="display: flex; gap: 25px; margin-top: 20px;">
                    <div id="detail-image" style="flex-shrink: 0; position: relative; width: 250px; height: 250px;">
                        ${entityImageUrl ?
                            `<img src="${entityImageUrl}" alt="${title}" style="width: 250px; height: 250px; object-fit: cover; border-radius: 8px; border: 2px solid rgba(212, 175, 55, 0.3);">` :
                            `<div style="width: 250px; height: 250px; background: linear-gradient(135deg, rgba(27, 27, 46, 0.9) 0%, rgba(106, 90, 205, 0.2) 100%); border-radius: 8px; border: 2px solid rgba(212, 175, 55, 0.3); display: flex; align-items: center; justify-content: center;">
                                <i class="material-icons" style="font-size: 80px; color: var(--rpg-gold); opacity: 0.3;">${iconName}</i>
                            </div>`
                        }
                    </div>
                    <div id="detail-body" style="flex: 1;">${content}</div>
                </div>
            `;
        }
    }


    function findById(items, id) {
        return items.find(item => item.id === id);
    }

    function findPlace(quests, placeId) {
        for (const quest of quests) {
            const place = quest.places.find(p => p.id === placeId);
            if (place) return place;
        }
        return null;
    }

    function findScene(quests, sceneId) {
        for (const quest of quests) {
            for (const place of quest.places) {
                const scene = place.scenes.find(s => s.id === sceneId);
                if (scene) return scene;
            }
        }
        return null;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Image Generation System
    const imageGenModal = M.Modal.init(document.getElementById('imageGenerationModal'), {
        dismissible: false
    });

    // Image Viewer Modal
    const imageViewerModal = M.Modal.init(document.getElementById('imageViewerModal'), {
        dismissible: true
    });

    let currentImageContext = null; // Stores {type, campaignId, questId, placeId, sceneId}

    // Function to open image viewer
    function openImageViewer(imageSrc) {
        document.getElementById('viewer-image').src = imageSrc;
        imageViewerModal.open();
    }

    // Function to make images clickable
    function makeImageClickable(imageElement) {
        if (!imageElement || imageElement.tagName !== 'IMG') return;

        imageElement.style.cursor = 'pointer';
        imageElement.title = 'Click to view full size';

        imageElement.addEventListener('click', function(e) {
            // Don't trigger if clicking the generate button
            if (e.target.classList.contains('generate-image-btn')) return;

            openImageViewer(this.src);
        });
    }

    function showGenerateButton(imageContainer, context) {
        // Add generate button to image container
        const button = document.createElement('button');
        button.className = 'btn btn-small waves-effect waves-light generate-image-btn';
        button.style.cssText = `
            position: absolute;
            bottom: 15px;
            left: 15px;
            background: linear-gradient(135deg, var(--rpg-gold), #d4af37);
            color: #1a1a2e;
            font-weight: 600;
            font-size: 0.85rem;
            z-index: 10;
            box-shadow: 0 4px 8px rgba(212, 175, 55, 0.4);
            padding: 0 12px;
            height: 32px;
            line-height: 32px;
            border: 2px solid rgba(212, 175, 55, 0.6);
            transition: all 0.3s ease;
        `;
        button.innerHTML = '<i class="material-icons left" style="font-size: 1rem; margin-right: 4px;">auto_awesome</i>Generate';
        button.title = 'Generate / Regenerate Image';

        // Add hover effect
        button.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.05)';
            this.style.boxShadow = '0 6px 12px rgba(212, 175, 55, 0.6)';
        });
        button.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
            this.style.boxShadow = '0 4px 8px rgba(212, 175, 55, 0.4)';
        });

        button.addEventListener('click', function(e) {
            e.stopPropagation();
            openImageGenerationModal(context);
        });

        // Make container relative if not already
        imageContainer.style.position = 'relative';
        imageContainer.appendChild(button);
    }

    function openImageGenerationModal(context) {
        currentImageContext = context;

        // Reset modal state
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('preview-state').style.display = 'none';
        document.getElementById('error-state').style.display = 'none';
        document.getElementById('generate-another-btn').style.display = 'none';
        document.getElementById('save-image-btn').style.display = 'none';

        // Set title
        const titles = {
            'campaign': 'Generate Campaign Image',
            'quest': 'Generate Quest Image',
            'place': 'Generate Place Image',
            'scene': 'Generate Scene Image'
        };
        document.getElementById('modal-title').textContent = titles[context.type] || 'Generate Image';

        imageGenModal.open();

        // Start generation immediately
        generateImage(context);
    }

    async function generateImage(context) {
        // Show loading
        document.getElementById('loading-state').style.display = 'block';
        document.getElementById('preview-state').style.display = 'none';
        document.getElementById('error-state').style.display = 'none';
        document.getElementById('generate-another-btn').style.display = 'none';
        document.getElementById('save-image-btn').style.display = 'none';

        try {
            // Build URL based on context
            let url = `/campaigns/${context.campaignId}/generate-image/`;
            if (context.type === 'quest') {
                url = `/campaigns/${context.campaignId}/quests/${context.questId}/generate-image/`;
            } else if (context.type === 'place') {
                url = `/campaigns/${context.campaignId}/quests/${context.questId}/places/${context.placeId}/generate-image/`;
            } else if (context.type === 'scene') {
                url = `/campaigns/${context.campaignId}/quests/${context.questId}/places/${context.placeId}/scenes/${context.sceneId}/generate-image/`;
            }

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });

            const result = await response.json();

            if (result.success) {
                // Show preview
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('preview-state').style.display = 'block';
                document.getElementById('preview-image').src = result.image_url;
                document.getElementById('generate-another-btn').style.display = 'inline-block';
                document.getElementById('save-image-btn').style.display = 'inline-block';
            } else {
                throw new Error(result.error || 'Failed to generate image');
            }
        } catch (error) {
            console.error('Image generation error:', error);
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('error-state').style.display = 'block';
            document.getElementById('error-message').textContent = error.message || 'Failed to generate image. Please try again.';
            document.getElementById('close-btn').style.display = 'inline-block';
        }
    }

    // Generate Another button
    document.getElementById('generate-another-btn').addEventListener('click', function() {
        if (currentImageContext) {
            generateImage(currentImageContext);
        }
    });

    // Save Image button
    document.getElementById('save-image-btn').addEventListener('click', async function() {
        const previewUrl = document.getElementById('preview-image').src;

        // Build URL for set-primary-image endpoint
        let setPrimaryUrl = `/campaigns/${currentImageContext.campaignId}/set-primary-image/`;
        if (currentImageContext.type === 'quest') {
            setPrimaryUrl = `/campaigns/${currentImageContext.campaignId}/quests/${currentImageContext.questId}/set-primary-image/`;
        } else if (currentImageContext.type === 'place') {
            setPrimaryUrl = `/campaigns/${currentImageContext.campaignId}/quests/${currentImageContext.questId}/places/${currentImageContext.placeId}/set-primary-image/`;
        } else if (currentImageContext.type === 'scene') {
            setPrimaryUrl = `/campaigns/${currentImageContext.campaignId}/quests/${currentImageContext.questId}/places/${currentImageContext.placeId}/scenes/${currentImageContext.sceneId}/set-primary-image/`;
        }

        try {
            // Save to database
            const response = await fetch(setPrimaryUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ image_url: previewUrl })
            });

            const result = await response.json();

            if (result.success) {
                // Update the actual image in the detail view
                const imageInView = document.querySelector('#detail-image img, #detail-image > div');
                if (imageInView) {
                    if (imageInView.tagName === 'IMG') {
                        imageInView.src = previewUrl;
                        // Make sure it's clickable
                        makeImageClickable(imageInView);
                    } else {
                        // Replace placeholder with actual image
                        const newImg = document.createElement('img');
                        newImg.src = previewUrl;
                        newImg.alt = 'Generated Image';

                        // Use appropriate style based on entity type
                        if (currentImageContext.type === 'campaign' || currentImageContext.type === 'scene') {
                            // Campaign and Scene use full-width format
                            newImg.style.cssText = 'width: 100%; max-width: 700px; height: auto; object-fit: cover; border-radius: 8px; border: 2px solid rgba(212, 175, 55, 0.3);';
                        } else {
                            // Quest/Place use square format
                            newImg.style.cssText = 'width: 250px; height: 250px; object-fit: cover; border-radius: 8px; border: 2px solid rgba(212, 175, 55, 0.3);';
                        }

                        imageInView.parentNode.replaceChild(newImg, imageInView);
                        // Make new image clickable
                        makeImageClickable(newImg);
                    }
                }

                // Update the data structure so image persists across navigation
                if (currentImageContext.type === 'campaign') {
                    data.campaign.primary_image_url = previewUrl;
                } else if (currentImageContext.type === 'quest') {
                    const quest = data.quests.find(q => q.id === currentImageContext.questId);
                    if (quest) quest.primary_image_url = previewUrl;
                } else if (currentImageContext.type === 'place') {
                    const place = findPlace(data.quests, currentImageContext.placeId);
                    if (place) place.primary_image_url = previewUrl;
                } else if (currentImageContext.type === 'scene') {
                    const scene = findScene(data.quests, currentImageContext.sceneId);
                    if (scene) scene.primary_image_url = previewUrl;
                }

                M.toast({html: 'Image saved successfully!', classes: 'green'});
                imageGenModal.close();
            } else {
                throw new Error(result.error || 'Failed to save image');
            }
        } catch (error) {
            console.error('Error saving image:', error);
            M.toast({html: 'Failed to save image: ' + error.message, classes: 'red'});
        }
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Add generate buttons to existing images after displayDetails is called
    const originalDisplayDetails = displayDetails;
    displayDetails = function(type, id, data) {
        originalDisplayDetails(type, id, data);

        // Wait for DOM to update
        setTimeout(() => {
            const imageContainer = document.getElementById('detail-image');
            if (imageContainer) {
                // Remove existing button if any
                const existingBtn = imageContainer.querySelector('.generate-image-btn');
                if (existingBtn) existingBtn.remove();

                // Make image clickable for full-size viewing
                const imageEl = imageContainer.querySelector('img');
                if (imageEl) {
                    makeImageClickable(imageEl);
                }

                // Build context for this view
                let context = { type, campaignId: data.campaign.id };

                if (type === 'quest') {
                    const quest = data.quests.find(q => q.id === id);
                    if (quest) context.questId = id;
                } else if (type === 'place') {
                    for (const quest of data.quests) {
                        const place = quest.places.find(p => p.id === id);
                        if (place) {
                            context.questId = quest.id;
                            context.placeId = id;
                            break;
                        }
                    }
                } else if (type === 'scene') {
                    for (const quest of data.quests) {
                        for (const place of quest.places) {
                            const scene = place.scenes.find(s => s.id === id);
                            if (scene) {
                                context.questId = quest.id;
                                context.placeId = place.id;
                                context.sceneId = id;
                                break;
                            }
                        }
                        if (context.sceneId) break;
                    }
                }

                showGenerateButton(imageContainer, context);
            }
        }, 100);
    };

    // Add initial generate button for campaign view
    setTimeout(() => {
        const imageContainer = document.getElementById('detail-image');
        if (imageContainer) {
            // Make initial image clickable
            const imageEl = imageContainer.querySelector('img');
            if (imageEl) {
                makeImageClickable(imageEl);
            }

            showGenerateButton(imageContainer, {
                type: 'campaign',
                campaignId: data.campaign.id
            });
        }
    }, 500);
});
</script>
{% endblock %}
