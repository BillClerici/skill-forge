{% extends "base.html" %}
{% load static %}

{% block title %}Campaign Design Wizard - SkillForge RPG{% endblock %}

{% block content %}
<div class="row">
    <div class="col s12">
        <h3 style="color: var(--rpg-gold); text-shadow: 0 0 10px rgba(212, 175, 55, 0.3);">
            <i class="material-icons left" style="font-size: 2.5rem;">auto_awesome</i>
            Campaign Design Wizard
        </h3>
    </div>
</div>

<!-- In-Progress Campaign Banner -->
<div id="in-progress-banner" class="card" style="display: none; margin-bottom: 20px; background: rgba(212, 175, 55, 0.1); border: 2px solid var(--rpg-gold);">
    <div class="card-content" style="padding: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; gap: 20px;">
            <div style="flex: 1;">
                <h6 style="color: var(--rpg-gold); margin: 0 0 10px 0;">
                    <i class="material-icons left" style="font-size: 1.5rem;">pending_actions</i>
                    Campaign Generation In Progress
                </h6>
                <p style="color: #b8b8d1; margin: 0; font-size: 0.95rem;">
                    <strong id="in-progress-campaign-name" style="color: var(--rpg-gold);"></strong>
                </p>
                <p style="color: var(--rpg-silver); margin: 5px 0 0 0; font-size: 0.85rem;">
                    <i class="material-icons tiny" style="vertical-align: middle;">hub</i>
                    <span id="in-progress-universe"></span>
                    <i class="material-icons tiny" style="vertical-align: middle; margin-left: 10px;">public</i>
                    <span id="in-progress-world"></span>
                </p>
                <div style="margin-top: 10px;">
                    <div class="progress" style="height: 8px; background: rgba(27, 27, 46, 0.6);">
                        <div id="in-progress-bar" class="determinate" style="width: 0%; background: linear-gradient(90deg, var(--rpg-purple), var(--rpg-gold));"></div>
                    </div>
                    <p style="color: var(--rpg-silver); margin: 5px 0 0 0; font-size: 0.85rem;">
                        <span id="in-progress-percentage">0%</span> complete - <span id="in-progress-status"></span>
                    </p>
                </div>
            </div>
            <div style="flex-shrink: 0;">
                <button type="button" id="resume-campaign-btn" class="btn waves-effect waves-light" style="background-color: var(--rpg-purple);">
                    <i class="material-icons left">play_arrow</i>View Progress
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Wizard Layout with Left Sidebar -->
<div class="row">
    <!-- Left Sidebar Navigation -->
    <div class="col s12 m4 l3">
        <div class="wizard-sidebar" style="position: sticky; top: 20px;">
            <div class="card" style="background: rgba(27, 27, 46, 0.6);">
                <div class="card-content" style="padding: 12px;">
                    <h6 style="color: var(--rpg-gold); margin-top: 0; margin-bottom: 15px; font-size: 0.85rem;">
                        <i class="material-icons tiny" style="vertical-align: middle;">list</i> Steps
                    </h6>

                    <nav id="wizard-nav" style="min-height: 500px; max-height: calc(100vh - 180px); overflow-y: auto;">
                        <div class="nav-step active" data-step="1">
                            <div class="nav-step-number">1</div>
                            <div class="nav-step-label">Universe</div>
                        </div>
                        <div class="nav-step" data-step="2">
                            <div class="nav-step-number">2</div>
                            <div class="nav-step-label">World</div>
                        </div>
                        <div class="nav-step" data-step="3">
                            <div class="nav-step-number">3</div>
                            <div class="nav-step-label">Region</div>
                        </div>
                        <div class="nav-step" data-step="4">
                            <div class="nav-step-number">4</div>
                            <div class="nav-step-label">Story Idea</div>
                        </div>
                        <div class="nav-step" data-step="5">
                            <div class="nav-step-number">5</div>
                            <div class="nav-step-label">Select Story</div>
                        </div>
                        <div class="nav-step" data-step="6">
                            <div class="nav-step-number">6</div>
                            <div class="nav-step-label">Campaign Core</div>
                        </div>
                        <div class="nav-step" data-step="7">
                            <div class="nav-step-number">7</div>
                            <div class="nav-step-label">Quest Settings</div>
                        </div>
                        <div class="nav-step" data-step="8">
                            <div class="nav-step-number">8</div>
                            <div class="nav-step-label">Review Quests</div>
                        </div>
                        <div class="nav-step" data-step="9">
                            <div class="nav-step-number">9</div>
                            <div class="nav-step-label">Review Places</div>
                        </div>
                        <div class="nav-step" data-step="10">
                            <div class="nav-step-number">10</div>
                            <div class="nav-step-label">Review Scenes</div>
                        </div>
                        <div class="nav-step" data-step="11">
                            <div class="nav-step-number">11</div>
                            <div class="nav-step-label">Finalize</div>
                        </div>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="col s12 m8 l9">
<form id="wizard-form">
    {% csrf_token %}

    <!-- Step 1: Campaign Name & Universe Selection -->
    <div class="wizard-step" data-step="1">
        <div class="card hoverable">
            <div class="card-content">
                <span class="card-title" style="color: var(--rpg-gold);">
                    <i class="material-icons left">hub</i>Campaign Name & Universe
                </span>

                <p style="color: #b8b8d1; margin-bottom: 20px;">
                    Name your campaign and choose the universe where it will take place.
                </p>

                <!-- Campaign Name Input -->
                <div class="input-field" style="margin-bottom: 30px;">
                    <i class="material-icons prefix" style="color: var(--rpg-gold);">edit</i>
                    <input type="text" id="campaign_name" name="campaign_name" required
                           placeholder="Enter a memorable campaign name..."
                           maxlength="100">
                    <label for="campaign_name">Campaign Name *</label>
                    <span class="helper-text" style="color: #b8b8d1;">Give your campaign a unique and memorable name</span>
                </div>

                <div class="divider" style="margin: 30px 0; background-color: rgba(212, 175, 55, 0.2);"></div>

                <h6 style="color: var(--rpg-gold); margin-bottom: 20px;">
                    <i class="material-icons left" style="font-size: 1.2rem;">hub</i>Select Universe
                </h6>

                <p style="color: #b8b8d1; margin-bottom: 20px;">
                    Choose the universe where your campaign will take place.
                </p>

                <div id="universe-list">
                    {% for universe in universes %}
                    <label class="universe-card">
                        <input type="radio" name="universe_id" value="{{ universe.id }}" data-name="{{ universe.universe_name }}" required>
                        <div class="universe-content">
                            <h6 style="color: var(--rpg-gold); margin: 0;">{{ universe.universe_name }}</h6>
                            <p style="color: #b8b8d1; font-size: 0.9rem; margin-top: 10px;">
                                {{ universe.description|default:"A vast universe awaits exploration." }}
                            </p>
                        </div>
                    </label>
                    {% empty %}
                    <p style="color: var(--rpg-silver);">No universes available. Please create a universe first.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Step 2: World Selection -->
    <div class="wizard-step" data-step="2" style="display: none;">
        <div class="card hoverable">
            <div class="card-content">
                <span class="card-title" style="color: var(--rpg-gold);">
                    <i class="material-icons left">public</i>Select World
                </span>

                <p style="color: #b8b8d1; margin-bottom: 20px;">
                    Select a world from <span id="selected-universe-name" style="color: var(--rpg-gold);"></span>.
                </p>

                <div class="input-field">
                    <i class="material-icons prefix" style="color: var(--rpg-gold);">search</i>
                    <input type="text" id="world-search" placeholder="Search worlds...">
                    <label for="world-search">Search Worlds</label>
                </div>

                <div id="world-list" style="margin-top: 20px;">
                    <!-- Dynamically populated via JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Step 3: Region Selection -->
    <div class="wizard-step" data-step="3" style="display: none;">
        <div class="card hoverable">
            <div class="card-content">
                <span class="card-title" style="color: var(--rpg-gold);">
                    <i class="material-icons left">map</i>Select Region
                </span>

                <p style="color: #b8b8d1; margin-bottom: 20px;">
                    Choose a specific region for your campaign in <span id="selected-world-name" style="color: var(--rpg-gold);"></span>.
                </p>

                <div id="region-list">
                    <label class="region-card">
                        <input type="radio" name="region_id" value="" checked>
                        <div class="region-content">
                            <strong style="color: var(--rpg-silver);">Entire World</strong>
                            <p style="color: #b8b8d1; font-size: 0.9rem; margin-top: 5px;">
                                Campaign spans the entire world
                            </p>
                        </div>
                    </label>
                    <!-- Regions populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Step 4: Story Idea Input (OPTIONAL) -->
    <div class="wizard-step" data-step="4" style="display: none;">
        <div class="card hoverable">
            <div class="card-content">
                <span class="card-title" style="color: var(--rpg-gold);">
                    <i class="material-icons left">edit_note</i>Campaign Story Idea (Optional)
                </span>

                <p style="color: #b8b8d1; margin-bottom: 20px;">
                    Describe your campaign story idea, or leave blank to let the AI generate ideas based on your selected world and genre.
                </p>

                <div class="input-field">
                    <textarea id="user_story_idea" name="user_story_idea" class="materialize-textarea"
                        rows="6"
                        placeholder="Optional: Describe your campaign vision, key conflicts, themes, or story beats you want to explore..."></textarea>
                    <label for="user_story_idea">Your Story Idea</label>
                </div>

                <div style="margin-top: 20px; padding: 15px; background: rgba(212, 175, 55, 0.1); border-left: 3px solid var(--rpg-gold); border-radius: 4px;">
                    <p style="color: var(--rpg-gold); margin: 0;">
                        <i class="material-icons tiny" style="vertical-align: middle;">lightbulb</i>
                        <strong>Tip:</strong> The AI will generate 3 unique story ideas. Providing input here helps guide the generation.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 5: Story Selection (AI Generated) -->
    <div class="wizard-step" data-step="5" style="display: none;">
        <div class="card hoverable">
            <div class="card-content">
                <span class="card-title" style="color: var(--rpg-gold);">
                    <i class="material-icons left">auto_stories</i>Select Your Story
                </span>

                <p style="color: #b8b8d1; margin-bottom: 20px;">
                    Choose one of these AI-generated story ideas, or regenerate for new options.
                </p>

                <div id="story-ideas-container">
                    <!-- Story ideas populated here -->
                    <div class="center-align" style="padding: 40px;">
                        <div class="preloader-wrapper active">
                            <div class="spinner-layer spinner-blue-only">
                                <div class="circle-clipper left"><div class="circle"></div></div>
                                <div class="gap-patch"><div class="circle"></div></div>
                                <div class="circle-clipper right"><div class="circle"></div></div>
                            </div>
                        </div>
                        <p style="color: var(--rpg-silver); margin-top: 20px;">Generating story ideas...</p>
                    </div>
                </div>

                <div class="row" style="margin-top: 30px;">
                    <div class="col s12 center-align">
                        <button type="button" id="modify-story-btn" class="btn waves-effect waves-light" style="background-color: var(--rpg-silver); display: none;">
                            <i class="material-icons left">edit</i>Modify Story Idea & Regenerate
                        </button>
                        <button type="button" id="regenerate-stories-btn" class="btn waves-effect waves-light" style="background-color: var(--rpg-purple); margin-left: 10px; display: none;">
                            <i class="material-icons left">refresh</i>Generate 3 New Ideas
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 6: Campaign Core Review & Approval -->
    <div class="wizard-step" data-step="6" style="display: none;">
        <div class="card hoverable">
            <div class="card-content">
                <span class="card-title" style="color: var(--rpg-gold);">
                    <i class="material-icons left">dashboard</i>Campaign Core
                </span>

                <p style="color: #b8b8d1; margin-bottom: 20px;">
                    Review the generated campaign foundation. You can modify these before continuing.
                </p>

                <div id="campaign-core-container">
                    <!-- Campaign core populated here -->
                    <div class="center-align" style="padding: 40px;">
                        <div class="preloader-wrapper active">
                            <div class="spinner-layer spinner-blue-only">
                                <div class="circle-clipper left"><div class="circle"></div></div>
                                <div class="gap-patch"><div class="circle"></div></div>
                                <div class="circle-clipper right"><div class="circle"></div></div>
                            </div>
                        </div>
                        <p style="color: var(--rpg-silver); margin-top: 20px;">Generating campaign core...</p>
                    </div>
                </div>

                <!-- Bloom's Taxonomy Info -->
                <div class="blooms-section" style="margin-top: 30px; padding: 20px; background: rgba(106, 90, 205, 0.1); border-left: 3px solid var(--rpg-purple); border-radius: 4px; display: none;" id="blooms-info">
                    <h6 style="color: var(--rpg-purple); margin-top: 0;">
                        <i class="material-icons left">psychology</i>Bloom's Taxonomy Integration
                    </h6>
                    <p style="color: #b8b8d1; font-size: 0.9rem;">
                        This campaign will challenge players at multiple cognitive levels:
                    </p>
                    <ul style="color: #b8b8d1; font-size: 0.9rem;">
                        <li><strong>Remembering:</strong> Recall world lore, NPC names, and quest details</li>
                        <li><strong>Understanding:</strong> Comprehend storylines, motivations, and relationships</li>
                        <li><strong>Applying:</strong> Use knowledge and items to progress through challenges</li>
                        <li><strong>Analyzing:</strong> Break down complex problems and discover hidden connections</li>
                        <li><strong>Evaluating:</strong> Make judgment calls that affect quest outcomes</li>
                        <li><strong>Creating:</strong> Develop unique strategies and solve open-ended challenges</li>
                    </ul>
                    <p style="color: var(--rpg-purple); font-size: 0.85rem; margin-bottom: 0;">
                        <i class="material-icons tiny">info</i> During gameplay, the AI will dynamically adjust challenge difficulty based on each character's cognitive maturity level.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 7: Quest Settings -->
    <div class="wizard-step" data-step="7" style="display: none;">
        <div class="card hoverable">
            <div class="card-content">
                <span class="card-title" style="color: var(--rpg-gold);">
                    <i class="material-icons left">assignment</i>Quest Configuration
                </span>

                <p style="color: #b8b8d1; margin-bottom: 30px;">
                    Configure your campaign's quests.
                </p>

                <div class="row">
                    <div class="col s12 m6">
                        <div style="padding: 20px;">
                            <p style="color: var(--rpg-gold); margin-bottom: 10px; margin-top: 0;">
                                <strong>Number of Quests: <span id="quest-count-display">5</span></strong>
                            </p>
                            <input type="range" id="num_quests" name="num_quests" min="1" max="10" value="5" step="1">
                        </div>
                    </div>

                    <div class="col s12 m6">
                        <div class="input-field">
                            <select id="quest_difficulty" name="quest_difficulty">
                                <option value="Easy">Easy</option>
                                <option value="Medium" selected>Medium</option>
                                <option value="Hard">Hard</option>
                                <option value="Expert">Expert</option>
                            </select>
                            <label for="quest_difficulty">Difficulty Level</label>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col s12 m6">
                        <div class="input-field">
                            <input type="number" id="quest_playtime_minutes" name="quest_playtime_minutes"
                                value="90" min="15" max="480" step="15">
                            <label for="quest_playtime_minutes">Estimated Play Time per Quest (minutes)</label>
                        </div>
                    </div>

                    <div class="col s12 m6" style="padding-top: 20px;">
                        <p>
                            <label>
                                <input type="checkbox" id="generate_images_quests" name="generate_images_quests" checked>
                                <span style="color: #b8b8d1;">Generate quest images now</span>
                            </label>
                        </p>
                        <p style="color: var(--rpg-silver); font-size: 0.85rem; margin-left: 25px;">
                            You can generate images later from the campaign detail page
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 8: Quest Review -->
    <div class="wizard-step" data-step="8" style="display: none;">
        <div class="card hoverable">
            <div class="card-content">
                <span class="card-title" style="color: var(--rpg-gold);">
                    <i class="material-icons left">checklist</i>Review Quests
                </span>

                <p style="color: #b8b8d1; margin-bottom: 20px;">
                    Review the generated quests. Quests are sequential and build upon each other to tell your campaign story.
                </p>

                <div id="quests-review-container">
                    <!-- Quests populated here -->
                    <div class="center-align" style="padding: 40px;">
                        <div class="preloader-wrapper active">
                            <div class="spinner-layer spinner-blue-only">
                                <div class="circle-clipper left"><div class="circle"></div></div>
                                <div class="gap-patch"><div class="circle"></div></div>
                                <div class="circle-clipper right"><div class="circle"></div></div>
                            </div>
                        </div>
                        <p style="color: var(--rpg-silver); margin-top: 20px;">Generating quests...</p>
                    </div>
                </div>

                <div class="row" style="margin-top: 30px;">
                    <div class="col s12 center-align">
                        <button type="button" id="regenerate-quests-btn" class="btn waves-effect waves-light" style="background-color: var(--rpg-silver); display: none;">
                            <i class="material-icons left">refresh</i>Regenerate Quests
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 9: Place Review -->
    <div class="wizard-step" data-step="9" style="display: none;">
        <div class="card hoverable">
            <div class="card-content">
                <span class="card-title" style="color: var(--rpg-gold);">
                    <i class="material-icons left">place</i>Review Places (Level 2 Locations)
                </span>

                <p style="color: #b8b8d1; margin-bottom: 20px;">
                    Review the Places (Level 2 Locations) associated with each Quest.
                </p>

                <div id="places-review-container">
                    <!-- Places populated here -->
                    <div class="center-align" style="padding: 40px;">
                        <div class="preloader-wrapper active">
                            <div class="spinner-layer spinner-blue-only">
                                <div class="circle-clipper left"><div class="circle"></div></div>
                                <div class="gap-patch"><div class="circle"></div></div>
                                <div class="circle-clipper right"><div class="circle"></div></div>
                            </div>
                        </div>
                        <p style="color: var(--rpg-silver); margin-top: 20px;">Generating places...</p>
                    </div>
                </div>

                <div id="new-locations-created-l2" class="new-locations-section" style="display: none; margin-top: 20px; padding: 15px; background: rgba(47, 158, 68, 0.1); border-left: 3px solid var(--rpg-green); border-radius: 4px;">
                    <h6 style="color: var(--rpg-green); margin-top: 0;">
                        <i class="material-icons left">add_location</i>New Locations Created
                    </h6>
                    <p style="color: #b8b8d1; font-size: 0.9rem;">
                        The following Level 2 locations were automatically generated for this campaign:
                    </p>
                    <ol id="new-locations-list-l2" style="color: #b8b8d1; font-size: 0.9rem;"></ol>
                    <p style="color: var(--rpg-green); font-size: 0.85rem; margin-bottom: 0;">
                        <i class="material-icons tiny">info</i> These locations are now part of your world and can be reused in future campaigns.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 10: Scene Review -->
    <div class="wizard-step" data-step="10" style="display: none;">
        <div class="card hoverable">
            <div class="card-content">
                <span class="card-title" style="color: var(--rpg-gold);">
                    <i class="material-icons left">movie</i>Review Scenes (Level 3 Locations)
                </span>

                <p style="color: #b8b8d1; margin-bottom: 20px;">
                    Review the Scenes (Level 3 Locations). Scenes can be experienced in any order but support the Quest storyline.
                </p>

                <div id="scenes-review-container">
                    <!-- Scenes populated here -->
                    <div class="center-align" style="padding: 40px;">
                        <div class="preloader-wrapper active">
                            <div class="spinner-layer spinner-blue-only">
                                <div class="circle-clipper left"><div class="circle"></div></div>
                                <div class="gap-patch"><div class="circle"></div></div>
                                <div class="circle-clipper right"><div class="circle"></div></div>
                            </div>
                        </div>
                        <p style="color: var(--rpg-silver); margin-top: 20px;">Generating scenes with NPCs, challenges, events, and discoveries...</p>
                    </div>
                </div>

                <div id="new-locations-created-l3" class="new-locations-section" style="display: none; margin-top: 20px; padding: 15px; background: rgba(47, 158, 68, 0.1); border-left: 3px solid var(--rpg-green); border-radius: 4px;">
                    <h6 style="color: var(--rpg-green); margin-top: 0;">
                        <i class="material-icons left">add_location</i>New Locations Created
                    </h6>
                    <p style="color: #b8b8d1; font-size: 0.9rem;">
                        The following Level 3 locations were automatically generated for scenes:
                    </p>
                    <ol id="new-locations-list-l3" style="color: #b8b8d1; font-size: 0.9rem;"></ol>
                    <p style="color: var(--rpg-green); font-size: 0.85rem; margin-bottom: 0;">
                        <i class="material-icons tiny">info</i> These scene locations are now part of your world.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 11: Final Review -->
    <div class="wizard-step" data-step="11" style="display: none;">
        <div class="card hoverable">
            <div class="card-content">
                <span class="card-title" style="color: var(--rpg-gold);">
                    <i class="material-icons left">preview</i>Final Review & Generate
                </span>

                <p style="color: #b8b8d1; margin-bottom: 30px;">
                    Review your complete campaign configuration before final generation.
                </p>

                <div id="final-review-content" style="padding: 20px; background: rgba(27, 27, 46, 0.4); border-radius: 8px;">
                    <div class="review-section">
                        <strong style="color: var(--rpg-gold);">Campaign Name:</strong>
                        <p id="final-review-campaign-name" style="color: #b8b8d1;"></p>
                    </div>

                    <div class="review-section">
                        <strong style="color: var(--rpg-gold);">Universe:</strong>
                        <p id="final-review-universe" style="color: #b8b8d1;"></p>
                    </div>

                    <div class="review-section">
                        <strong style="color: var(--rpg-gold);">World:</strong>
                        <p id="final-review-world" style="color: #b8b8d1;"></p>
                    </div>

                    <div class="review-section">
                        <strong style="color: var(--rpg-gold);">Region:</strong>
                        <p id="final-review-region" style="color: #b8b8d1;"></p>
                    </div>

                    <div class="review-section">
                        <strong style="color: var(--rpg-gold);">Selected Story:</strong>
                        <p id="final-review-story" style="color: #b8b8d1;"></p>
                    </div>

                    <div class="review-section">
                        <strong style="color: var(--rpg-gold);">Quest Configuration:</strong>
                        <p id="final-review-quests" style="color: #b8b8d1;"></p>
                    </div>

                    <div class="review-section">
                        <strong style="color: var(--rpg-gold);">Campaign Summary:</strong>
                        <p id="final-review-summary" style="color: #b8b8d1;"></p>
                    </div>
                </div>

                <div style="margin-top: 30px; padding: 15px; background: rgba(47, 158, 68, 0.1); border-left: 3px solid var(--rpg-green); border-radius: 4px;">
                    <p style="color: var(--rpg-green); margin: 0;">
                        <i class="material-icons tiny" style="vertical-align: middle;">check_circle</i>
                        <strong>Ready to finalize!</strong> All elements have been generated and reviewed.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Buttons -->
    <div class="row" style="margin-top: 30px;">
        <div class="col s12 center-align">
            <button type="button" id="prev-btn" class="btn-large waves-effect waves-light" style="background-color: var(--rpg-silver); display: none;">
                <i class="material-icons left">chevron_left</i>Previous
            </button>
            <button type="button" id="next-btn" class="btn-large waves-effect waves-light" style="background-color: var(--rpg-purple); margin-left: 10px;">
                Next<i class="material-icons right">chevron_right</i>
            </button>
            <button type="button" id="generate-stories-btn" class="btn-large waves-effect waves-light" style="background-color: var(--rpg-green); margin-left: 10px; display: none;">
                <i class="material-icons left">auto_awesome</i>Generate Campaign Ideas
            </button>
            <button type="button" id="finalize-btn" class="btn-large waves-effect waves-light" style="background-color: var(--rpg-green); display: none;">
                <i class="material-icons left">done_all</i>Finalize Campaign
            </button>
        </div>
    </div>
</form>
    </div><!-- Close col s12 m8 l9 -->
</div><!-- Close row -->

<!-- Enhanced Loading Overlay with Phase Tracking -->
<div id="loading-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 9999; justify-content: center; align-items: center;">
    <div class="loading-dialog-box">
        <!-- Dialog Header -->
        <div class="loading-dialog-header">
            <i class="material-icons" style="margin-right: 10px;">auto_awesome</i>
            <span style="flex: 1;">Campaign Generation Progress</span>
            <button type="button" id="close-loading-overlay-btn" class="btn-flat" style="color: var(--rpg-silver); min-width: auto; padding: 0 10px;" title="Close overlay and view wizard screens">
                <i class="material-icons">close</i>
            </button>
        </div>

        <!-- Dialog Content -->
        <div class="loading-dialog-content">
            <div class="progress-phases" style="margin-bottom: 30px;">
                <div class="phase-step" data-phase="story" style="margin-bottom: 15px;">
                    <i class="material-icons phase-icon">pending</i>
                    <span class="phase-label">Story Ideas</span>
                </div>
                <div class="phase-step" data-phase="core" style="margin-bottom: 15px;">
                    <i class="material-icons phase-icon">pending</i>
                    <span class="phase-label">Campaign Core</span>
                </div>
                <div class="phase-step" data-phase="quests" style="margin-bottom: 15px;">
                    <i class="material-icons phase-icon">pending</i>
                    <span class="phase-label">Quests</span>
                </div>
                <div class="phase-step" data-phase="places" style="margin-bottom: 15px;">
                    <i class="material-icons phase-icon">pending</i>
                    <span class="phase-label">Places</span>
                </div>
                <div class="phase-step" data-phase="scenes" style="margin-bottom: 15px;">
                    <i class="material-icons phase-icon">pending</i>
                    <span class="phase-label">Scenes & Elements</span>
                </div>
                <div class="phase-step" data-phase="finalize" style="margin-bottom: 15px;">
                    <i class="material-icons phase-icon">pending</i>
                    <span class="phase-label">Finalizing</span>
                </div>
            </div>

            <!-- Animated Progress Bar -->
            <div class="progress-bar-container">
                <div class="progress-bar-fill" id="progress-bar-fill"></div>
                <div class="progress-bar-shine"></div>
            </div>

            <!-- Overall Progress & Step Progress Display -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px; padding: 0 20px;">
                <div style="flex: 1; text-align: left;">
                    <p style="color: var(--rpg-silver); font-size: 0.85rem; margin: 0;">Overall Progress</p>
                    <p style="color: var(--rpg-gold); font-size: 1.8rem; font-weight: bold; margin: 5px 0 0 0;">
                        <span id="overall-progress-percentage">0</span>%
                    </p>
                </div>
                <div style="flex: 1; text-align: center; padding: 0 20px;">
                    <p style="color: var(--rpg-silver); font-size: 0.85rem; margin: 0;">
                        <i class="material-icons tiny" style="vertical-align: middle;">schedule</i> Time Elapsed
                    </p>
                    <p style="color: #b8b8d1; font-size: 1.2rem; font-weight: bold; margin: 5px 0 0 0;">
                        <span id="elapsed-timer">00:00</span>
                    </p>
                </div>
                <div style="flex: 1; text-align: right;">
                    <p style="color: var(--rpg-silver); font-size: 0.85rem; margin: 0;">Step Progress</p>
                    <p style="color: var(--rpg-purple); font-size: 1.8rem; font-weight: bold; margin: 5px 0 0 0;">
                        <span id="step-progress-percentage">0</span>%
                    </p>
                </div>
            </div>

            <p id="loading-status-message" style="color: var(--rpg-gold); font-size: 1.2rem; margin-top: 20px; text-align: center;">Initializing...</p>
            <p id="loading-detail-message" style="color: #b8b8d1; font-size: 0.9rem; text-align: center;">This may take a few minutes.</p>

            <!-- Error/Warning Notification Area -->
            <div id="progress-errors" style="display: none; margin-top: 20px; padding: 15px; background: rgba(244, 67, 54, 0.1); border: 2px solid #F44336; border-radius: 8px;">
                <div style="display: flex; align-items: flex-start; gap: 10px;">
                    <i class="material-icons" style="color: #F44336; font-size: 2rem;">error_outline</i>
                    <div style="flex: 1;">
                        <h6 style="color: #F44336; margin: 0 0 10px 0;">
                            <strong>Workflow Issues Detected</strong>
                        </h6>
                        <ul id="progress-error-list" style="color: #b8b8d1; margin: 0; padding-left: 20px; font-size: 0.9rem;"></ul>
                        <p style="color: var(--rpg-silver); margin: 10px 0 0 0; font-size: 0.85rem;">
                            <i class="material-icons tiny" style="vertical-align: middle;">info</i>
                            The system is automatically retrying...
                        </p>
                    </div>
                </div>
            </div>

            <div id="progress-warnings" style="display: none; margin-top: 20px; padding: 15px; background: rgba(255, 152, 0, 0.1); border: 2px solid #FF9800; border-radius: 8px;">
                <div style="display: flex; align-items: flex-start; gap: 10px;">
                    <i class="material-icons" style="color: #FF9800; font-size: 2rem;">warning</i>
                    <div style="flex: 1;">
                        <h6 style="color: #FF9800; margin: 0 0 10px 0;">
                            <strong>Warnings</strong>
                        </h6>
                        <ul id="progress-warning-list" style="color: #b8b8d1; margin: 0; padding-left: 20px; font-size: 0.9rem;"></ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dialog Footer -->
        <div class="loading-dialog-footer">
            <i class="material-icons tiny" style="vertical-align: middle; margin-right: 5px;">info</i>
            <span>Campaign generation is in progress. You can safely navigate away and return later.</span>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
    /* Progress Indicator */
    #progress-container {
        padding: 20px 0;
        overflow-x: auto;
    }

    .progress-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        z-index: 1;
        min-width: 80px;
    }

    .step-circle {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background-color: rgba(192, 192, 192, 0.3);
        border: 3px solid var(--rpg-silver);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--rpg-silver);
        font-weight: bold;
        font-size: 1.2rem;
        transition: all 0.3s ease;
    }

    .progress-step.active .step-circle {
        background-color: var(--rpg-purple);
        border-color: var(--rpg-gold);
        color: white;
        box-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
    }

    .progress-step.completed .step-circle {
        background-color: var(--rpg-green);
        border-color: var(--rpg-green);
        color: white;
    }

    .step-label {
        margin-top: 10px;
        color: var(--rpg-silver);
        font-size: 0.75rem;
        text-align: center;
    }

    .progress-step.active .step-label {
        color: var(--rpg-gold);
        font-weight: bold;
    }

    .progress-line {
        flex: 1;
        height: 3px;
        background-color: rgba(192, 192, 192, 0.3);
        margin: 0 10px;
        margin-bottom: 40px;
        min-width: 20px;
    }

    /* Left Sidebar Navigation */
    .wizard-sidebar {
        margin-bottom: 20px;
    }

    #wizard-nav {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    /* Custom scrollbar for sidebar */
    #wizard-nav::-webkit-scrollbar {
        width: 6px;
    }

    #wizard-nav::-webkit-scrollbar-track {
        background: rgba(27, 27, 46, 0.4);
        border-radius: 3px;
    }

    #wizard-nav::-webkit-scrollbar-thumb {
        background: rgba(212, 175, 55, 0.3);
        border-radius: 3px;
    }

    #wizard-nav::-webkit-scrollbar-thumb:hover {
        background: rgba(212, 175, 55, 0.5);
    }

    .nav-step {
        display: flex;
        align-items: center;
        padding: 8px 8px;
        background: rgba(27, 27, 46, 0.4);
        border: 2px solid rgba(192, 192, 192, 0.2);
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .nav-step:hover {
        border-color: var(--rpg-purple);
        background: rgba(106, 90, 205, 0.1);
    }

    .nav-step.active {
        border-color: var(--rpg-gold);
        background: rgba(212, 175, 55, 0.1);
        box-shadow: 0 0 15px rgba(212, 175, 55, 0.2);
    }

    .nav-step.completed {
        border-color: var(--rpg-green);
        background: rgba(47, 158, 68, 0.1);
    }

    .nav-step-number {
        width: 26px;
        height: 26px;
        border-radius: 50%;
        background: rgba(192, 192, 192, 0.2);
        border: 2px solid var(--rpg-silver);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--rpg-silver);
        font-weight: bold;
        font-size: 0.75rem;
        flex-shrink: 0;
        margin-right: 8px;
        transition: all 0.3s ease;
    }

    .nav-step.active .nav-step-number {
        background: var(--rpg-purple);
        border-color: var(--rpg-gold);
        color: white;
    }

    .nav-step.completed .nav-step-number {
        background: var(--rpg-green);
        border-color: var(--rpg-green);
        color: white;
    }

    .nav-step.completed .nav-step-number::before {
        content: '\2713';
        font-weight: bold;
    }

    .nav-step.completed .nav-step-number {
        font-size: 0;
    }

    .nav-step.completed .nav-step-number::before {
        font-size: 1rem;
    }

    .nav-step-label {
        color: var(--rpg-silver);
        font-size: 0.8rem;
        line-height: 1.1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .nav-step.active .nav-step-label {
        color: var(--rpg-gold);
        font-weight: bold;
    }

    .nav-step.completed .nav-step-label {
        color: var(--rpg-green);
    }

    /* Mobile: Hide sidebar, show horizontal instead */
    @media (max-width: 768px) {
        .wizard-sidebar {
            display: none;
        }
    }

    /* Universe Cards */
    .universe-card {
        display: block;
        margin-bottom: 15px;
        cursor: pointer;
    }

    .universe-card input[type="radio"] {
        display: none;
    }

    .universe-content {
        padding: 20px;
        background: rgba(27, 27, 46, 0.6);
        border: 2px solid rgba(192, 192, 192, 0.3);
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .universe-card:hover .universe-content {
        border-color: var(--rpg-purple);
        background: rgba(106, 90, 205, 0.1);
    }

    .universe-card input[type="radio"]:checked + .universe-content {
        border-color: var(--rpg-gold);
        background: rgba(212, 175, 55, 0.1);
        box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
    }

    /* World Cards */
    .world-card {
        display: block;
        margin-bottom: 15px;
        cursor: pointer;
    }

    .world-card input[type="radio"] {
        display: none;
    }

    .world-content {
        padding: 15px;
        background: rgba(27, 27, 46, 0.6);
        border: 2px solid rgba(192, 192, 192, 0.3);
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .world-header {
        border-bottom: 2px solid rgba(212, 175, 55, 0.3);
        padding-bottom: 10px;
        margin-bottom: 10px;
    }

    .world-image-container {
        flex-shrink: 0;
        width: 150px;
        height: 150px;
        border-radius: 8px;
        overflow: hidden;
        background: rgba(27, 27, 46, 0.8);
        border: 2px solid rgba(212, 175, 55, 0.3);
    }

    .world-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .world-image-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, rgba(27, 27, 46, 0.9) 0%, rgba(106, 90, 205, 0.2) 100%);
    }

    .world-card:hover .world-content {
        border-color: var(--rpg-purple);
        background: rgba(106, 90, 205, 0.1);
    }

    .world-card input[type="radio"]:checked + .world-content {
        border-color: var(--rpg-gold);
        background: rgba(212, 175, 55, 0.1);
        box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
    }

    /* Region Cards */
    .region-card {
        display: block;
        margin-bottom: 15px;
        cursor: pointer;
    }

    .region-card input[type="radio"] {
        display: none;
    }

    .region-content {
        padding: 15px;
        background: rgba(27, 27, 46, 0.6);
        border: 2px solid rgba(192, 192, 192, 0.3);
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .region-card:hover .region-content {
        border-color: var(--rpg-purple);
        background: rgba(106, 90, 205, 0.1);
    }

    .region-card input[type="radio"]:checked + .region-content {
        border-color: var(--rpg-gold);
        background: rgba(212, 175, 55, 0.1);
        box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
    }

    /* Story Idea Cards */
    .story-idea-card {
        display: block;
        margin-bottom: 20px;
        cursor: pointer;
    }

    .story-idea-card input[type="radio"] {
        display: none;
    }

    .story-idea-content {
        padding: 20px;
        background: rgba(27, 27, 46, 0.6);
        border: 2px solid rgba(192, 192, 192, 0.3);
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .story-idea-card:hover .story-idea-content {
        border-color: var(--rpg-purple);
        background: rgba(106, 90, 205, 0.1);
    }

    .story-idea-card input[type="radio"]:checked + .story-idea-content {
        border-color: var(--rpg-gold);
        background: rgba(212, 175, 55, 0.1);
        box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
    }

    /* Quest/Place/Scene Review Cards */
    .quest-review-card, .place-review-card, .scene-review-card {
        padding: 20px;
        margin-bottom: 20px;
        background: rgba(27, 27, 46, 0.4);
        border: 2px solid rgba(192, 192, 192, 0.3);
        border-radius: 8px;
    }

    .quest-review-card h6, .place-review-card h6, .scene-review-card h6 {
        color: var(--rpg-gold);
        margin-top: 0;
    }

    .blooms-tag {
        display: inline-block;
        padding: 4px 12px;
        margin: 4px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: bold;
    }

    .blooms-1 { background-color: rgba(76, 175, 80, 0.3); color: #4CAF50; }
    .blooms-2 { background-color: rgba(33, 150, 243, 0.3); color: #2196F3; }
    .blooms-3 { background-color: rgba(255, 152, 0, 0.3); color: #FF9800; }
    .blooms-4 { background-color: rgba(156, 39, 176, 0.3); color: #9C27B0; }
    .blooms-5 { background-color: rgba(244, 67, 54, 0.3); color: #F44336; }
    .blooms-6 { background-color: rgba(233, 30, 99, 0.3); color: #E91E63; }

    .backstory-toggle {
        margin-top: 10px;
        font-size: 0.9rem;
        color: var(--rpg-purple);
        cursor: pointer;
        text-decoration: underline;
    }

    .backstory-toggle:hover {
        color: var(--rpg-gold);
    }

    .backstory-content {
        display: none;
        margin-top: 15px;
        padding: 15px;
        background: rgba(106, 90, 205, 0.1);
        border-left: 3px solid var(--rpg-purple);
        border-radius: 4px;
        font-size: 0.9rem;
        color: #b8b8d1;
    }

    /* Loading Dialog Box */
    .loading-dialog-box {
        background: rgba(27, 27, 46, 0.98);
        border: 3px solid var(--rpg-gold);
        border-radius: 12px;
        box-shadow: 0 0 40px rgba(212, 175, 55, 0.5);
        max-width: 700px;
        width: 90%;
        overflow: hidden;
    }

    .loading-dialog-header {
        background: linear-gradient(135deg, rgba(212, 175, 55, 0.3) 0%, rgba(106, 90, 205, 0.3) 100%);
        border-bottom: 2px solid var(--rpg-gold);
        padding: 20px 30px;
        display: flex;
        align-items: center;
        color: var(--rpg-gold);
        font-size: 1.3rem;
        font-weight: bold;
    }

    .loading-dialog-content {
        padding: 30px;
    }

    .loading-dialog-footer {
        background: rgba(106, 90, 205, 0.2);
        border-top: 2px solid var(--rpg-purple);
        padding: 15px 30px;
        text-align: center;
        color: var(--rpg-silver);
        font-size: 0.9rem;
    }

    /* Animated Progress Bar */
    .progress-bar-container {
        width: 100%;
        height: 30px;
        background: rgba(27, 27, 46, 0.8);
        border: 2px solid var(--rpg-purple);
        border-radius: 15px;
        overflow: hidden;
        position: relative;
        margin: 20px 0;
    }

    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--rpg-purple) 0%, var(--rpg-gold) 50%, var(--rpg-purple) 100%);
        background-size: 200% 100%;
        animation: progressBarGlow 2s linear infinite;
        transition: width 0.3s ease;
        width: 0%;
        position: relative;
        z-index: 1;
    }

    .progress-bar-shine {
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        animation: progressBarShine 1.5s ease-in-out infinite;
        z-index: 2;
    }

    @keyframes progressBarGlow {
        0% { background-position: 200% 0; }
        100% { background-position: 0% 0; }
    }

    @keyframes progressBarShine {
        0% { left: -100%; }
        100% { left: 200%; }
    }

    /* Loading Overlay Phases */
    .phase-step {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 10px 20px;
        background: rgba(27, 27, 46, 0.6);
        border-radius: 8px;
        border: 2px solid rgba(192, 192, 192, 0.2);
        transition: all 0.3s ease;
    }

    .phase-step.active {
        border-color: var(--rpg-gold);
        background: rgba(212, 175, 55, 0.1);
    }

    .phase-step.completed {
        border-color: var(--rpg-green);
        background: rgba(47, 158, 68, 0.1);
    }

    .phase-icon {
        font-size: 2rem;
        color: var(--rpg-silver);
    }

    .phase-step.active .phase-icon {
        color: var(--rpg-gold);
        animation: pulse 1.5s infinite;
    }

    .phase-step.completed .phase-icon {
        color: var(--rpg-green);
        visibility: hidden;
        position: relative;
    }

    .phase-step.completed .phase-icon::before {
        content: 'check_circle';
        visibility: visible;
        position: absolute;
        left: 0;
        top: 0;
        font-size: 2rem;
    }

    .phase-label {
        font-size: 1.1rem;
        color: var(--rpg-silver);
    }

    .phase-step.active .phase-label {
        color: var(--rpg-gold);
        font-weight: bold;
    }

    .phase-step.completed .phase-label {
        color: var(--rpg-green);
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    /* Review Sections */
    .review-section {
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(192, 192, 192, 0.2);
    }

    .review-section:last-child {
        border-bottom: none;
    }

    .review-section strong {
        display: block;
        margin-bottom: 8px;
    }

    .review-section p {
        margin: 0;
    }

    .knowledge-item, .item-item {
        display: inline-block;
        padding: 6px 12px;
        margin: 4px;
        background: rgba(106, 90, 205, 0.2);
        border-radius: 4px;
        font-size: 0.85rem;
        color: #b8b8d1;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/campaign_wizard_v2.js' %}?v=4"></script>
{% endblock %}
